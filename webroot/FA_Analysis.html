<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è²¡æœƒè¨ºæ–·å¹³å° - Dr. Wang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel parsing -->
    <!-- SheetJS removed -->
    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- PDF.js for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        /* PDF Specific Styles */
        .pdf-avoid-break {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        :root {
            --michigan-blue: #00274C;
            --michigan-maize: #FFCB05;
            --michigan-blue-light: #4A90A4;
            --michigan-blue-dark: #001B2E;
            --michigan-maize-light: #FFF2A6;
            --michigan-blue-lightest: #E8F0F7;
            --michigan-maize-lightest: #FFF9E6;
        }

        .text-michigan-blue {
            color: var(--michigan-blue);
        }

        .bg-michigan-blue {
            background-color: var(--michigan-blue);
        }

        .border-michigan-maize {
            border-color: var(--michigan-maize);
        }

        .text-michigan-maize {
            color: var(--michigan-maize);
        }

        .bg-michigan-maize {
            background-color: var(--michigan-maize);
        }

        .bg-michigan-blue-lightest {
            background-color: var(--michigan-blue-lightest);
        }

        .bg-michigan-maize-lightest {
            background-color: var(--michigan-maize-lightest);
        }

        .header-gradient {
            background: linear-gradient(135deg, var(--michigan-blue) 0%, var(--michigan-blue-light) 100%);
        }

        .michigan-button {
            background: linear-gradient(135deg, var(--michigan-blue), var(--michigan-blue-light));
            color: var(--michigan-maize);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-weight: 600;
        }

        .michigan-button:hover {
            background: var(--michigan-blue-dark);
            border-color: var(--michigan-maize);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 39, 76, 0.4);
        }

        .michigan-button-secondary {
            background: var(--michigan-maize);
            color: var(--michigan-blue);
            border: 2px solid var(--michigan-blue);
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .michigan-button-secondary:hover {
            background: var(--michigan-maize-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 203, 5, 0.4);
        }

        .focus-michigan:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 203, 5, 0.3);
            border-color: var(--michigan-maize);
        }

        .card-shadow {
            box-shadow: 0 4px 16px rgba(0, 39, 76, 0.1);
        }

        .progress-bar-container {
            background-color: #e0e0e0;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-bar {
            background-color: var(--michigan-maize);
            height: 100%;
            transition: width 0.5s ease-in-out;
        }

        .model-checkbox:checked+label {
            border-color: var(--michigan-blue);
            background-color: var(--michigan-blue-lightest);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 39, 76, 0.1);
        }

        .feedback-button {
            background-color: #e2e8f0;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .feedback-button:hover {
            background-color: #cbd5e1;
            transform: scale(1.1);
        }

        .feedback-button.selected {
            background-color: var(--michigan-maize);
        }

        .innovation-tab {
            cursor: pointer;
            padding: 10px 20px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #4a5568;
        }

        .innovation-tab:hover {
            color: var(--michigan-blue);
            background-color: var(--michigan-blue-lightest);
        }

        .innovation-tab.active {
            color: var(--michigan-blue);
            border-bottom-color: var(--michigan-maize);
            font-weight: 700;
        }

        .innovation-content {
            display: none;
        }

        .innovation-content.active {
            display: block;
        }

        .file-drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: var(--michigan-blue);
            background-color: var(--michigan-blue-lightest);
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }

            #stage-5,
            #stage-5 * {
                visibility: visible;
            }

            #stage-5 {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
            }

            /* Hide buttons in report */
            button,
            .no-print {
                display: none !important;
            }

            /* Ensure background colors print */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <header class="header-gradient shadow-lg border-b-4 border-michigan-maize sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <!-- Placeholder image -->
                    <img src="Cliff Baby Pic by GPT.jpg" alt="Dr. Wang Avatar"
                        class="h-16 w-16 rounded-full border-2 border-michigan-maize bg-white object-cover">
                    <div class="ml-4">
                        <h1 class="text-xl font-bold text-michigan-maize">AI è²¡æœƒè¨ºæ–·å¹³å°</h1>
                        <p class="text-sm text-white">Dr. Wang Ã— è²¡æœƒæˆ°ç•¥ Ã— æ•¸æ“šé©…å‹•</p>
                    </div>
                </div>
            </div>
            <!-- é€²åº¦æ¢ -->
            <div class="mt-4">
                <div id="progress-container" class="progress-bar-container h-2.5 w-full">
                    <div id="progress-bar" class="progress-bar" style="width: 10%;"></div>
                </div>
                <div id="progress-label" class="text-center text-xs text-white mt-1">éšæ®µ 1 / 5: è²¡æœƒæ•¸æ“šè¼¸å…¥</div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-8">
        <div class="space-y-8">
            <!-- éšæ®µ 1: è²¡æœƒæ•¸æ“šèˆ‡èƒŒæ™¯ (Refined UI) -->
            <div id="stage-1" class="bg-white rounded-xl shadow-lg card-shadow p-5 md:p-8 border border-gray-200">
                <div class="border-b border-gray-100 pb-6 mb-8">
                    <h2 class="text-2xl font-bold text-michigan-blue mb-2">éšæ®µ 1: è²¡æœƒæ•¸æ“šèˆ‡èƒŒæ™¯</h2>
                    <p class="text-gray-500">è«‹ä¾åºå®Œæˆä»¥ä¸‹æ­¥é©Ÿï¼ŒAI å°‡å”åŠ©æ‚¨é€²è¡Œå°ˆæ¥­è²¡æœƒè¨ºæ–·ã€‚</p>
                </div>

                <!-- Step 1.1: AI Engine Setup -->
                <div class="mb-8">
                    <h3 class="text-lg font-bold text-michigan-blue mb-4 flex items-center">
                        <span
                            class="bg-michigan-blue text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 text-xs">1</span>
                        è¨­å®š AI å¼•æ“
                    </h3>

                    <div class="flex flex-col md:grid md:grid-cols-12 gap-6 items-start">
                        <div class="md:col-span-4">
                            <label for="aiProvider" class="block text-sm font-semibold text-gray-700 mb-2">AI
                                æœå‹™æä¾›å•†</label>
                            <div class="relative">
                                <select id="aiProvider"
                                    class="w-full pl-4 pr-10 py-2.5 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none transition-shadow">
                                    <option value="gemini">Gemini (æ¨è–¦: æ”¯æ´ PDF)</option>
                                    <option value="openai">OpenAI GPT</option>
                                    <option value="deepseek">DeepSeek</option>
                                </select>
                                <div
                                    class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 20 20">
                                        <path
                                            d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                    </svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                è¨»å†Šé€£çµï¼š
                                <a href="https://aistudio.google.com/" target="_blank"
                                    class="text-blue-600 hover:underline">Gemini</a> |
                                <a href="https://platform.openai.com/signup" target="_blank"
                                    class="text-green-600 hover:underline">GPT</a> |
                                <a href="https://platform.deepseek.com/" target="_blank"
                                    class="text-purple-600 hover:underline">DeepSeek</a>
                            </p>
                        </div>
                        <div class="md:col-span-8">
                            <label for="apiKey" class="block text-sm font-semibold text-gray-700 mb-2">AI API
                                Key</label>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <input type="password" id="apiKey" placeholder="sk-..."
                                    class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow">
                                <button onclick="saveSettings()"
                                    class="w-full sm:w-auto px-5 py-2.5 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 hover:text-michigan-blue transition-colors shadow-sm">
                                    å„²å­˜è¨­å®š
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-2 flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                                    </path>
                                </svg>
                                Key åƒ…å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ç«¯ï¼Œä¿éšœéš±ç§å®‰å…¨ã€‚
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Step 1.2: Company Info -->
                <div class="mb-8">
                    <h3
                        class="text-lg font-bold text-michigan-blue mb-4 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                        <div class="flex items-center">
                            <span
                                class="bg-michigan-blue text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 text-xs">2</span>
                            ä¼æ¥­èƒŒæ™¯è³‡æ–™
                        </div>
                        <button onclick="loadExampleFinancialData()"
                            class="w-full sm:w-auto text-xs font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-2 rounded-full transition-colors flex items-center justify-center">
                            <span class="mr-1">âš¡</span> è¼‰å…¥ç¯„ä¾‹è³‡æ–™
                        </button>
                    </h3>

                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Target Company -->
                        <div
                            class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                            <h4
                                class="text-sm font-bold text-gray-800 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2">
                                ç›®æ¨™ä¼æ¥­</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">æ‰€å±¬ç”¢æ¥­</label>
                                    <input id="industry" type="text" placeholder="ä¾‹å¦‚: é›»å­é›¶çµ„ä»¶è£½é€ "
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-michigan-blue focus:border-michigan-blue text-sm">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">è‚¡ç¥¨ä»£è™Ÿ (é¸å¡«)</label>
                                        <input id="ticker" type="text" placeholder="ä¾‹å¦‚: 2383.TW"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-michigan-blue focus:border-michigan-blue text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">ä¼æ¥­è¦æ¨¡</label>
                                        <select id="companySize"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-michigan-blue focus:border-michigan-blue text-sm bg-white">
                                            <option value="ä¸­å°å‹ä¼æ¥­ (51-500äºº)">ä¸­å°å‹ (51-500äºº)</option>
                                            <option value="ä¸Šå¸‚/è·¨åœ‹å…¬å¸ (2000äººä»¥ä¸Š)">å¤§å‹/è·¨åœ‹ (>2000äºº)</option>
                                            <option value="æ–°å‰µå…¬å¸ (1-50äºº)">æ–°å‰µ (1-50äºº)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Competitor / Context -->
                        <div
                            class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                            <h4
                                class="text-sm font-bold text-gray-800 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2">
                                è¨ºæ–·èƒŒæ™¯èˆ‡ç«¶å°</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">ç«¶çˆ­å°æ‰‹è³‡è¨Š (é¸å¡«)</label>
                                    <input id="competitorUrl" type="text" placeholder="ç«¶çˆ­å°æ‰‹è²¡å ±é€£çµæˆ–å®˜ç¶² URL"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-michigan-blue focus:border-michigan-blue text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">ç•¶å‰è²¡æœƒæŒ‘æˆ°</label>
                                    <textarea id="problemDescription" rows="3" placeholder="ä¾‹å¦‚: æ¯›åˆ©ç‡ä¸‹æ»‘ã€åº«å­˜é€±è½‰ç‡ä½ã€ç¾é‡‘æµåƒç·Š..."
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-michigan-blue focus:border-michigan-blue text-sm resize-none"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 1.3: File Upload -->
                <div class="mb-8">
                    <h3 class="text-lg font-bold text-michigan-blue mb-4 flex items-center">
                        <span
                            class="bg-michigan-blue text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 text-xs">3</span>
                        ä¸Šå‚³è²¡æœƒå ±è¡¨ (PDF)
                    </h3>

                    <!-- Quick Load Buttons (Subtle) -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="text-xs font-medium text-gray-500 py-1.5">å¿«é€Ÿæ¸¬è©¦ï¼š</span>
                        <button onclick="loadExamplePDF('target')"
                            class="px-3 py-1.5 text-xs font-medium bg-blue-50 text-blue-700 rounded hover:bg-blue-100 transition-colors border border-blue-200">
                            ğŸ“‚ è¼‰å…¥ç›®æ¨™ (2383.pdf)
                        </button>
                        <button onclick="loadExamplePDF('competitor')"
                            class="px-3 py-1.5 text-xs font-medium bg-red-50 text-red-700 rounded hover:bg-red-100 transition-colors border border-red-200">
                            âš”ï¸ è¼‰å…¥ç«¶å° (6274.pdf)
                        </button>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Target Upload -->
                        <div class="group relative border-2 border-dashed border-blue-200 rounded-xl p-6 text-center hover:border-blue-400 hover:bg-blue-50 transition-all cursor-pointer"
                            id="dropZoneTarget" onclick="document.getElementById('fileInputTarget').click()">
                            <div class="mb-3 text-blue-500 group-hover:scale-110 transition-transform duration-300">
                                <svg class="w-10 h-10 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                            </div>
                            <h4 class="font-bold text-gray-700 mb-1">ç›®æ¨™å…¬å¸è²¡å ±</h4>
                            <p class="text-xs text-gray-500 mb-4">é»æ“Šæˆ–æ‹–æ”¾ PDF æª”æ¡ˆ</p>
                            <input type="file" id="fileInputTarget" class="hidden" accept=".pdf"
                                onchange="handleFiles(this.files, 'target'); event.stopPropagation();">
                            <div id="fileListTarget" class="text-left space-y-2"></div>
                        </div>

                        <!-- Competitor Upload -->
                        <div class="group relative border-2 border-dashed border-gray-200 rounded-xl p-6 text-center hover:border-gray-400 hover:bg-gray-50 transition-all cursor-pointer"
                            id="dropZoneCompetitor" onclick="document.getElementById('fileInputCompetitor').click()">
                            <div class="mb-3 text-gray-400 group-hover:scale-110 transition-transform duration-300">
                                <svg class="w-10 h-10 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </div>
                            <h4 class="font-bold text-gray-700 mb-1">ç«¶çˆ­å°æ‰‹è²¡å ± (é¸å¡«)</h4>
                            <p class="text-xs text-gray-500 mb-4">é»æ“Šæˆ–æ‹–æ”¾ PDF æª”æ¡ˆ</p>
                            <input type="file" id="fileInputCompetitor" class="hidden" accept=".pdf"
                                onchange="handleFiles(this.files, 'competitor'); event.stopPropagation();">
                            <div id="fileListCompetitor" class="text-left space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 1.4: Action -->
                <div class="mb-8 text-center">
                    <button onclick="extractAllMetrics()"
                        class="group relative inline-flex items-center justify-center px-8 py-4 font-bold text-white transition-all duration-200 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-600 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        <span class="relative flex items-center gap-2 text-lg">
                            <svg class="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            é–‹å§‹ AI æ™ºæ…§åˆ†æ
                        </span>
                    </button>
                </div>

                <!-- Step 1.5: Verification (Hidden) -->
                <div id="verification-section" class="hidden mb-8 animate-fade-in">
                    <div class="border-t border-gray-100 pt-8">
                        <h3 class="text-lg font-bold text-michigan-blue mb-4 flex items-center">
                            <span
                                class="bg-michigan-blue text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 text-xs">4</span>
                            æ•¸æ“šé©—è­‰èˆ‡ç¢ºèª
                        </h3>

                        <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                            <div id="comparison-metrics-container" class="overflow-x-auto">
                                <table class="min-w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-50 border-b border-gray-200">
                                            <th class="px-4 py-3 text-left font-bold text-gray-700">é …ç›®</th>
                                            <th class="px-4 py-3 text-center font-bold text-blue-700 bg-blue-50 border-l border-blue-100"
                                                colspan="2">ğŸ† ç›®æ¨™å…¬å¸</th>
                                            <th class="px-4 py-3 text-center font-bold text-red-700 bg-red-50 border-l border-red-100"
                                                colspan="2">âš”ï¸ ç«¶çˆ­å°æ‰‹</th>
                                        </tr>
                                        <tr class="bg-white border-b border-gray-200 text-xs text-gray-500">
                                            <th class="px-4 py-2 text-left font-medium">å¹´åº¦/æœŸé–“</th>
                                            <th class="px-2 py-2 text-right font-mono" id="target-year-1">-</th>
                                            <th class="px-2 py-2 text-right font-mono" id="target-year-2">-</th>
                                            <th class="px-2 py-2 text-right font-mono border-l border-gray-100"
                                                id="comp-year-1">-</th>
                                            <th class="px-2 py-2 text-right font-mono" id="comp-year-2">-</th>
                                        </tr>
                                    </thead>
                                    <tbody id="comparison-metrics-body" class="divide-y divide-gray-100">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                            <textarea id="company-data-editor" class="hidden"></textarea>
                            <textarea id="competitor-data-editor" class="hidden"></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end pt-6 border-t border-gray-100">
                    <button onclick="goToStage(2)"
                        class="michigan-button px-8 py-3 rounded-lg text-base shadow-md hover:shadow-lg flex items-center gap-2">
                        ä¸‹ä¸€æ­¥ï¼šé¸æ“‡è²¡æœƒæ¨¡å‹ â¡ï¸
                    </button>
                </div>
            </div>

            <!-- éšæ®µ 2: é¸æ“‡è²¡æœƒæ¨¡å‹ -->
            <div id="stage-2" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-4">éšæ®µ 2: é¸æ“‡è²¡æœƒè¨ºæ–·æ¨¡å‹</h2>
                <p class="text-gray-600 mb-6">è«‹é¸æ“‡æ‚¨å¸Œæœ› AI é‹ç”¨çš„åˆ†ææ¨¡å‹ã€‚</p>
                <div id="model-selection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <!-- Models injected by JS -->
                </div>



                <div class="text-center mt-6 flex flex-col md:flex-row justify-center items-center gap-4">
                    <button onclick="goToStage(1)"
                        class="michigan-button-secondary px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">â¬…ï¸
                        è¿”å›æ•¸æ“šè¼¸å…¥</button>
                    <button id="stage2-action-btn" onclick="runAnalysis()"
                        class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">ğŸ”¬
                        é–‹å§‹è²¡æœƒåˆ†æ</button>
                </div>
            </div>

            <!-- éšæ®µ 3: åˆ†æå„€è¡¨æ¿ -->
            <div id="stage-3" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-6">éšæ®µ 3: è²¡æœƒåˆ†æå„€è¡¨æ¿</h2>
                <div id="analysis-dashboard" class="space-y-6"></div>
                <div
                    class="text-center mt-8 pt-6 border-t border-gray-200 flex flex-col md:flex-row justify-center items-center gap-4">
                    <button onclick="goToStage(2)"
                        class="michigan-button-secondary px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">â¬…ï¸
                        è¿”å›æ¨¡å‹é¸æ“‡</button>
                    <button onclick="goToStage(4)"
                        class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">ğŸ’¡
                        é€²å…¥è²¡æœƒç­–ç•¥è¦åŠƒ</button>
                </div>
            </div>

            <!-- éšæ®µ 4: è²¡æœƒç­–ç•¥ (å‰µæ–°) -->
            <div id="stage-4" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-2">éšæ®µ 4: è²¡æœƒç­–ç•¥è¦åŠƒå·¥å…·ç®±</h2>
                <p class="text-gray-600 mb-6">åŸºæ–¼è²¡æœƒè¨ºæ–·ï¼ŒAI å°‡æä¾›å…·é«”çš„è²¡æœƒå„ªåŒ–èˆ‡æˆ°ç•¥å»ºè­°ã€‚</p>

                <div class="flex flex-col md:flex-row items-start md:items-center gap-3 mb-4">
                    <button id="autoRunAllBtn" onclick="autoRunAll()"
                        class="michigan-button px-4 py-2 rounded-lg shadow">
                        ğŸš€ è‡ªå‹•åŸ·è¡Œæ‰€æœ‰ç­–ç•¥åˆ†æ
                    </button>
                    <span id="autoRunStatus" class="text-xs text-gray-600"></span>
                </div>

                <div class="border-b border-gray-200 mb-6">
                    <nav id="innovation-tabs" class="flex flex-wrap -mb-px" aria-label="Tabs">
                        <button onclick="showInnovationTab('capital_structure')" class="innovation-tab active"
                            data-tab="capital_structure">è³‡æœ¬çµæ§‹å„ªåŒ–</button>
                        <button onclick="showInnovationTab('cost_optimization')" class="innovation-tab"
                            data-tab="cost_optimization">æˆæœ¬å„ªåŒ– (ZBB)</button>
                        <button onclick="showInnovationTab('risk_management')" class="innovation-tab"
                            data-tab="risk_management">é¢¨éšªç®¡ç†</button>
                        <button onclick="showInnovationTab('tax_planning')" class="innovation-tab"
                            data-tab="tax_planning">ç¨…å‹™è¦åŠƒ</button>
                        <button onclick="showInnovationTab('ma_strategy')" class="innovation-tab"
                            data-tab="ma_strategy">ä½µè³¼èˆ‡æ’¤è³‡</button>
                    </nav>
                </div>

                <div id="innovation-content-container">
                    <div id="innovation-content-capital_structure" class="innovation-content active">
                        <div id="capital-structure-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-cost_optimization" class="innovation-content hidden">
                        <div id="cost-optimization-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-risk_management" class="innovation-content hidden">
                        <div id="risk-management-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-tax_planning" class="innovation-content hidden">
                        <div id="tax-planning-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-ma_strategy" class="innovation-content hidden">
                        <div id="ma-strategy-result" class="space-y-6"></div>
                    </div>
                </div>

                <div
                    class="text-center mt-8 pt-6 border-t border-gray-200 flex flex-col md:flex-row justify-center items-center gap-4">
                    <button onclick="goToStage(3)"
                        class="michigan-button-secondary px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">â¬…ï¸
                        è¿”å›å„€è¡¨æ¿</button>
                    <button onclick="goToStage(5)"
                        class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">ğŸ“„
                        ç”¢ç”Ÿè²¡æœƒå ±å‘Š</button>
                </div>
            </div>

            <!-- éšæ®µ 5: æœ€çµ‚å ±å‘Š -->
            <div id="stage-5" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-6">éšæ®µ 5: è²¡æœƒæˆ°ç•¥è¨ºæ–·å ±å‘Š</h2>
                <div id="report-content" class="mb-8"></div>
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <div class="flex flex-wrap justify-center items-center gap-4 no-print">
                        <button onclick="goToStage(4)"
                            class="michigan-button-secondary px-8 py-4 rounded-lg text-lg shadow-lg">â¬…ï¸ è¿”å›ç­–ç•¥è¦åŠƒ</button>
                        <button onclick="window.print()"
                            class="michigan-button px-8 py-4 rounded-lg text-lg shadow-lg">ğŸ–¨ï¸
                            åˆ—å° / å¦å­˜ PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading -->
    <div id="loadingIndicator"
        class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 text-center shadow-2xl max-w-sm mx-auto">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-michigan-blue mx-auto mb-6"></div>
            <p class="text-xl font-semibold text-michigan-blue mb-2"> AI æ­£åœ¨åˆ†æè²¡æœƒæ•¸æ“š...</p>
            <p id="loadingMessage" class="text-sm text-gray-600">è®€å–å ±è¡¨èˆ‡è¨ˆç®—æŒ‡æ¨™ä¸­</p>
        </div>
    </div>

    <script>
        // --- Global & Settings ---
        let diagnosisData = {
            stage: 1,
            context: {
                financialData: [],
                competitorFiles: [],
                financialImages: [],
                competitorData: ""
            }
        };
        const SETTINGS_KEY = 'cfo_ai_settings_v1';

        function getSettings() {
            try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || { provider: 'gemini', apiKey: '', fmpApiKey: '' }; }
            catch (e) { return { provider: 'gemini', apiKey: '', fmpApiKey: '' }; }
        }
        function setSettings(s) { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
        let runtimeSettings = getSettings();

        const CFO_PERSONA = `æ‚¨æ˜¯ä¸€ä½æ“æœ‰30å¹´ç¶“é©—çš„é›†åœ˜è²¡å‹™é•·(CFO)èˆ‡æœƒè¨ˆé•·(CAO)ï¼Œç²¾é€šIFRS/GAAPæœƒè¨ˆæº–å‰‡ã€è²¡æœƒå ±è¡¨åˆ†æã€è³‡é‡‘ç®¡ç†èˆ‡ç¨…å‹™è¦åŠƒã€‚æ‚¨çš„åˆ†æé¢¨æ ¼åš´è¬¹ã€æ•¸æ“šé©…å‹•ï¼Œä¸¦èƒ½å¾è²¡æœƒæ•¸æ“šä¸­æ´å¯Ÿç‡Ÿé‹é¢¨éšªèˆ‡æˆ°ç•¥æ©Ÿæœƒã€‚

**é‡è¦**: æ‰€æœ‰è²¡æœƒåˆ†æå„˜é‡åŸºæ–¼ã€Œåˆä½µè²¡å‹™å ±è¡¨ã€(Consolidated Financial Statements)ã€‚åˆä½µå ±è¡¨åŒ…å«æ¯å…¬å¸åŠå…¶å­å…¬å¸çš„è²¡æœƒæ•¸æ“šï¼Œèƒ½æ›´å…¨é¢åæ˜ é›†åœ˜æ•´é«”è²¡æœƒç‹€æ³ã€‚

è«‹åœ¨åˆ†ææ™‚è€ƒæ…®ç”¢æ¥­ç‰¹æ€§ï¼Œä¸¦ä»¥å°ˆæ¥­ã€å®¢è§€çš„å£å»ï¼Œæä¾›å…·é«”çš„è²¡æœƒå»ºè­°ã€‚è«‹åªä»¥ç¹é«”ä¸­æ–‡å›æ‡‰ã€‚`;

        const availableModels = [
            { id: 'dupont', name: 'æœé‚¦åˆ†æ (DuPont)', description: 'æ‹†è§£ ROE ç‚ºæ·¨åˆ©ç‡ã€è³‡ç”¢é€±è½‰ç‡èˆ‡æ¬Šç›Šä¹˜æ•¸ï¼Œè¨ºæ–·ç²åˆ©é©…å‹•å› å­ã€‚' },
            { id: 'cashflow', name: 'ç¾é‡‘æµé‡åˆ†æ', description: 'åˆ†æç‡Ÿé‹ã€æŠ•è³‡ã€ç±Œè³‡ç¾é‡‘æµï¼Œè©•ä¼° EBITDAã€è‡ªç”±ç¾é‡‘æµé‡ (FCF) èˆ‡ç¾é‡‘è½‰æ›å¾ªç’° (CCC)ã€‚' },
            { id: 'profitability', name: 'ç²åˆ©èƒ½åŠ›åˆ†æ', description: 'è©•ä¼°æ¯›åˆ©ç‡ã€ç‡Ÿæ¥­åˆ©ç›Šç‡ã€æ·¨åˆ©ç‡ç­‰é—œéµç²åˆ©æŒ‡æ¨™ï¼Œä¸¦æ¯”è¼ƒæ­·å²èˆ‡åŒæ¥­æ°´æº–ã€‚' },
            { id: 'solvency', name: 'å„Ÿå‚µèƒ½åŠ›åˆ†æ', description: 'åˆ†ææµå‹•æ¯”ç‡ã€é€Ÿå‹•æ¯”ç‡ã€è² å‚µæ¬Šç›Šæ¯”ç­‰ï¼Œè©•ä¼°çŸ­æœŸèˆ‡é•·æœŸå„Ÿå‚µèƒ½åŠ›ã€‚' },
            { id: 'cost_structure', name: 'æˆæœ¬çµæ§‹åˆ†æ', description: 'è§£æå›ºå®š/è®Šå‹•æˆæœ¬ã€ç›ˆè™§å¹³è¡¡é» (BEP)ï¼Œæ‰¾å‡ºæˆæœ¬å„ªåŒ–æ©Ÿæœƒã€‚' },
            { id: 'benchmarking', name: 'æ¨™ç«¿åˆ†æ', description: 'èˆ‡åŒæ¥­æˆ–ç«¶çˆ­å°æ‰‹é€²è¡Œå¤šç¶­åº¦æ¯”è¼ƒï¼Œæ‰¾å‡ºè²¡æœƒè¡¨ç¾å·®è·èˆ‡æ”¹å–„æ–¹å‘ã€‚' }
        ];

        // --- File Handling ---
        function handleFiles(files, type = 'target') {
            const listId = type === 'target' ? 'fileListTarget' : 'fileListCompetitor';
            const fileList = document.getElementById(listId);

            // Clear existing data and UI for single file upload
            if (type === 'target') {
                diagnosisData.context.financialData = [];
                diagnosisData.financials = null; // Clear extracted financial metrics
                fileList.innerHTML = ''; // Clear UI list
            } else {
                diagnosisData.context.competitorFiles = [];
                diagnosisData.competitorFinancials = null; // Clear extracted competitor metrics
                fileList.innerHTML = ''; // Clear UI list
            }

            // Process only the first file (Single File Upload)
            if (files.length > 0) {
                const file = files[0];
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-200 text-xs';

                item.innerHTML = `
            <div class="flex items-center gap-2 overflow-hidden">
                <span class="text-lg">${getFileIcon(file.name)}</span>
                <span class="truncate font-medium text-gray-700">${file.name}</span>
                <span class="text-gray-400 text-[10px]">(${formatSize(file.size)})</span>
            </div>
            <button onclick="removeFile('${file.name}', '${type}', this)" class="text-gray-400 hover:text-red-500">âœ•</button>
        `;
                fileList.appendChild(item);

                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    readPdf(file, type);
                } else {
                    alert('åƒ…æ”¯æ´ PDF æª”æ¡ˆ');
                }
            }
        }

        function removeFile(fileName, type, btnElement) {
            // 1. Remove from UI
            if (btnElement) {
                btnElement.parentElement.remove();
            }

            // 2. Remove from Data Context
            const dataArray = type === 'target' ? diagnosisData.context.financialData : diagnosisData.context.competitorFiles;
            const index = dataArray.findIndex(f => f.name === fileName);

            if (index !== -1) {
                dataArray.splice(index, 1);
                console.log(`Removed ${fileName} from ${type} data. Remaining: ${dataArray.length}`);
            } else {
                console.warn(`File ${fileName} not found in ${type} data to remove.`);
            }
        }

        // readExcel and readImage removed

        async function readPdf(file, type) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const typedarray = new Uint8Array(e.target.result);
                try {
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let fullText = "";

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();

                        // Improved extraction: preserve lines and spacing
                        let lastY, text = '';
                        for (let item of textContent.items) {
                            if (lastY == item.transform[5] || !lastY) {
                                text += item.str + "  "; // Add double space for column separation
                            }
                            else {
                                text += '\n' + item.str + "  ";
                            }
                            lastY = item.transform[5];
                        }
                        fullText += `--- Page ${i} ---\n${text}\n\n`;
                    }

                    if (fullText.trim().length === 0) {
                        alert(`âš ï¸ PDF (${file.name}) ä¼¼ä¹æ˜¯æƒææª”æˆ–ç„¡æ–‡å­—å±¤ã€‚AI å¯èƒ½ç„¡æ³•è®€å–å…§å®¹ã€‚å»ºè­°ä½¿ç”¨åœ–ç‰‡ä¸Šå‚³æˆ– OCR è½‰æª”ã€‚`);
                    }

                    const dataObj = { name: file.name, content: fullText };
                    if (type === 'target') {
                        diagnosisData.context.financialData.push(dataObj);
                    } else {
                        diagnosisData.context.competitorFiles.push(dataObj);
                    }
                    console.log(`Parsed PDF: ${file.name}, Pages: ${pdf.numPages}`);

                } catch (error) {
                    console.error("PDF Parse Error:", error);
                    alert(`è®€å– PDF å¤±æ•—: ${error.message}`);
                }
            };
            reader.readAsArrayBuffer(file);
        }


        // --- Navigation & UI ---
        function updateProgress(stage) {
            diagnosisData.stage = stage;
            const labels = ["æ•¸æ“šè¼¸å…¥", "é¸æ“‡æ¨¡å‹", "åˆ†æå„€è¡¨æ¿", "ç­–ç•¥è¦åŠƒ", "è²¡æœƒå ±å‘Š"];
            document.getElementById('progress-bar').style.width = `${(stage / 5) * 100}%`;
            document.getElementById('progress-label').textContent = `éšæ®µ ${stage} / 5: ${labels[stage - 1]}`;
        }

        async function goToStage(stageNumber) {
            if (stageNumber === 2) {
                const industry = document.getElementById('industry').value;
                const problem = document.getElementById('problemDescription').value;
                if (!industry && !problem && diagnosisData.context.financialData.length === 0) {
                    alert('è«‹è‡³å°‘è¼¸å…¥ç”¢æ¥­ã€å•é¡Œæè¿°æˆ–ä¸Šå‚³è²¡æœƒæª”æ¡ˆã€‚');
                    return;
                }
                diagnosisData.context.industry = industry;
                diagnosisData.context.ticker = document.getElementById('ticker').value;
                diagnosisData.context.companySize = document.getElementById('companySize').value;
                diagnosisData.context.problem = problem;
                diagnosisData.context.competitorUrl = document.getElementById('competitorUrl').value;

                // Reset if context changed significantly? (Skipping complex check for now)
            }

            for (let i = 1; i <= 5; i++) document.getElementById(`stage-${i}`).classList.add('hidden');

            // Only show API settings on Stage 1 - REMOVED as API settings are now part of Stage 1 content
            // if (stageNumber === 1) {
            //     document.getElementById('api-settings').classList.remove('hidden');
            // } else {
            //     document.getElementById('api-settings').classList.add('hidden');
            // }

            document.getElementById(`stage-${stageNumber}`).classList.remove('hidden');
            updateProgress(stageNumber);
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (stageNumber === 2) {
                const btn = document.getElementById('stage2-action-btn');
                btn.textContent = Object.keys(diagnosisData.analysisResults || {}).length > 0 ? 'â¡ï¸ æŸ¥çœ‹åˆ†æçµæœ' : 'ğŸ”¬ é–‹å§‹è²¡æœƒåˆ†æ';
                btn.onclick = Object.keys(diagnosisData.analysisResults || {}).length > 0 ? () => goToStage(3) : runAnalysis;

                // Populate data verification editors
                populateDataEditors();
            }


            if (stageNumber === 3) {
                // CRITICAL: Check for Analysis Mode Consistency
                // We only clear results if the "Mode" has changed (e.g. User had Single results, but now added a Competitor file)

                const currentMode = (diagnosisData.context.competitorFiles && diagnosisData.context.competitorFiles.length > 0) ? 'competitor' : 'single';
                const previousMode = diagnosisData.analysisMode;

                console.log(`[DEBUG] Entering Stage 3. Current Mode: ${currentMode}, Previous Analysis Mode: ${previousMode}`);

                // If we have results, check if they are valid for the current mode
                if (diagnosisData.analysisResults && Object.keys(diagnosisData.analysisResults).length > 0) {
                    if (previousMode && previousMode !== currentMode) {
                        console.log(`[WARN] Analysis Mode Mismatch (${previousMode} -> ${currentMode}). Clearing old results to force re-analysis.`);

                        // Clear data to force re-run
                        diagnosisData.analysisResults = {};
                        diagnosisData.competitorFinancials = null;

                        // CRITICAL: Also clear Strategy Results to prevent stale data
                        const strategyKeys = ['capital_structure', 'cost_optimization', 'risk_management', 'tax_planning', 'ma_strategy'];
                        strategyKeys.forEach(key => delete diagnosisData[key]);
                        console.log('[DEBUG] Cleared strategy results due to mode mismatch.');

                        // Clear dashboard UI
                        const dashboard = document.getElementById('analysis-dashboard');
                        if (dashboard) dashboard.innerHTML = '';

                        // Reset button
                        const btn = document.getElementById('stage2-action-btn');
                        if (btn) {
                            btn.textContent = 'ğŸ”¬ é–‹å§‹è²¡æœƒåˆ†æ';
                            btn.onclick = runAnalysis;
                        }

                        alert('åµæ¸¬åˆ°åˆ†ææ¨¡å¼è®Šæ›´ï¼ˆä¾‹å¦‚ï¼šæ–°å¢/ç§»é™¤äº†ç«¶çˆ­å°æ‰‹ï¼‰ï¼Œè«‹é‡æ–°åŸ·è¡Œåˆ†æä»¥ç²å–æ­£ç¢ºçµæœã€‚');
                    } else {
                        console.log('[INFO] Analysis Mode matches. Preserving existing results.');
                    }
                } else {
                    // No results yet, nothing to clear. 
                    // If user just uploaded files but hasn't run analysis, that's fine.
                }
            }

            if (stageNumber === 5) {
                renderFinalReport();
            }

            // Auto-execute first tab when entering Stage 4 for better UX
            if (stageNumber === 4) {
                // Check if capital_structure hasn't been generated yet
                if (!diagnosisData.capital_structure) {
                    // Auto-execute the first tab (è³‡æœ¬çµæ§‹å„ªåŒ–)
                    setTimeout(() => {
                        showInnovationTab('capital_structure');
                    }, 500); // Small delay to ensure DOM is ready
                }
            }
        }

        // --- Data Verification Functions ---
        function toggleDataVerification() {
            const content = document.getElementById('data-verification-content');
            const toggle = document.getElementById('data-verification-toggle');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                toggle.textContent = 'â–²';
            } else {
                content.classList.add('hidden');
                toggle.textContent = 'â–¼';
            }
        }

        function populateDataEditors() {
            const companyEditor = document.getElementById('company-data-editor');
            const competitorEditor = document.getElementById('competitor-data-editor');

            // Sync ticker from Stage 1
            const stage1Ticker = document.getElementById('ticker').value;
            if (stage1Ticker) {
                // Extract ticker if format is "2330.TW (Example)"
                const match = stage1Ticker.match(/([A-Za-z0-9]+\.?[A-Za-z0-9]*)/);
                if (match) {
                    const fetchTickerElem = document.getElementById('fetch-ticker');
                    if (fetchTickerElem) fetchTickerElem.value = match[1];
                }
            }

            // Populate company data
            if (diagnosisData.context.financialData && diagnosisData.context.financialData.length > 0) {
                const allData = diagnosisData.context.financialData.map(d => `--- ${d.name} ---\n${d.content}`).join('\n\n');
                companyEditor.value = allData;
            } else {
                companyEditor.value = 'å°šæœªä¸Šå‚³è²¡æœƒæ•¸æ“š...';
            }

            // Populate competitor data (if available from URL or additional upload)
            if (diagnosisData.context.competitorData) {
                competitorEditor.value = diagnosisData.context.competitorData;
            } else {
                competitorEditor.value = 'å°šæœªä¸Šå‚³ç«¶çˆ­å°æ‰‹æ•¸æ“š...';
            }

            // Store original data for reset
            diagnosisData._originalCompanyData = companyEditor.value;
            diagnosisData._originalCompetitorData = competitorEditor.value;
        }

        function resetDataEditors() {
            document.getElementById('company-data-editor').value = diagnosisData._originalCompanyData || '';
            document.getElementById('competitor-data-editor').value = diagnosisData._originalCompetitorData || '';
            // Alert removed for better UI/UX flow
        }

        function saveDataEdits() {
            const companyData = document.getElementById('company-data-editor').value;
            const competitorData = document.getElementById('competitor-data-editor').value;

            // Update diagnosisData with edited content
            if (companyData && companyData !== 'å°šæœªä¸Šå‚³è²¡æœƒæ•¸æ“š...') {
                diagnosisData.context.financialData = [{
                    name: "Manual_Edit_Data.pdf",
                    content: companyData
                }];
                isDataVerified = true; // Mark as verified on save
                // Alert removed for better UI/UX flow
                document.getElementById('stage2-action-btn').disabled = false;
            }

            if (competitorData && competitorData !== 'å°šæœªä¸Šå‚³ç«¶çˆ­å°æ‰‹æ•¸æ“š...') {
                diagnosisData.context.competitorData = competitorData;
            }

            // Alert removed for better UI/UX flow
        }

        let isDataVerified = false;


        function loadExampleFinancialData() {
            document.getElementById('industry').value = 'PCB CCL é›»å­ææ–™è£½é€ æ¥­';
            document.getElementById('ticker').value = '2383.TW';
            document.getElementById('companySize').value = 'ä¸Šå¸‚/è·¨åœ‹å…¬å¸ (2000äººä»¥ä¸Š)';
            document.getElementById('competitorUrl').value = '6274.TW';
            document.getElementById('problemDescription').value = 'OPEXå¤ªé«˜èˆ‡æ¯›åˆ©ç‡é¢è‡¨å…ˆé€²è£½ç¨‹ç ”ç™¼æˆæœ¬ä¸Šå‡å£“åŠ›ï¼Œä¸”åœ°ç·£æ”¿æ²»é¢¨éšªå¢åŠ ï¼Œéœ€è©•ä¼°ä¾›æ‡‰éˆéŸŒæ€§èˆ‡ç¾é‡‘æµç‹€æ³ã€‚';

            // Alert removed for better UI/UX flow
        }

        async function loadExamplePDF(type) {
            // Determine which PDF to load
            const fileName = type === 'target' ? '2383.pdf' : '6274.pdf';
            const filePath = fileName; // Assuming files are in the same directory

            try {
                showLoading(`æ­£åœ¨è¼‰å…¥ç¯„ä¾‹æª”æ¡ˆ ${fileName}...`);

                // Fetch the PDF file
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`ç„¡æ³•è¼‰å…¥ ${fileName}ã€‚è«‹ç¢ºèªæª”æ¡ˆå·²æ”¾ç½®åœ¨ç›¸åŒç›®éŒ„ä¸‹ã€‚`);
                }

                const blob = await response.blob();
                const file = new File([blob], fileName, { type: 'application/pdf' });

                // Create a FileList-like object
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                const fileList = dataTransfer.files;

                // Call handleFiles to process the PDF
                handleFiles(fileList, type);

                hideLoading();

                // Show success message
                const companyType = type === 'target' ? 'ç›®æ¨™å…¬å¸' : 'ç«¶çˆ­å°æ‰‹';
                showTemporaryMessage(`âœ… å·²æˆåŠŸè¼‰å…¥${companyType}ç¯„ä¾‹æª”æ¡ˆï¼š${fileName}`, 'success');

            } catch (error) {
                hideLoading();
                console.error('Error loading example PDF:', error);

                // Check if it's likely a CORS/Protocol error
                if (window.location.protocol === 'file:') {
                    alert(
                        `âš ï¸ ç€è¦½å™¨å®‰å…¨é™åˆ¶ (Browser Security Restriction)\n\n` +
                        `æ‚¨ç›®å‰æ˜¯ç›´æ¥é–‹å•Ÿæª”æ¡ˆ (file://)ï¼Œç€è¦½å™¨ç¦æ­¢ç¨‹å¼è®€å–æœ¬æ©Ÿæª”æ¡ˆã€‚\n\n` +
                        `è‹¥è¦ä½¿ç”¨ã€Œå¿«é€Ÿè¼‰å…¥ã€åŠŸèƒ½ï¼Œè«‹é¸æ“‡ä»¥ä¸‹ä¸€ç¨®æ–¹å¼ï¼š\n` +
                        `1. ä½¿ç”¨ Local Server åŸ·è¡Œ (ä¾‹å¦‚ VS Code çš„ Live Server å¥—ä»¶)\n` +
                        `2. æˆ–è€…ç›´æ¥ä½¿ç”¨ä¸‹æ–¹çš„ã€Œé¸æ“‡æª”æ¡ˆã€æŒ‰éˆ•æ‰‹å‹•ä¸Šå‚³ ${fileName}`
                    );
                } else {
                    alert(`âŒ è¼‰å…¥ç¯„ä¾‹æª”æ¡ˆå¤±æ•—ï¼š${error.message}\n\nè«‹ç¢ºèª ${fileName} å·²æ”¾ç½®åœ¨æ­£ç¢ºç›®éŒ„ä¸‹ã€‚`);
                }
            }
        }

        async function extractAllMetrics() {
            const targetData = diagnosisData.context.financialData;
            const competitorData = diagnosisData.context.competitorFiles;

            // Check if we have data (either uploaded files or manual input)
            const manualInput = document.getElementById('company-data-editor').value;

            if ((!targetData || targetData.length === 0) && !manualInput) {
                alert('è«‹å…ˆä¸Šå‚³ç›®æ¨™å…¬å¸è²¡å ±ï¼Œæˆ–é»æ“Šã€Œè¼‰å…¥ç¯„ä¾‹ã€ï¼');
                return;
            }

            // Sync settings from UI
            const currentProvider = document.getElementById('aiProvider').value;
            const currentKey = document.getElementById('apiKey').value;
            if (currentProvider) runtimeSettings.provider = currentProvider;
            if (currentKey) runtimeSettings.apiKey = currentKey;

            const settings = runtimeSettings;
            if (!settings.apiKey) {
                alert("è«‹å…ˆè¨­å®š AI API Key (Gemini/GPT) ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚");
                document.getElementById('apiKey').focus();
                return;
            }

            showLoading('æ­£åœ¨é€²è¡Œ AI è²¡æœƒæ•¸æ“šæå–èˆ‡åˆ†æ...');

            try {
                // 1. Extract Target Data
                let targetJson = null;
                if (targetData && targetData.length > 0) {
                    targetJson = await extractData(targetData, 'Target Company');
                } else if (manualInput) {
                    targetJson = safeJSONParse(manualInput);
                }

                // 2. Extract Competitor Data (if available)
                let competitorJson = null;
                if (competitorData && competitorData.length > 0) {
                    competitorJson = await extractData(competitorData, 'Competitor Company');
                }

                // 3. Update Global Data & Editors
                // Helper to normalize keys (Cost of Revenue -> Cost of Goods Sold)
                const normalizeData = (json) => {
                    if (!json || !json.metrics) return;
                    if (json.metrics['Cost of Revenue'] && !json.metrics['Cost of Goods Sold']) {
                        json.metrics['Cost of Goods Sold'] = json.metrics['Cost of Revenue'];
                        delete json.metrics['Cost of Revenue'];
                    }
                };

                if (targetJson) {
                    normalizeData(targetJson);
                    diagnosisData.financials = targetJson;

                    // FIX: Sync Company Name to Context & UI
                    if (targetJson.company_name) {
                        diagnosisData.context.ticker = targetJson.company_name;
                        const tickerInput = document.getElementById('ticker');
                        if (tickerInput) tickerInput.value = targetJson.company_name;
                    }

                    if (targetJson.csv_output) {
                        document.getElementById('company-data-editor').value = targetJson.csv_output;
                    }
                }
                if (competitorJson) {
                    normalizeData(competitorJson);
                    diagnosisData.competitorFinancials = competitorJson;
                    if (competitorJson.csv_output) {
                        document.getElementById('competitor-data-editor').value = competitorJson.csv_output;
                    }
                }

                // 4. Render Comparison Table
                if (diagnosisData.financials) {
                    renderComparisonTable(diagnosisData.financials, diagnosisData.competitorFinancials);

                    // 5. Show Verification Section (Step 1.5)
                    document.getElementById('verification-section').classList.remove('hidden');
                    document.getElementById('comparison-metrics-container').classList.remove('hidden');

                    // Beginning Balance Verification Check (Precision Mode)
                    // User requires precise CCC (Average Balance), so we must check if _Beg fields were found.

                    const m = diagnosisData.financials.metrics;
                    let hasBeg = false;
                    let begDetails = [];

                    ['Accounts Receivable_Beg', 'Inventory_Beg', 'Accounts Payable_Beg'].forEach(key => {
                        let found = false;
                        if (m[key]) {
                            // Check all 4 periods for any valid data > 0
                            for (let i = 0; i < 4; i++) {
                                if (m[key][i] > 0) {
                                    found = true;
                                    hasBeg = true;
                                    break;
                                }
                            }
                        }
                        begDetails.push(`${key.split('_')[0]}: ${found ? 'âœ…' : 'âŒ'}`);
                    });

                    // CCC status block removed - calculation mode info now shown in Stage 3 CCC analysis
                    // alert('AI æ•¸æ“šæå–å®Œæˆï¼è«‹æª¢è¦–ä¸‹æ–¹è¡¨æ ¼ã€‚'); 
                } else {
                    throw new Error("ç„¡æ³•æå–ç›®æ¨™å…¬å¸æ•¸æ“š");
                }

            } catch (e) {
                console.error(e);
                alert('AI æå–å¤±æ•—: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        function renderComparisonTable(targetJson, competitorJson) {
            const tbody = document.getElementById('comparison-metrics-body');
            tbody.innerHTML = '';

            // Update year headers (2 periods only: YTD Current, YTD Prior)
            if (targetJson && targetJson.years) {
                document.getElementById('target-year-1').textContent = (targetJson.years[0] || '-');
                document.getElementById('target-year-2').textContent = (targetJson.years[1] || '-');
            }

            // Competitor headers
            if (competitorJson && competitorJson.years) {
                // Use target's format for consistency if available
                if (targetJson && targetJson.years) {
                    document.getElementById('comp-year-1').textContent = (targetJson.years[0] || '-');
                    document.getElementById('comp-year-2').textContent = (targetJson.years[1] || '-');
                } else {
                    // Fallback: use competitor's own years
                    document.getElementById('comp-year-1').textContent = (competitorJson.years[0] || '-');
                    document.getElementById('comp-year-2').textContent = (competitorJson.years[1] || '-');
                }
            }

            // Get all metric keys
            const targetMetrics = targetJson ? targetJson.metrics : {};
            const competitorMetrics = competitorJson ? competitorJson.metrics : {};
            const allKeys = new Set([...Object.keys(targetMetrics), ...Object.keys(competitorMetrics)]);


            // Define preferred order of metrics
            const metricOrder = [
                'Revenue',
                'Cost of Goods Sold',
                'Gross Profit',
                'Operating Expenses',
                'Operating Income',
                'Net Income',
                'EPS',
                'Total Assets',
                'Total Liabilities',
                'Total Equity',
                'Inventory',
                'Accounts Receivable',
                'Accounts Payable',
                'Operating Cash Flow',
                'Investing Cash Flow',
                'Financing Cash Flow',
                'Depreciation',
                'Amortization'
            ];

            // Sort keys according to preferred order, ONLY show items in metricOrder
            const sortedKeys = Array.from(allKeys)
                .filter(key => metricOrder.indexOf(key) !== -1)  // Only include keys in metricOrder
                .sort((a, b) => {
                    const aIndex = metricOrder.indexOf(a);
                    const bIndex = metricOrder.indexOf(b);
                    return aIndex - bIndex;
                });

            // Detect currency
            const targetCurrency = detectCurrency(targetJson);
            const compCurrency = detectCurrency(competitorJson);

            // Check if currencies are the same (fuzzy match)
            // e.g. "TWD Thousand" vs "æ–°å°å¹£åƒå…ƒ" should be treated as same if both imply TWD/NTD
            const isTWD = (c) => c && (c.includes('TWD') || c.includes('NTD') || c.includes('æ–°å°å¹£') || c.includes('å°å¹£'));
            const isUSD = (c) => c && (c.includes('USD') || c.includes('ç¾é‡‘') || c.includes('ç¾å…ƒ'));
            const isCNY = (c) => c && (c.includes('CNY') || c.includes('RMB') || c.includes('äººæ°‘å¹£'));

            let sameCurrency = false;
            if (targetCurrency === compCurrency) {
                sameCurrency = true;
            } else if (isTWD(targetCurrency) && isTWD(compCurrency)) {
                sameCurrency = true;
            } else if (isUSD(targetCurrency) && isUSD(compCurrency)) {
                sameCurrency = true;
            } else if (isCNY(targetCurrency) && isCNY(compCurrency)) {
                sameCurrency = true;
            }

            const targetOnly = targetCurrency && !compCurrency;
            // Prefer target currency string for display if unified
            const unifiedCurrency = sameCurrency ? targetCurrency : (targetOnly ? targetCurrency : null);

            // Add unified currency header if applicable
            if (unifiedCurrency) {
                const headerRow = document.createElement('tr');
                headerRow.className = 'bg-gradient-to-r from-amber-50 to-yellow-50';
                headerRow.innerHTML = `
                    <td colspan="5" class="px-4 py-2 text-center text-xs font-semibold text-amber-800">
                        ğŸ“Š å–®ä½ (Unit): ${unifiedCurrency}
                    </td>
                `;
                tbody.appendChild(headerRow);
            }

            // Render rows
            sortedKeys.forEach((key, index) => {
                // Explicitly hide Total Equity_Beg
                if (key === 'Total Equity_Beg') return;

                const targetVals = targetMetrics[key] || [null, null];
                const compVals = competitorMetrics[key] || [null, null];

                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                // Format values - don't show currency in each cell if unified
                // EPS is in å…ƒ, not åƒå…ƒ
                const formatVal = (val, curr, metricKey) => {
                    // Use em dash for unavailable/null data, show "0" for actual zero values
                    if (val === null || val === undefined) return 'â€“';
                    if (val === 0) return '0';
                    const formatted = new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(val);

                    // EPS is already in å…ƒ (not thousands)
                    if (metricKey === 'EPS') {
                        return `${formatted} <span class="text-[9px] text-gray-500">(å…ƒ)</span>`;
                    }

                    // Only show currency if not unified
                    return (!unifiedCurrency && curr) ? `${formatted} <span class="text-[9px] text-gray-400">${curr}</span>` : formatted;
                };

                tr.innerHTML = `
                    <td class="px-4 py-3 font-semibold text-gray-700 text-left">${key}</td>
                    <td class="px-4 py-3 text-right bg-blue-50 text-blue-900 font-medium">${formatVal(targetVals[0], targetCurrency, key)}</td>
                    <td class="px-4 py-3 text-right bg-blue-50 text-blue-700">${formatVal(targetVals[1], targetCurrency, key)}</td>
                    <td class="px-4 py-3 text-right bg-red-50 text-red-900 font-medium">${formatVal(compVals[0], compCurrency, key)}</td>
                    <td class="px-4 py-3 text-right bg-red-50 text-red-700">${formatVal(compVals[1], compCurrency, key)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function detectCurrency(json) {
            if (!json || !json.currency) return '';
            // AI should include currency info like "CNY Million" or "TWD Thousand"
            return json.currency || '';
        }

        function formatCurrency(num, currency) {
            if (num === null || num === undefined) return '-';
            const formatted = new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(num);
            return currency ? `${formatted} <span class="text-[9px] text-gray-400">${currency}</span>` : formatted;
        }


        /**
         * Extract exactly 2 numbers from a string
         * Handles formats like: "889,674 ( 217,801)" or "889,674 (217,801)" or "889674 -217801"
         */
        function extractTwoNumbers(text) {
            // Remove all spaces for easier parsing
            const cleaned = text.replace(/\s+/g, '');

            // Find all number patterns (with optional commas and parentheses for negatives)
            const numbers = [];

            // Pattern to match: optional opening paren, digits with optional commas, optional closing paren
            const numberPattern = /(\()?(\d{1,3}(?:,\d{3})*|\d+)(\))?/g;

            let match;
            while ((match = numberPattern.exec(cleaned)) !== null && numbers.length < 2) {
                let numStr = match[2].replace(/,/g, ''); // Remove commas
                let num = parseInt(numStr, 10);

                // If wrapped in parentheses, it's negative (Taiwan accounting notation)
                if (match[1] === '(' && match[3] === ')') {
                    num = -num;
                }

                numbers.push(num);
            }

            return numbers;
        }

        /**
         * Parse cash flow data directly from PDF text using AAAA/BBBB/CCCC anchors OR keywords
         * This bypasses AI extraction for cash flow, which has proven unreliable.
         * Returns: { operating: [ytd_current, ytd_prior], investing: [...], financing: [...] }
         */
        function parseCashFlowFromPDF(pdfText) {
            const result = {
                operating: [null, null],
                investing: [null, null],
                financing: [null, null]
            };

            // Validation: Check if we have actual PDF text
            if (!pdfText || pdfText.length < 100) {
                console.warn('âš ï¸ parseCashFlowFromPDF: PDF text is empty or too short, skipping extraction');
                return result;
            }

            // Split text into lines for better pattern matching
            const lines = pdfText.split('\n');
            console.log(`ğŸ“„ Parsing ${lines.length} lines for cash flow data...`);

            let foundAAA = false, foundBBB = false, foundCCC = false;

            // Helper to extract numbers from a line and its context
            const extractFromContext = (index, range = 3) => {
                // Look ahead a few lines for numbers
                const context = lines.slice(index, Math.min(index + range, lines.length)).join(' ');
                return extractTwoNumbers(context);
            };

            // Search for anchors or keywords
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // --- Operating Cash Flow ---
                // Priority 1: AAAA anchor
                if (!foundAAA && line.includes('AAAA') && (line.includes('ç‡Ÿæ¥­æ´»å‹•') || line.includes('Operating Activities'))) {
                    const numbers = extractFromContext(i);
                    if (numbers.length >= 2) {
                        result.operating = numbers;
                        foundAAA = true;
                        console.log(`âœ“ Found AAAA (Operating CF):`, numbers);
                    }
                }
                // Priority 2: Keyword fallback (if no AAAA found yet)
                if (!foundAAA && (line.includes('ç‡Ÿæ¥­æ´»å‹•ä¹‹æ·¨ç¾é‡‘æµ') || line.includes('Net cash generated from operating'))) {
                    const numbers = extractFromContext(i);
                    // Basic validation: Operating CF is usually a large number
                    if (numbers.length >= 2) {
                        result.operating = numbers;
                        foundAAA = true; // Treat as found
                        console.log(`âœ“ Found Keyword (Operating CF):`, numbers);
                    }
                }

                // --- Investing Cash Flow ---
                // Priority 1: BBBB anchor
                if (!foundBBB && line.includes('BBBB') && (line.includes('æŠ•è³‡æ´»å‹•') || line.includes('Investing Activities'))) {
                    const numbers = extractFromContext(i);
                    if (numbers.length >= 2) {
                        result.investing = numbers;
                        foundBBB = true;
                        console.log(`âœ“ Found BBBB (Investing CF):`, numbers);
                    }
                }
                // Priority 2: Keyword fallback
                if (!foundBBB && (line.includes('æŠ•è³‡æ´»å‹•ä¹‹æ·¨ç¾é‡‘æµ') || line.includes('Net cash used in investing'))) {
                    const numbers = extractFromContext(i);
                    if (numbers.length >= 2) {
                        result.investing = numbers;
                        foundBBB = true;
                        console.log(`âœ“ Found Keyword (Investing CF):`, numbers);
                    }
                }

                // --- Financing Cash Flow ---
                // Priority 1: CCCC anchor
                if (!foundCCC && line.includes('CCCC') && (line.includes('ç±Œè³‡æ´»å‹•') || line.includes('Financing Activities'))) {
                    const numbers = extractFromContext(i);
                    if (numbers.length >= 2) {
                        result.financing = numbers;
                        foundCCC = true;
                        console.log(`âœ“ Found CCCC (Financing CF):`, numbers);
                    }
                }
                // Priority 2: Keyword fallback
                if (!foundCCC && (line.includes('ç±Œè³‡æ´»å‹•ä¹‹æ·¨ç¾é‡‘æµ') || line.includes('Net cash used in financing'))) {
                    const numbers = extractFromContext(i);
                    if (numbers.length >= 2) {
                        result.financing = numbers;
                        foundCCC = true;
                        console.log(`âœ“ Found Keyword (Financing CF):`, numbers);
                    }
                }
            }

            // Log summary
            if (!foundAAA && !foundBBB && !foundCCC) {
                console.warn('âš ï¸ NO CASH FLOW DATA FOUND! Neither anchors (AAAA/BBBB/CCCC) nor keywords matched. (This may be expected if PDF text was truncated)');
            } else {
                console.log(`âœ… Cash Flow Extraction: Operating=${foundAAA}, Investing=${foundBBB}, Financing=${foundCCC}`);
            }

            console.log('Parsed Cash Flow:', result);
            return result;
        }

        async function extractData(files, label) {
            let contextStr = "";
            files.forEach(d => {
                // Balanced limit: enough for Beginning Balance but won't overload API
                contextStr += `\n[File: ${d.name}]\n${d.content.substring(0, 35000)}... (truncated)\n`;
            });

            const prompt = `
    You are a professional CFO assistant.
    Analyze the following financial report content for ${label}.
    
    **CRITICAL CHANGE**: Extract ONLY **Year-to-Date (YTD)** data for the **2 most relevant periods**:
    1. **Current Year-to-Date (YTD)** (e.g., 114å¹´1æœˆè‡³9æœˆ or 2025 Q1-Q3)
    2. **Previous Year-to-Date (YTD)** (e.g., 113å¹´1æœˆè‡³9æœˆ or 2024 Q1-Q3)
    
    **DO NOT extract single quarter (3-month) data. ONLY extract YTD (ç´¯è¨ˆ) data.**
    
    Required Metrics:
    0. Company Name (å…¬å¸åç¨±) - Extract the full company name from the report
    1. Revenue (ç‡Ÿæ”¶)
    2. Cost of Goods Sold (éŠ·è²¨æˆæœ¬) - Note: If report says "Cost of Revenue", extract as "Cost of Goods Sold"
    3. Gross Profit (æ¯›åˆ©)
    4. Operating Expenses (ç‡Ÿæ¥­è²»ç”¨)
    5. Operating Income (ç‡Ÿæ¥­åˆ©ç›Š)
    6. Depreciation (æŠ˜èˆŠ) - **Check "Notes" (e.g., Note 22 Expenses by Function) FIRST. This is more accurate than Cash Flow.**
    7. Amortization (æ”¤éŠ·) - **Check "Notes" (e.g., Note 22 Expenses by Function) FIRST.**
    8. Net Income (æ·¨åˆ©)
    9. EPS (æ¯è‚¡ç›ˆé¤˜) - **CRITICAL: Extract "Basic EPS" (åŸºæœ¬æ¯è‚¡ç›ˆé¤˜), NOT Diluted.**
    10. Total Assets (ç¸½è³‡ç”¢) - Ending Balance of the period
    11. Total Equity (è‚¡æ±æ¬Šç›Š/æ·¨å€¼) - Ending Balance of the period
    12. Operating Cash Flow (ç‡Ÿé‹ç¾é‡‘æµ) - **NOTE: Cash flow will be extracted separately via AAAA/BBBB/CCCC parser. You may skip or return null.**
    13. Investing Cash Flow (æŠ•è³‡ç¾é‡‘æµ) - **NOTE: Cash flow will be extracted separately via AAAA/BBBB/CCCC parser. You may skip or return null.**
    14. Financing Cash Flow (ç±Œè³‡ç¾é‡‘æµ) - **NOTE: Cash flow will be extracted separately via AAAA/BBBB/CCCC parser. You may skip or return null.**
    15. Inventory (å­˜è²¨) - Ending Balance
    16. Accounts Receivable (æ‡‰æ”¶å¸³æ¬¾) - Ending Balance
    17. Accounts Payable (æ‡‰ä»˜å¸³æ¬¾) - Ending Balance
    18. Inventory_Beg (æœŸåˆå­˜è²¨) - Beginning Balance of the YTD Period (Dec 31 of Last Year)
    19. Accounts Receivable_Beg (æœŸåˆæ‡‰æ”¶å¸³æ¬¾) - Beginning Balance of the YTD Period (Dec 31 of Last Year)
    20. Accounts Payable_Beg (æœŸåˆæ‡‰ä»˜å¸³æ¬¾) - Beginning Balance of the YTD Period (Dec 31 of Last Year)
    21. Current Assets (æµå‹•è³‡ç”¢) - Ending Balance
    22. Current Liabilities (æµå‹•è² å‚µ) - Ending Balance
    23. Total Liabilities (ç¸½è² å‚µ) - Ending Balance
    
    IMPORTANT INSTRUCTIONS:
    1. **YTD ONLY (CRITICAL)**:
       - **ONLY extract "æœ¬å¹´åº¦ç´¯è¨ˆ" (YTD / Year-to-Date / ç´¯è¨ˆ) data**
       - **IGNORE "æœ¬æœŸ" (single quarter / ç•¶æœŸ / æœ¬å­£) columns completely**
       - Look for columns labeled: "æœ¬å¹´åº¦ç´¯è¨ˆ", "å¹´åˆè‡³ä»Š", "ç´¯è¨ˆ", or month ranges like "1-3æœˆ", "1-6æœˆ", "1-9æœˆ", "1-12æœˆ"
       - **DO NOT extract quarterly 3-month data under any circumstances**

    2. **Beginning Balance Extraction (HIGHEST PRIORITY)**:
       - **Objective**: Extract the balance at the **start of the YTD period** (Jan 1 = Dec 31 of Last Year)
       - **Method**: Look for the "Previous Period" (ä¸ŠæœŸ) or "æœŸåˆ" column in the Balance Sheet
       - For **YTD (ç´¯è¨ˆ)**: The Beginning Balance is the value at **Dec 31 of Last Year** (ä¸Šå¹´åº¦æœ« / å»å¹´12æœˆ31æ—¥)
       - **Requirement**: 'Inventory_Beg', 'Accounts Receivable_Beg', 'Accounts Payable_Beg' MUST have values
       - **Fallback**: If you cannot find the specific column, use the **Ending Balance** value as a fallback. **Do not return 0.**
       - **Exclusion**: Do NOT extract 'Total Equity_Beg'. It is not needed.

    3. **Cash Flow Statement Extraction (WILL BE OVERRIDDEN)**:
       - **NOTE**: A separate rule-based parser will extract cash flow data using AAAA/BBBB/CCCC anchors.
       - You may return null for all cash flow fields or make a best attempt - they will be overridden.
    
    4. **Period Detection (CRITICAL - å°ç£å­£å ± YTD æå–)**: 
       
       âš ï¸ **åªæå– YTD ç´¯è¨ˆæ•¸æ“šï¼Œå¿½ç•¥å–®å­£æ•¸æ“š**ï¼š
       
       **ã€æœ¬å¹´åº¦ç´¯è¨ˆã€‘= å¹´åˆè‡³ä»Šç´¯è¨ˆ (YTD) - é€™æ˜¯æˆ‘å€‘è¦çš„ï¼**
       - æ¨™é¡Œå¯èƒ½æ˜¯ï¼š"æœ¬å¹´åº¦ç´¯è¨ˆ"ã€"å¹´åˆè‡³ä»Š"ã€"ç´¯è¨ˆ"
       - æˆ–æœˆä»½ç¯„åœï¼š"1-3æœˆ"ã€"1-6æœˆ"ã€"1-9æœˆ"ã€"1-12æœˆ"
       - é€™æ˜¯å¾ **å¹´åˆè‡³æœ¬å­£æœ«çš„ç´¯è¨ˆ** æ•¸æ“šï¼ˆ3/6/9/12å€‹æœˆï¼‰
       
       **ã€æœ¬æœŸã€‘= å–®å­£æ•¸æ“š (3å€‹æœˆ) - è«‹å¿½ç•¥æ­¤æ¬„ä½ï¼**
       - æ¨™é¡Œå¯èƒ½æ˜¯ï¼š"æœ¬æœŸ"ã€"ç•¶æœŸ"ã€"æœ¬å­£"
       - æˆ–æœˆä»½ç¯„åœï¼š"1-3æœˆ"ã€"4-6æœˆ"ã€"7-9æœˆ"ã€"10-12æœˆ"ï¼ˆæ³¨æ„ï¼šé€™äº›æ˜¯å–®å­£ï¼Œä¸æ˜¯ç´¯è¨ˆï¼‰
       - **è«‹å®Œå…¨å¿½ç•¥æ­¤æ¬„ä½ï¼Œä¸è¦æå–**
       
       **æå–é †åºï¼ˆéå¸¸é‡è¦ï¼‰**ï¼š
       - **Index 0**: ç•¶å¹´åº¦ æœ¬å¹´åº¦ç´¯è¨ˆï¼ˆYTDï¼šå¹´åˆè‡³æœ¬å­£æœ«ï¼Œä¾‹å¦‚ 114å¹´1-9æœˆï¼‰
       - **Index 1**: å»å¹´åŒæœŸ æœ¬å¹´åº¦ç´¯è¨ˆï¼ˆYTDï¼šå¹´åˆè‡³å»å¹´åŒå­£æœ«ï¼Œä¾‹å¦‚ 113å¹´1-9æœˆï¼‰
       
       **é©—è­‰é‚è¼¯**ï¼š
       - Index 0 å’Œ Index 1 çš„æœˆä»½ç¯„åœæ‡‰è©²ç›¸åŒï¼ˆä¾‹å¦‚éƒ½æ˜¯ 1-9æœˆï¼‰
       - Index 0 çš„å¹´ä»½æ‡‰è©²æ¯” Index 1 å¤§ 1 å¹´
       
    5. **Year Detection (CRITICAL)**: 
       - **Republic Year (æ°‘åœ‹å¹´)**: Convert ROC Year to Christian Year by adding 1911 for internal logic, but keep the original string for the "years" output array.
       - **Rule**: æ°‘åœ‹ 113 å¹´ = 2024, æ°‘åœ‹ 114 å¹´ = 2025.
       
    6. **VALIDATION CHECK**:
       - Beginning and Ending balances should be relatively close (within 50% typically)
       - If Beginning = 0 but Ending = 30M, you probably missed it - search harder!
       
    7. **Currency Detection**: Detect the currency and unit from the report.
       - **CRITICAL**: If the numbers are in thousands, keep them as is.
       
    8. **EBITDA Calculation**: EBITDA = Operating Income + Depreciation + Amortization.
    
    **æå–ç¯„ä¾‹ï¼ˆYTD Onlyï¼‰**ï¼š
    å‡è¨­é€™æ˜¯ Q3 å ±å‘Šï¼Œåªæå– YTD ç´¯è¨ˆæ•¸æ“šï¼š
    
    âœ… æ­£ç¢ºæå–ï¼š
    years: ["114å¹´1-9æœˆ", "113å¹´1-9æœˆ"]
    Revenue: [YTD_CURRENT, YTD_PRIOR]
    
    âŒ éŒ¯èª¤æå–ï¼ˆçµ•å°é¿å…ï¼‰ï¼š
    - ä¸è¦æå– ["114å¹´ç¬¬3å­£", "113å¹´ç¬¬3å­£"] - é€™æ˜¯å–®å­£æ•¸æ“š
    - ä¸è¦æå– ["114å¹´7-9æœˆ", "113å¹´7-9æœˆ"] - é€™æ˜¯å–®å­£æ•¸æ“š
    
    ** CRITICAL FORMAT REQUIREMENT FOR "years" FIELD **:
    - Use month range format ONLY: "114å¹´1-9æœˆ", "113å¹´1-9æœˆ"
    - For Q1: "114å¹´1-3æœˆ", "113å¹´1-3æœˆ"
    - For Q2: "114å¹´1-6æœˆ", "113å¹´1-6æœˆ"
    - For Q3: "114å¹´1-9æœˆ", "113å¹´1-9æœˆ"
    - For Q4: "114å¹´1-12æœˆ", "113å¹´1-12æœˆ"
    - DO NOT use quarter format like "114å¹´ç¬¬3å­£"
    - DO NOT use date range format like "114å¹´7æœˆ1æ—¥è‡³9æœˆ30æ—¥"
    - DO NOT add "(YTD)" label - the month range already indicates YTD
    - Examples:
      âœ… CORRECT: ["114å¹´1-9æœˆ", "113å¹´1-9æœˆ"]
      âŒ WRONG: ["114å¹´ç¬¬3å­£", "113å¹´ç¬¬3å­£"] (this is quarterly, not YTD)
      âŒ WRONG: ["114å¹´1-9æœˆ (YTD)", ...] (redundant label)
    
    Return a JSON object with this EXACT structure (2 periods only):
    {
        "company_name": "Extracted Company Name",
        "years": ["YTD Current Period", "YTD Prior Period"],
        "currency": "TWD Thousand",
        "metrics": {
            "Revenue": [ytd_current, ytd_prior],
            "Cost of Revenue": [ytd_current, ytd_prior],
            "Gross Profit": [ytd_current, ytd_prior],
            "Operating Expenses": [ytd_current, ytd_prior],
            "Operating Income": [ytd_current, ytd_prior],
            "Depreciation": [ytd_current, ytd_prior],
            "Amortization": [ytd_current, ytd_prior],
            "Net Income": [ytd_current, ytd_prior],
            "EPS": [ytd_current, ytd_prior],
            "Total Assets": [ytd_current, ytd_prior],
            "Total Equity": [ytd_current, ytd_prior],
            "Operating Cash Flow": [ytd_current, ytd_prior],
            "Investing Cash Flow": [ytd_current, ytd_prior],
            "Financing Cash Flow": [ytd_current, ytd_prior],
            "Inventory": [ytd_current, ytd_prior],
            "Accounts Receivable": [ytd_current, ytd_prior],
            "Accounts Payable": [ytd_current, ytd_prior],
            "Current Assets": [ytd_current, ytd_prior],
            "Current Liabilities": [ytd_current, ytd_prior],
            "Total Liabilities": [ytd_current, ytd_prior]
        },
        "csv_output": "Generate a clean CSV string of these metrics for the editor"
    }
    
    If data is missing, use null. Ensure values are numbers (no commas).
    
    Context:
    ${contextStr}
    `;

            // Parse cash flow directly from PDF text using rule-based parser
            const cashFlowData = parseCashFlowFromPDF(contextStr);

            const res = await callAI(prompt, [], 0.1);  // Low temp for precise data extraction
            const json = safeJSONParse(res);

            // Override AI cash flow results with parsed values (more reliable)
            // CRITICAL: Always override, even with null, to prevent AI hallucination
            if (json && json.metrics && cashFlowData) {
                // Always override Operating Cash Flow
                json.metrics["Operating Cash Flow"] = [
                    cashFlowData.operating[0], // YTD current (may be null)
                    cashFlowData.operating[1]  // YTD prior (may be null)
                ];
                if (cashFlowData.operating[0] !== null) {
                    console.log(`âœ“ Overrode Operating Cash Flow with parsed values: ${cashFlowData.operating}`);
                } else {
                    console.log(`âœ“ Set Operating Cash Flow to null (not found in PDF)`);
                }

                // Always override Investing Cash Flow
                json.metrics["Investing Cash Flow"] = [
                    cashFlowData.investing[0], // YTD current (may be null)
                    cashFlowData.investing[1]  // YTD prior (may be null)
                ];
                if (cashFlowData.investing[0] !== null) {
                    console.log(`âœ“ Overrode Investing Cash Flow with parsed values: ${cashFlowData.investing}`);
                } else {
                    console.log(`âœ“ Set Investing Cash Flow to null (not found in PDF)`);
                }

                // Always override Financing Cash Flow
                json.metrics["Financing Cash Flow"] = [
                    cashFlowData.financing[0], // YTD current (may be null)
                    cashFlowData.financing[1]  // YTD prior (may be null)
                ];
                if (cashFlowData.financing[0] !== null) {
                    console.log(`âœ“ Overrode Financing Cash Flow with parsed values: ${cashFlowData.financing}`);
                } else {
                    console.log(`âœ“ Set Financing Cash Flow to null (not found in PDF)`);
                }
            }

            // CRITICAL: Validate all metric arrays are exactly 2 elements (YTD refactor)
            // This prevents display issues if AI returns inconsistent array lengths
            if (json && json.metrics) {
                for (const [key, value] of Object.entries(json.metrics)) {
                    if (Array.isArray(value)) {
                        if (value.length > 2) {
                            // Truncate to 2 elements (keep first 2)
                            json.metrics[key] = [value[0], value[1]];
                            console.warn(`âš ï¸ Truncated ${key} from ${value.length} to 2 elements`);
                        } else if (value.length < 2) {
                            // Pad with null to 2 elements
                            while (json.metrics[key].length < 2) {
                                json.metrics[key].push(null);
                            }
                            console.warn(`âš ï¸ Padded ${key} from ${value.length} to 2 elements`);
                        }
                    }
                }
            }

            return json;
        }

        function renderKeyMetricsTable(json, containerId, bodyId) {
            const tbody = document.getElementById(bodyId);
            tbody.innerHTML = '';
            const years = json.years || ['Year 1', 'Year 2'];

            // Update headers
            const thead = document.querySelector(`#${containerId} thead tr`);
            if (thead) {
                thead.innerHTML = `<th class="px-4 py-2 border">é …ç›®</th>
                                   <th class="px-4 py-2 border">${years[0]}</th>
                                   <th class="px-4 py-2 border">${years[1]}</th>`;
            }

            for (const [key, values] of Object.entries(json.metrics)) {
                // Explicitly hide Total Equity_Beg as requested
                if (key === 'Total Equity_Beg') continue;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-2 border font-medium">${key}</td>
                    <td class="px-4 py-2 border">${formatNumber(values[0])}</td>
                    <td class="px-4 py-2 border">${formatNumber(values[1])}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return new Intl.NumberFormat('en-US').format(num);
        }



        function showLoading(msg) { document.getElementById('loadingMessage').textContent = msg; document.getElementById('loadingIndicator').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingIndicator').classList.add('hidden'); }

        function showTemporaryMessage(message, type = 'success') {
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-20 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity duration-300`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => messageDiv.remove(), 300);
            }, 3000);
        }

        function saveSettings() {
            const p = document.getElementById('aiProvider').value;
            const k = document.getElementById('apiKey').value;
            // const fmp = document.getElementById('fmpApiKey').value; // Removed
            const newSettings = { provider: p, apiKey: k };
            setSettings(newSettings);
            runtimeSettings = newSettings; // Update global variable

            // Re-init model if needed (simple reload or just alert)
            alert('è¨­å®šå·²å„²å­˜ï¼');
        }

        function getFileIcon(filename) {
            if (filename.endsWith('.pdf')) return 'ğŸ“•';
            return 'ğŸ“„';
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // --- AI Calls ---
        async function callAI(prompt, images = [], temperature = 0.7) {
            let provider = runtimeSettings.provider || 'gemini';
            let key = runtimeSettings.apiKey;

            // Auto-detect key type to prevent mismatch errors
            if (key) {
                if (key.startsWith('AIza')) {
                    if (provider !== 'gemini') {
                        console.warn(`Detected Gemini Key but provider is ${provider}. Switching to Gemini.`);
                        provider = 'gemini';
                    }
                } else if (key.startsWith('sk-')) {
                    if (provider !== 'openai' && provider !== 'deepseek') {
                        console.warn(`Detected OpenAI/DeepSeek Key but provider is ${provider}. Switching to OpenAI.`);
                        provider = 'openai';
                    }
                }
            }

            if (!key) throw new Error('è«‹å…ˆè¨­å®š API Key');

            if (provider === 'gemini') {
                return await callGemini(prompt, key, images, temperature);
            } else {
                // OpenAI/DeepSeek (Text only for now)
                if (images.length > 0) console.warn("OpenAI/DeepSeek ç›®å‰åƒ…å‚³é€æ–‡å­—æç¤ºï¼Œå¿½ç•¥åœ–ç‰‡ã€‚");
                if (provider === 'openai') return await callOpenAI(prompt, key, temperature);
                if (provider === 'deepseek') return await callDeepSeek(prompt, key, temperature);
            }
        }


        async function callGemini(prompt, key, images, temperature = 0.7) {
            const model = 'gemini-2.5-flash'; // User requested specific versionimodal
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;

            const parts = [{ text: `${CFO_PERSONA}\n\n${prompt}` }];
            images.forEach(img => {
                // img.data is "data:image/png;base64,..."
                const base64Data = img.data.split(',')[1];
                const mimeType = img.data.split(';')[0].split(':')[1];
                parts.push({ inline_data: { mime_type: mimeType, data: base64Data } });
            });

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ role: "user", parts: parts }],
                    generationConfig: {
                        response_mime_type: "application/json",
                        temperature: temperature  // Adaptive: 0.1 for extraction, 0.7 for analysis
                    }
                })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error?.message || 'Gemini Error');
            return data.candidates[0].content.parts[0].text;
        }

        async function callOpenAI(prompt, key, temperature = 0.7) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [{ role: 'system', content: CFO_PERSONA + " Respond in JSON." }, { role: 'user', content: prompt }],
                    response_format: { type: "json_object" },
                    temperature: temperature  // Adaptive: 0.1 for extraction, 0.7 for analysis
                })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error?.message || 'OpenAI Error');
            return data.choices[0].message.content;
        }

        async function callDeepSeek(prompt, key, temperature = 0.7) {
            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages: [{ role: 'system', content: CFO_PERSONA }, { role: 'user', content: prompt }],
                    response_format: { type: "json_object" },
                    temperature: temperature  // Adaptive: 0.1 for extraction, 0.7 for analysis
                })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error?.message || 'DeepSeek Error');
            return data.choices[0].message.content;
        }

        function safeJSONParse(str) {
            try {
                // First try: direct parse
                return JSON.parse(str);
            } catch (e) {
                try {
                    // Second try: extract from markdown code block
                    const match = str.match(/```json\s*([\s\S]*?)\s*```/);
                    if (match) {
                        return JSON.parse(match[1]);
                    }

                    // Third try: extract JSON object and sanitize
                    const start = str.indexOf('{');
                    const end = str.lastIndexOf('}');
                    if (start > -1 && end > start) {
                        let jsonStr = str.substring(start, end + 1);

                        // Fix common issues with AI-generated JSON:
                        // 1. Replace literal newlines and control characters in strings with escaped versions
                        // This prevents "Bad control character in string literal" errors
                        jsonStr = jsonStr
                            .replace(/\n/g, '\\n')      // Replace actual newlines with \n
                            .replace(/\r/g, '\\r')      // Replace carriage returns with \r
                            .replace(/\t/g, '\\t')      // Replace tabs with \t
                            .replace(/\f/g, '\\f')      // Replace form feeds with \f
                            .replace(/\b/g, '\\b');     // Replace backspaces with \b

                        return JSON.parse(jsonStr);
                    }
                } catch (e2) {
                    console.error('JSON parse error:', e2);
                    console.error('Problematic string:', str.substring(0, 500));
                }
                return { error: true, message: "Invalid JSON", details: e.message };
            }
        }

        // --- Analysis Logic ---
        async function runAnalysis() {
            // Sync settings from UI before running to ensure latest selection is used
            const currentProvider = document.getElementById('aiProvider').value;
            const currentKey = document.getElementById('apiKey').value;
            if (currentProvider) {
                runtimeSettings.provider = currentProvider;
            }
            if (currentKey) {
                runtimeSettings.apiKey = currentKey;
            }

            const selected = Array.from(document.querySelectorAll('.model-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) { alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æ¨¡å‹'); return; }

            diagnosisData.selectedModels = selected;

            diagnosisData.analysisResults = {};

            // Set Analysis Mode (Single vs Competitor)
            diagnosisData.analysisMode = (diagnosisData.context.competitorFiles && diagnosisData.context.competitorFiles.length > 0) ? 'competitor' : 'single';
            console.log(`[INFO] Starting Analysis in Mode: ${diagnosisData.analysisMode}`);
            goToStage(3);
            document.getElementById('analysis-dashboard').innerHTML = '';

            for (const modelId of selected) {
                // CRITICAL: Skip benchmarking if no competitor files uploaded
                if (modelId === 'benchmarking') {
                    if (!diagnosisData.context.competitorFiles || diagnosisData.context.competitorFiles.length === 0) {
                        console.log('[INFO] Skipping benchmarking analysis - no competitor files uploaded');
                        document.getElementById('analysis-dashboard').innerHTML += `
                            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-4">
                                <h3 class="text-lg font-bold text-yellow-800 mb-2">â„¹ï¸ æ¨™ç«¿åˆ†æå·²ç•¥é</h3>
                                <p class="text-sm text-yellow-700">æœªä¸Šå‚³ç«¶çˆ­å°æ‰‹è²¡å ±ï¼Œå› æ­¤è·³éæ¨™ç«¿åˆ†æã€‚è‹¥éœ€è¦æ­¤åˆ†æï¼Œè«‹åœ¨ Stage 1 ä¸Šå‚³ç«¶çˆ­å°æ‰‹ PDFã€‚</p>
                            </div>
                        `;
                        continue; // Skip to next model
                    }
                }

                showLoading(`æ­£åœ¨åŸ·è¡Œ ${availableModels.find(m => m.id === modelId).name}...`);
                try {
                    const prompt = window[`get${modelId.charAt(0).toUpperCase() + modelId.slice(1)}Prompt`]();
                    const images = diagnosisData.context.financialImages || [];
                    const res = await callAI(prompt, images);
                    const json = safeJSONParse(res);

                    // Check if parsing failed
                    if (json.error) {
                        throw new Error(`JSON è§£æå¤±æ•—: ${json.details}\n\nAI å›æ‡‰å‰ 500 å­—å…ƒ:\n${res.substring(0, 500)}`);
                    }

                    diagnosisData.analysisResults[modelId] = json;
                    renderAnalysisCard(modelId, json);
                } catch (e) {
                    console.error(e);
                    document.getElementById('analysis-dashboard').innerHTML += `<div class="bg-red-100 p-4 rounded text-red-800 mb-4"><strong>åˆ†æå¤±æ•— (${modelId}):</strong><br><pre class="text-xs mt-2 overflow-auto">${e.message}</pre></div>`;
                }
            }
            hideLoading();
        }

        // --- Prompts ---
        function getBaseContext() {
            const ctx = diagnosisData.context;
            let dataStr = `å…¬å¸åç¨±: ${ctx.companyName}\n`;
            dataStr += `ç”¢æ¥­: ${ctx.industry}\n`;
            dataStr += `å ±è¡¨æœŸé–“: ${ctx.period}\n`;
            dataStr += `è²¨å¹£å–®ä½: ${diagnosisData.financials.currency || 'åƒå…ƒ (thousands)'}\n\n`;

            // Add industry-specific guidance conditionally
            let industryGuidance = '';
            if (ctx.industry && (ctx.industry.includes('PCB') || ctx.industry.includes('CCL') || ctx.industry.includes('éŠ…ç®”åŸºæ¿'))) {
                industryGuidance = `\n** PCB/CCL ç”¢æ¥­ç‰¹æ€§åƒè€ƒ **:\n- é«˜åº«å­˜ç‰¹æ€§ï¼ˆéŠ…ç®”ã€ç»çº–å¸ƒã€æ¨¹è„‚ç­‰åŸæ–™ï¼ŒDIO é€šå¸¸ 60-120å¤©ï¼‰\n- é•·æ‡‰æ”¶å¸³æ¬¾å¤©æ•¸ï¼ˆä¸‹æ¸¸å®¢æˆ¶ç‚º PCB/æ¨¡çµ„/EMSå» ï¼ŒDSO é€šå¸¸ 60-90å¤©ï¼‰\n- è³‡æœ¬å¯†é›†ï¼ˆè¨­å‚™æŠ˜èˆŠ5-10å¹´ï¼Œæ“´ç”¢éœ€å¤§é‡ CAPEXï¼‰\n- CCC é€šå¸¸ 60-100å¤©\n`;
            }

            const fm = diagnosisData.financials.metrics;
            for (let k in fm) {
                const vals = fm[k];
                if (Array.isArray(vals)) dataStr += `${k}: ${vals.join(', ')}\n`;
            }

            return `${CFO_PERSONA}
            ${industryGuidance}
            
            ${dataStr}
            
            ** CRITICAL - JSON æ ¼å¼è¦æ±‚ **:
            - æ‰€æœ‰æ›è¡Œå¿…é ˆä½¿ç”¨ \\n (å…©å€‹å­—å…ƒï¼šåæ–œç·š+n)ï¼Œä¸å¯ä½¿ç”¨å¯¦éš›æ›è¡Œ
            - æ‰€æœ‰å¼•è™Ÿå¿…é ˆæ­£ç¢ºè·³è„«
            - ç¢ºä¿è¼¸å‡ºç‚ºæœ‰æ•ˆçš„ JSON æ ¼å¼
            
            ** CRITICAL - æœŸé–“æ¨™è¨»è¦æ±‚ **:
            - âŒ ç¦æ­¢ä½¿ç”¨æ¨¡ç³Šçš„ã€Œæœ€æ–°ä¸€æœŸã€ç­‰è©å½™
            - âœ… å¿…é ˆä½¿ç”¨å…·é«”æœŸé–“åç¨±ï¼ˆå¦‚ã€Œ114å¹´1-9æœˆã€ã€ã€Œ113å¹´1-9æœˆã€ç­‰ï¼‰
            - æ•¸æ“šä¾†æºï¼šIndex 0 = ${diagnosisData.financials?.years?.[0] || 'ç•¶å‰ YTD'}, Index 1 = ${diagnosisData.financials?.years?.[1] || 'å‰æœŸ YTD'}
            - æ‰€æœ‰åˆ†æçµæœä¸­çš„æ•¸å€¼éƒ½å¿…é ˆæ˜ç¢ºæ¨™è¨»å…¶å°æ‡‰çš„å…·é«”æœŸé–“
            
            (è‹¥æœ‰é™„åœ–ï¼Œè«‹åƒè€ƒåœ–ç‰‡ä¸­çš„è²¡æœƒå ±è¡¨æ•¸æ“š)
            `;
        }

        function getDupontPrompt() {
            const ratios = calculateFinancialRatios(diagnosisData.financials);
            let ratioContext = "";
            if (ratios) {
                ratioContext = "** Pre-Calculated ROE Data (Use these values directly) **:\n";
                ratios.forEach(r => {
                    if (r.roe) {
                        ratioContext += `- ${r.period}: ROE=${r.roe}, Net Margin=${r.netMargin}, Asset Turnover=${r.assetTurnover}, Equity Multiplier=${r.equityMultiplier}\n`;
                    }
                });
            }

            const currentPeriod = diagnosisData.financials?.years?.[0] || '114å¹´1-9æœˆ';
            return `${getBaseContext()}
            ${ratioContext}
            è«‹é€²è¡Œã€Œæœé‚¦åˆ†æ (DuPont Analysis)ã€ã€‚
            
            ** CRITICAL **:
            1. è«‹ç›´æ¥ä½¿ç”¨ä¸Šè¿°æä¾›çš„é ç®—æ•¸æ“š (ROE, Net Margin, Asset Turnover, Equity Multiplier)ã€‚
            2. è«‹ä½¿ç”¨ Index 0 (${currentPeriod}) çš„æ•¸æ“šå¡«å…¥ valueã€‚
            3. âŒ ç¦æ­¢åœ¨ value æ¬„ä½ä¸­é¡¯ç¤ºæœŸé–“ï¼ˆå¦‚ã€Œ(114å¹´1-9æœˆ)ã€ï¼‰ï¼ŒæœŸé–“å·²ç¶“åœ¨æ¨™é¡Œä¸­é¡¯ç¤ºã€‚
            4. åœ¨æ–‡å­—æè¿°ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ã€Œ${currentPeriod}ã€ä¾†æŒ‡ç§°ç•¶å‰æœŸé–“ï¼Œä½†ä¸è¦ä½¿ç”¨æ¨¡ç³Šçš„ã€Œæœ€æ–°ä¸€æœŸã€ã€‚
            
            è¼¸å‡º JSON:
            {
                "roe": "XX%",
                "breakdown": {
                    "net_profit_margin": { "value": "XX%", "status": "é«˜/ä¸­/ä½", "comment": "..." },
                    "asset_turnover": { "value": "XXæ¬¡", "status": "é«˜/ä¸­/ä½", "comment": "..." },
                    "equity_multiplier": { "value": "XX", "status": "é«˜/ä¸­/ä½", "comment": "..." }
                },
                "summary_insight": "åˆ†æ ROE è¶¨å‹¢èˆ‡é©…å‹•å› å­..."
            }`;
        }

        function getSolvencyPrompt() {
            const ratios = calculateFinancialRatios(diagnosisData.financials);
            let ratioContext = "";
            if (ratios) {
                ratioContext = "** Pre-Calculated Liquidity & Solvency Data (Use these values directly) **:\n";
                ratios.forEach(r => {
                    if (r.currentRatio) {
                        ratioContext += `- ${r.period}: Current Ratio=${r.currentRatio}, Quick Ratio=${r.quickRatio}, Debt Ratio=${r.debtRatio}\n`;
                    }
                });
            }

            const currentPeriod = diagnosisData.financials?.years?.[0] || '114å¹´1-9æœˆ';
            return `${getBaseContext()}
            ${ratioContext}
            è«‹åˆ†æã€Œæµå‹•æ€§èˆ‡å„Ÿå‚µèƒ½åŠ›ã€ã€‚
            
            ** CRITICAL **:
            1. è«‹ç›´æ¥ä½¿ç”¨ä¸Šè¿°æä¾›çš„é ç®—æ•¸æ“š (Current Ratio, Quick Ratio, Debt Ratio)ã€‚
            2. è«‹ä½¿ç”¨ Index 0 (${currentPeriod}) çš„æ•¸æ“šå¡«å…¥ valueã€‚
            3. âŒ ç¦æ­¢åœ¨ value æ¬„ä½ä¸­é¡¯ç¤ºæœŸé–“ï¼ˆå¦‚ã€Œ(114å¹´1-9æœˆ)ã€ï¼‰ï¼ŒæœŸé–“å·²ç¶“åœ¨æ¨™é¡Œä¸­é¡¯ç¤ºã€‚
            4. åœ¨æ–‡å­—æè¿°ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ã€Œ${currentPeriod}ã€ä¾†æŒ‡ç§°ç•¶å‰æœŸé–“ï¼Œä½†ä¸è¦ä½¿ç”¨æ¨¡ç³Šçš„ã€Œæœ€æ–°ä¸€æœŸã€ã€‚
            
            è¼¸å‡º JSON:
            {
                "metrics": [
                    { "name": "æµå‹•æ¯”ç‡", "value": "XX%", "benchmark": "200%", "status": "å®‰å…¨/è­¦ç¤º", "analysis": "..." },
                    { "name": "é€Ÿå‹•æ¯”ç‡", "value": "XX%", "benchmark": "100%", "status": "...", "analysis": "..." },
                    { "name": "è² å‚µæ¯”ç‡", "value": "XX%", "status": "...", "analysis": "..." }
                ],
                "solvency_assessment": "æ•´é«”å„Ÿå‚µèƒ½åŠ›è©•ä¼°..."
            }`;
        }

        function getProfitabilityPrompt() {
            const ratios = calculateFinancialRatios(diagnosisData.financials);
            let ratioContext = "";
            if (ratios) {
                ratioContext = "** Pre-Calculated Profitability Data (Use these values directly) **:\n";
                ratios.forEach(r => {
                    if (r.grossMargin) {
                        ratioContext += `- ${r.period}: Gross Margin=${r.grossMargin}, Operating Margin=${r.opMargin}, Net Margin=${r.netMargin}, EBITDA Margin=${r.ebitdaMargin}`;
                        if (r.revenueGrowth) ratioContext += `, Revenue Growth=${r.revenueGrowth}`;
                        if (r.netIncomeGrowth) ratioContext += `, Net Income Growth=${r.netIncomeGrowth}`;
                        ratioContext += `\n`;
                    }
                });
            }

            const currentPeriod = diagnosisData.financials?.years?.[0] || '114å¹´1-9æœˆ';
            return `${getBaseContext()}
            ${ratioContext}
            è«‹åˆ†æã€Œç²åˆ©èƒ½åŠ›ã€ã€‚
            
            ** CRITICAL **:
            1. è«‹ç›´æ¥ä½¿ç”¨ä¸Šè¿°æä¾›çš„é ç®—æ•¸æ“š (Gross Margin, Operating Margin, Net Margin, EBITDA Margin, Revenue Growth, Net Income Growth)ã€‚
            2. ä½¿ç”¨ Index 0 (${currentPeriod}) çš„æ•¸æ“šå¡«å…¥ valueã€‚
            3. âŒ ç¦æ­¢åœ¨ value æ¬„ä½ä¸­é¡¯ç¤ºæœŸé–“ï¼ˆå¦‚ã€Œ(114å¹´1-9æœˆ)ã€ï¼‰ï¼ŒæœŸé–“å·²ç¶“åœ¨æ¨™é¡Œä¸­é¡¯ç¤ºã€‚
            4. åœ¨æ–‡å­—æè¿°ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ã€Œ${currentPeriod}ã€ä¾†æŒ‡ç§°ç•¶å‰æœŸé–“ï¼Œä½†ä¸è¦ä½¿ç”¨æ¨¡ç³Šçš„ã€Œæœ€æ–°ä¸€æœŸã€ã€‚
            5. æ­·å²è¶¨å‹¢è«‹åœ¨ trend æˆ– insight ä¸­æè¿°ã€‚
            é‡é»ï¼šæ¯›åˆ©ç‡ã€ç‡Ÿæ¥­åˆ©ç›Šç‡ã€æ·¨åˆ©ç‡ã€‚è‹¥æ•¸æ“šè¶³å¤ ï¼Œè«‹åˆ†æ EBITDAã€‚
            è¼¸å‡º JSON:
            {
                "margins": [
                    { "name": "æ¯›åˆ©ç‡", "value": "XX%", "trend": "ä¸Šå‡/æŒå¹³/ä¸‹é™", "insight": "..." },
                    { "name": "ç‡Ÿæ¥­åˆ©ç›Šç‡", "value": "XX%", "trend": "...", "insight": "..." },
                    { "name": "æ·¨åˆ©ç‡", "value": "XX%", "trend": "...", "insight": "..." }
                ],
                "growth_metrics": [
                    { "name": "ç‡Ÿæ”¶æˆé•·ç‡", "value": "XX%", "trend": "...", "insight": "..." },
                    { "name": "æ·¨åˆ©æˆé•·ç‡", "value": "XX%", "trend": "...", "insight": "..." }
                ],
                "overall_profitability": "..."
            }`;
        }

        // Helper function to format numbers for display

        function getCashflowPrompt() {
            const baseContext = getBaseContext();
            const period = diagnosisData.context.period || 'Unknown';

            // CRITICAL FIX: Extract Cash Flow values explicitly from Step 1 metrics
            let cashFlowContext = "";
            if (diagnosisData.financials && diagnosisData.financials.metrics) {
                const m = diagnosisData.financials.metrics;
                const years = diagnosisData.financials.years || [];

                const ocf = m["Operating Cash Flow"] || [null, null, null, null];
                const icf = m["Investing Cash Flow"] || [null, null, null, null];
                const fcf = m["Financing Cash Flow"] || [null, null, null, null];

                cashFlowContext = `
            
            âš ï¸ **CRITICAL - NUMERICAL CONSISTENCY REQUIREMENT** âš ï¸
            When you calculate and report DSO, DIO, DPO values:
            1. Calculate each metric ONLY ONCE using the CCC data provided
            2. Use EXACTLY THE SAME number throughout your ENTIRE response  
            3. DO NOT mention different values in different sections
            4. Example: If you calculate DSO = 111.0 days, then use "111.0 days" (or "111 å¤©") everywhere
               âŒ WRONG: Writing "DSO 111å¤©" in one place and "DSOé”129å¤©" in another place
               âœ… CORRECT: Always write the same value everywhere
            
            ** Cash Flow Data (Extracted from Step 1) **:
            ${years.map((y, i) => `
            Period ${i + 1} (${y || 'N/A'}):
              - Operating Cash Flow: ${ocf[i] !== null && ocf[i] !== undefined ? formatNumber(ocf[i]) + ' åƒå…ƒ' : 'æœªæä¾›'}
              - Investing Cash Flow: ${icf[i] !== null && icf[i] !== undefined ? formatNumber(icf[i]) + ' åƒå…ƒ' : 'æœªæä¾›'}
              - Financing Cash Flow: ${fcf[i] !== null && fcf[i] !== undefined ? formatNumber(fcf[i]) + ' åƒå…ƒ' : 'æœªæä¾›'}
            `).join('')}
            
            ** CRITICAL - FCF (Free Cash Flow) Calculation **:
            âš ï¸ **IMPORTANT**: The correct FCF formula is: FCF = Operating Cash Flow - CAPEX
            However, Taiwan quarterly reports do NOT separately disclose CAPEX.
            
            **Acceptable Approaches**:
            1. **Simplified FCF (ç²—ä¼°ç‰ˆ)** - USE THIS:
               FCF_Simplified = Operating CF + Investing CF
               âš ï¸ Warning: This is only a rough estimate because Investing CF includes:
                  - PPE purchases (CAPEX)
                  - Investments in subsidiaries
                  - Financial asset purchases/sales
                  - Equipment disposals
               Therefore, this FCF_Simplified should be labeled as "ç²—ä¼°" and NOT used for formal analysis.
            
            2. **Narrative Approach** - PREFERRED:
               State: "æ­£å¼ FCF è¨ˆç®—éœ€è¦ CAPEX æ•¸æ“šï¼Œå­£å ±æœªå–®ç¨æ­éœ²ã€‚å¾æŠ•è³‡æ´»å‹•ç¾é‡‘æµå¯è§€å¯Ÿè³‡æœ¬æ”¯å‡ºè¶¨å‹¢ã€‚"
            
            Please use "FCF_Simplified" with appropriate warnings in your analysis.
                `;
            }

            // Perform CCC Calculation in JS (YTD Only - Index 0)
            const ratios = calculateFinancialRatios(diagnosisData.financials);
            let cccContext = "CCC Calculation could not be performed due to missing data.";

            if (ratios && ratios.length > 0) {
                // Use Index 0 (Current YTD period) for CCC calculation
                const targetRatio = ratios[0];

                if (targetRatio && targetRatio.ccc) {
                    const c = targetRatio.ccc;

                    // Generate EBITDA summary for all periods
                    let ebitdaContext = "** Pre-Calculated EBITDA Data (All Periods) **:\n";
                    ratios.forEach((r) => {
                        if (r.ebitda) {
                            ebitdaContext += `- ${r.period}: EBITDA = ${r.ebitda} åƒå…ƒ, EBITDA Margin = ${r.ebitdaMargin}\n`;
                        }
                    });

                    cccContext = `
            ** Pre-Calculated Cash Conversion Cycle (CCC) Data **:
            
            è«‹ä½¿ç”¨ä»¥ä¸‹CCCæ‘˜è¦ï¼ˆè«‹å‹¿ä¿®æ”¹æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨ï¼‰ï¼š
            
            DSO ${c.dso}å¤©ã€DIO ${c.dio}å¤©ã€DPO ${c.dpo}å¤©ï¼ŒCCCç‚º${c.ccc}å¤©ã€‚
            
            ${ebitdaContext}
            
            â›” **ç¦æ­¢äº‹é …**ï¼š
            1. âŒ ç¦æ­¢è²ç¨±ã€ŒDSOã€DIOã€DPOç­‰å…·é«”æ•¸æ“šæœªæä¾›ã€æˆ–ã€Œç„¡æ³•é€²è¡Œç²¾ç¢ºè¨ˆç®—ã€
            2. âŒ ç¦æ­¢èªªã€Œå› æ­¤ç„¡æ³•é€²è¡Œç²¾ç¢ºçš„è¨ˆç®—èˆ‡åˆ†æã€
            3. ä¸è¦è¼¸å‡ºã€Œè¨ˆç®—æ¨¡å¼ã€ã€ã€Œç²¾æº–æ¨¡å¼/æ¨ä¼°æ¨¡å¼ã€
            4. ä¸è¦è¼¸å‡ºã€Œæ•¸æ“šä¾†æºã€ã€ã€ŒæœŸåˆ/æœŸæœ«ã€
            5. ä¸è¦è¼¸å‡ºã€Œå…¬å¼ã€ã€ã€Œè¨ˆç®—éç¨‹ã€
            6. ä¸è¦è¼¸å‡ºã€Œè¨ˆç®—åŸºç¤ä½¿ç”¨å¤©æ•¸XXå¤©ã€
            7. âœ… å¿…é ˆç›´æ¥å¼•ç”¨ä¸Šè¿°æä¾›çš„å…·é«”æ•¸å€¼ï¼ˆDSO ${c.dso}å¤©ã€DIO ${c.dio}å¤©ã€DPO ${c.dpo}å¤©ã€CCC ${c.ccc}å¤©ï¼‰

            ğŸ’¡ **CCC åˆ†ææŒ‡å¼• (é‡è¦)**ï¼š
            - è‹¥ CCC ç‚º **è² å€¼** (ä¾‹å¦‚ -20å¤©)ï¼Œä»£è¡¨å…¬å¸å°ä¾›æ‡‰å•†çš„ä»˜æ¬¾æœŸ (DPO) æ¥µé•·ï¼Œå¤§æ–¼å­˜è²¨èˆ‡æ‡‰æ”¶å¸³æ¬¾çš„ç©å£“æœŸã€‚é€™æ˜¯ä¸€ç¨®**æ¥µä½³**çš„ç‡Ÿé‹æ¨¡å¼ (å¦‚ Apple, Amazon)ï¼Œä»£è¡¨å…¬å¸æ˜¯ç”¨ä¾›æ‡‰å•†çš„è³‡é‡‘åœ¨åšç”Ÿæ„ï¼Œè³‡é‡‘æ•ˆç‡æ¥µé«˜ã€‚
            - è‹¥ CCC ç‚ºè² å€¼ï¼Œ**è«‹å‹¿**å»ºè­°ã€Œç¸®çŸ­ CCCã€æˆ–ã€Œæ”¹å–„ç‡Ÿé‹æ•ˆç‡ã€ï¼Œåè€Œæ‡‰ç¨±è®šå…¶å¼·å¤§çš„ä¾›æ‡‰éˆè­°åƒ¹èƒ½åŠ›ã€‚
            - è‹¥ CCC ç‚ºæ­£å€¼ä¸”æ•¸å€¼å¾ˆé«˜ï¼Œæ‰éœ€è¦å»ºè­°æ”¹å–„ (å¦‚ç¸®çŸ­ DSO, DIO æˆ–å»¶é•· DPO)ã€‚
            `;
                } else {
                    cccContext = "CCC Data is not available (Missing Revenue, Cost, or Balances).";
                }
            }

            return `${baseContext}
            ${cashFlowContext}
            ${cccContext}

            è«‹åˆ†æã€Œç¾é‡‘æµé‡èˆ‡ EBITDAã€ã€‚
            é‡é»ï¼šEBITDA(ç¨…å‰æ¯å‰æŠ˜èˆŠæ”¤éŠ·å‰åˆ©æ½¤)ã€ç‡Ÿé‹ç¾é‡‘æµ(OCF)ã€è‡ªç”±ç¾é‡‘æµ(FCF)ã€ç¾é‡‘è½‰æ›å¾ªç’°(CCC)ã€‚
            
            ** CRITICAL REQUIREMENTS **:
            1. Cash Flow Analysis: ä½¿ç”¨ä¸Šè¿°æä¾›çš„ç¾é‡‘æµæ•¸æ“šï¼ˆå·²å¾ Step 1 metrics æå–ï¼‰
            2. FCF Calculation: ä½¿ç”¨ FCF_Simplified = Operating CF + Investing CFï¼Œä¸¦æ¨™è¨»ç‚º"ç²—ä¼°ç‰ˆï¼Œåƒ…ä¾›åƒè€ƒ"
            3. CCC Analysis: è«‹ç›´æ¥ä½¿ç”¨ä¸Šè¿°æä¾›çš„ CCC æ•¸æ“š
            
            ** IMPORTANT - ANALYSIS SCOPE **:
            æ­¤éšæ®µåƒ…åˆ†æã€Œç›®æ¨™å…¬å¸ (${diagnosisData.financials?.company_name || 'ç›®æ¨™å…¬å¸'})ã€çš„ç¾é‡‘æµèˆ‡æ•ˆç‡æŒ‡æ¨™ã€‚
            ç«¶çˆ­å°æ‰‹æ¯”è¼ƒå°‡åœ¨ä¸‹ä¸€éšæ®µ (Stage 3: æ¨™ç«¿åˆ†æ) é€²è¡Œã€‚
            
            
            è¼¸å‡º JSON:
            {
                "ebitda_analysis": "è©³ç´°çš„ EBITDA åˆ†æ...",
                    "flows": {
                    "operating": { 
                        "status": "æ­£/è² ", 
                        "comment": "æè¿°å¯¦éš›æ•¸å€¼èˆ‡è¶¨å‹¢" 
                    },
                    "investing": { 
                        "status": "...", 
                        "comment": "æè¿°å¯¦éš›æ•¸å€¼èˆ‡è¶¨å‹¢" 
                    },
                    "financing": { 
                        "status": "...", 
                        "comment": "æè¿°å¯¦éš›æ•¸å€¼èˆ‡è¶¨å‹¢" 
                    }
                },
                "fcf_analysis": "âš ï¸ FCF ç²—ä¼°ç‰ˆ = Operating CF + Investing CF = [è¨ˆç®—çµæœ] åƒå…ƒã€‚æ³¨æ„ï¼šæ­¤ç‚ºç²—ä¼°ï¼Œæ­£å¼åˆ†æéœ€è¦ CAPEX æ•¸æ“šï¼ˆå­£å ±æœªå–®ç¨æ­éœ²ï¼‰ã€‚",
                    "ccc_analysis": "âš ï¸ é‡è¦ï¼šä¸Šè¿°å·²æä¾›å®Œæ•´çš„ DSOã€DIOã€DPOã€CCC æ•¸æ“šï¼Œè«‹å‹™å¿…ç›´æ¥å¼•ç”¨é€™äº›æ•¸å€¼é€²è¡Œåˆ†æã€‚ç¦æ­¢è²ç¨±ã€æ•¸æ“šæœªæä¾›ã€æˆ–ã€ç„¡æ³•è¨ˆç®—ã€ã€‚è«‹åŸºæ–¼æä¾›çš„ CCC æ•¸å€¼ï¼ˆç´„ ${ratios && ratios.length > 0 && ratios[0].ccc ? ratios[0].ccc.ccc : 'XX'} å¤©ï¼‰è©•ä¼°ç›®æ¨™å…¬å¸çš„ç‡Ÿé‹æ•ˆç‡ï¼Œä¸¦èˆ‡ç”¢æ¥­æ¨™æº–ï¼ˆPCB/CCL ç”¢æ¥­ CCC é€šå¸¸ 60-100 å¤©ï¼‰é€²è¡Œæ¯”è¼ƒï¼Œæä¾›å…·é«”æ”¹å–„å»ºè­°ã€‚"
            }
            `;
        }

        // --- Simplified Period Parsing (YTD Only) ---
        function identifyPeriodType(periodName) {
            if (!periodName) return { type: 'YTD', days: 270 }; // Default to Q3 YTD
            const lower = periodName.toLowerCase();

            // YTD period detection based on month ranges
            // Q1 YTD: 1-3æœˆ (90 days)
            // Q2 YTD: 1-6æœˆ (180 days)
            // Q3 YTD: 1-9æœˆ (270 days)
            // Q4 YTD: 1-12æœˆ (365 days)

            if (lower.includes('1-9') || lower.includes('9 months') || lower.includes('jan-sep')) {
                return { type: 'YTD', days: 270 };
            }
            if (lower.includes('1-6') || lower.includes('6 months') || lower.includes('jan-jun') || lower.includes('ä¸ŠåŠå¹´')) {
                return { type: 'YTD', days: 180 };
            }
            if (lower.includes('1-3') || lower.includes('3 months') || lower.includes('jan-mar')) {
                return { type: 'YTD', days: 90 };
            }
            if (lower.includes('1-12') || lower.includes('12 months') || lower.includes('jan-dec') || lower.includes('å…¨å¹´')) {
                return { type: 'YTD', days: 365 };
            }

            // Smart Regex for "1æœˆè‡³Xæœˆ" pattern
            const monthRangeMatch = periodName.match(/1\s*(?:æœˆ|â€“|-|to|è‡³)\s*(\d{1,2})\s*æœˆ?/);
            if (monthRangeMatch) {
                const endMonth = parseInt(monthRangeMatch[1]);
                if (!isNaN(endMonth)) {
                    if (endMonth === 3) return { type: 'YTD', days: 90 };
                    if (endMonth === 6) return { type: 'YTD', days: 180 };
                    if (endMonth === 9) return { type: 'YTD', days: 270 };
                    if (endMonth === 12) return { type: 'YTD', days: 365 };
                }
            }

            // Default to Q3 YTD (most common)
            return { type: 'YTD', days: 270 };
        }

        function calculateFinancialRatios(financials) {
            if (!financials || !financials.metrics) return null;
            const m = financials.metrics;
            const years = financials.years || [];
            const results = [];

            // Helper to get value safely
            const getVal = (key, idx) => {
                const val = m[key] ? m[key][idx] : 0;
                if (typeof val === 'string') return parseFloat(val.replace(/,/g, '')) || 0;
                return val || 0;
            };

            // Loop through all available periods
            for (let i = 0; i < years.length; i++) {
                const periodName = years[i];
                const periodInfo = identifyPeriodType(periodName);

                const res = {
                    period: periodName,
                    type: periodInfo.type,
                    daysUsed: periodInfo.days
                };

                // --- 1. Liquidity & Solvency ---
                const currentAssets = getVal('Current Assets', i);
                const currentLiabilities = getVal('Current Liabilities', i);
                const totalLiabilities = getVal('Total Liabilities', i);
                const totalAssets = getVal('Total Assets', i);
                const totalEquity = getVal('Total Equity', i);

                // Ending Balances for Quick Ratio
                const invEnd = getVal('Inventory', i);
                const arEnd = getVal('Accounts Receivable', i);
                const apEnd = getVal('Accounts Payable', i);

                if (currentLiabilities !== 0) {
                    res.currentRatio = (currentAssets / currentLiabilities * 100).toFixed(1) + '%';
                    res.quickRatio = ((currentAssets - invEnd) / currentLiabilities * 100).toFixed(1) + '%';
                }
                if (totalAssets !== 0) {
                    res.debtRatio = (totalLiabilities / totalAssets * 100).toFixed(1) + '%';
                    res.equityMultiplier = (totalAssets / totalEquity).toFixed(2);
                }

                // --- 2. Profitability ---
                const revenue = getVal('Revenue', i);
                const cost = getVal('Cost of Goods Sold', i) || getVal('Cost', i) || getVal('Cost of Revenue', i); // Handle alias

                // Gross Profit Validation (Revenue - COGS)
                let grossProfit = getVal('Gross Profit', i);
                if (!grossProfit && revenue !== 0 && cost !== 0) {
                    grossProfit = revenue - cost;
                }

                // Operating Income Validation (Gross Profit - OPEX)
                let operatingIncome = getVal('Operating Income', i);
                const opExpenses = getVal('Operating Expenses', i);
                if (!operatingIncome && grossProfit !== 0 && opExpenses !== 0) {
                    operatingIncome = grossProfit - opExpenses;
                }

                const netIncome = getVal('Net Income', i);
                const depreciation = getVal('Depreciation', i);
                const amortization = getVal('Amortization', i);

                if (revenue !== 0) {
                    res.grossMargin = (grossProfit / revenue * 100).toFixed(1) + '%';
                    res.opMargin = (operatingIncome / revenue * 100).toFixed(1) + '%';
                    res.netMargin = (netIncome / revenue * 100).toFixed(1) + '%';

                    // EBITDA
                    const ebitda = operatingIncome + depreciation + amortization;
                    res.ebitda = formatNumber(ebitda);
                    res.ebitdaMargin = (ebitda / revenue * 100).toFixed(1) + '%';

                    // Asset Turnover (Revenue / Total Assets)
                    if (totalAssets !== 0) {
                        let rawTurnover = revenue / totalAssets;
                        res.assetTurnover = rawTurnover.toFixed(2);
                    }
                }

                // ROE (DuPont) - Use Average Equity
                // Total Equity_Beg removed - use ending balance for ROE
                const avgEquity = totalEquity;

                if (avgEquity !== 0) {
                    let rawROE = netIncome / avgEquity;
                    res.roe = (rawROE * 100).toFixed(1) + '%';
                }

                // YoY Growth Calculation
                // Assuming order: 0=CurrQ, 1=PrevQ, 2=CurrYTD, 3=PrevYTD
                let prevIdx = -1;
                if (i === 0) prevIdx = 1;
                if (i === 2) prevIdx = 3;

                if (prevIdx !== -1 && prevIdx < years.length) {
                    const prevRev = getVal('Revenue', prevIdx);
                    const prevNI = getVal('Net Income', prevIdx);

                    if (prevRev !== 0) {
                        res.revenueGrowth = ((revenue - prevRev) / Math.abs(prevRev) * 100).toFixed(1) + '%';
                    }
                    if (prevNI !== 0) {
                        res.netIncomeGrowth = ((netIncome - prevNI) / Math.abs(prevNI) * 100).toFixed(1) + '%';
                    }
                }

                // --- 3. Efficiency (CCC) - ONLY for Quarter or Year types ---
                if ((periodInfo.type === 'quarter' || periodInfo.type === 'year') &&
                    revenue !== 0 && cost !== 0 && periodInfo.days > 0) {

                    // 1. å…ˆæŠ“æœŸæœ«é¤˜é¡ï¼ˆä¸€å®šæœ‰ï¼‰
                    const arEnd = getVal('Accounts Receivable', i);
                    const invEnd = getVal('Inventory', i);
                    const apEnd = getVal('Accounts Payable', i);

                    // 2. å˜—è©¦æŠ“ *_Begï¼Œå¦‚æœæ²’æœ‰ï¼Œå°±ç”¨ã€Œä¸Šä¸€æœŸæœŸæœ«ã€ç•¶æœŸåˆ
                    let arBeg = getVal('Accounts Receivable_Beg', i);
                    let invBeg = getVal('Inventory_Beg', i);
                    let apBeg = getVal('Accounts Payable_Beg', i);

                    // years æ’åºæ˜¯ [114å¹´1-9æœˆ, 113å¹´1-9æœˆ, ...]
                    const prevIdx = i + 1;   // ä¸‹ä¸€å€‹ index = ä¸Šä¸€å¹´åº¦/ä¸Šä¸€æœŸ

                    if (!arBeg && prevIdx < years.length) {
                        arBeg = getVal('Accounts Receivable', prevIdx);
                    }
                    if (!invBeg && prevIdx < years.length) {
                        invBeg = getVal('Inventory', prevIdx);
                    }
                    if (!apBeg && prevIdx < years.length) {
                        apBeg = getVal('Accounts Payable', prevIdx);
                    }

                    // 3. ç”¨ã€ŒæœŸåˆ + æœŸæœ«ã€ç®—å¹³å‡ï¼Œå¦‚æœé‚„æ˜¯æŠ“ä¸åˆ°æœŸåˆï¼Œå°±é€€å›æœŸæœ«ï¼ˆé¿å… NaNï¼‰
                    const avgAR = (arBeg || arBeg === 0) ? (arBeg + arEnd) / 2 : arEnd;
                    const avgInv = (invBeg || invBeg === 0) ? (invBeg + invEnd) / 2 : invEnd;
                    const avgAP = (apBeg || apBeg === 0) ? (apBeg + apEnd) / 2 : apEnd;

                    // 4. ä»¥ã€Œå¹³å‡é¤˜é¡ / æ¯æ—¥é‡‘é¡ã€è¨ˆç®—å‘¨è½‰å¤©æ•¸
                    const days = periodInfo.days;          // ä½ ç›®å‰ 1-9æœˆ ç”¨ 270 å¤©
                    const dailyRev = revenue / days;
                    const dailyCost = cost / days;

                    const dso = dailyRev > 0 ? (avgAR / dailyRev) : 0;
                    const dio = dailyCost > 0 ? (avgInv / dailyCost) : 0;
                    const dpo = dailyCost > 0 ? (avgAP / dailyCost) : 0;

                    res.ccc = {
                        dso: dso.toFixed(1),
                        dio: dio.toFixed(1),
                        dpo: dpo.toFixed(1),
                        ccc: (dso + dio - dpo).toFixed(1),
                        daysUsed: days,
                        avgAR: avgAR,
                        avgInv: avgInv,
                        avgAP: avgAP,
                        revenue: revenue,
                        cost: cost,
                        usedAverage: !!(arBeg || invBeg || apBeg),
                        arBeg: arBeg,
                        invBeg: invBeg,
                        apBeg: apBeg,
                        arEnd: arEnd,
                        invEnd: invEnd,
                        apEnd: apEnd
                    };
                }

                results.push(res);
            }

            return results;
        }

        function getCost_structurePrompt() {
            return `${getBaseContext()}
            è«‹åˆ†æã€Œæˆæœ¬çµæ§‹ã€ã€‚
            åˆ†è¾¨å›ºå®šæˆæœ¬èˆ‡è®Šå‹•æˆæœ¬æ¯”ä¾‹ï¼Œä¼°ç®—æç›Šå…©å¹³é»(Break - even Point)ã€‚
            ** IMPORTANT **: All fields in the JSON output MUST be STRINGS or ARRAYS of STRINGS.Do NOT return nested objects.
            è¼¸å‡º JSON:
            {
                "fixed_vs_variable": "æè¿°å›ºå®šèˆ‡è®Šå‹•æˆæœ¬çš„åˆ†é…æƒ…æ³...(STRING)",
                    "break_even_analysis": "æç›Šå…©å¹³åˆ†æ...(STRING)",
                        "cost_reduction_opportunities": ["æ©Ÿæœƒ1", "æ©Ÿæœƒ2"]
            } `;
        }

        function getBenchmarkingPrompt() {
            const targetData = diagnosisData.financials; // Our company data from Stage 1
            const competitorData = diagnosisData.competitorFinancials; // Competitor data from Stage 1

            // Extract company names
            const targetCompanyName = diagnosisData.context.ticker || 'ç›®æ¨™å…¬å¸';
            const competitorCompanyName = competitorData?.company_name || competitorData?.companyName || 'ç«¶çˆ­å°æ‰‹';

            let dataContext = getBaseContext();

            // Add explicit company identification
            dataContext += `\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;
            dataContext += `\n ** ğŸ“Š æ¨™ç«¿åˆ†ææ•¸æ“š **\n`;
            dataContext += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
            dataContext += `ğŸ¯ ç›®æ¨™å…¬å¸ï¼ˆè²´å…¬å¸ï¼‰: ${targetCompanyName} \n`;
            dataContext += `ğŸ” ç«¶çˆ­å°æ‰‹: ${competitorCompanyName} \n`;
            dataContext += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;

            // Pre-calculate Target Company's CCC metrics (from calculateFinancialRatios)
            const ratios = calculateFinancialRatios(targetData);
            let targetCCCText = "";
            let targetUsedAverage = false;

            if (ratios && ratios.length > 0 && ratios[0].ccc) {
                const c = ratios[0].ccc;
                targetUsedAverage = c.usedAverage || false;

                targetCCCText = `\\n\\n** ğŸ“Š ç›®æ¨™å…¬å¸æ•ˆç‡æŒ‡æ¨™ï¼ˆå·²é å…ˆè¨ˆç®—ï¼ŒIndex 0 = æœ€æ–° YTDï¼Œ${targetUsedAverage ? 'å¹³å‡æ³•' : 'æœŸæœ«æ³•'}ï¼‰**:\\n`;
                targetCCCText += `- DSO: ${c.dso}å¤©\\n`;
                targetCCCText += `- DIO: ${c.dio}å¤©\\n`;
                targetCCCText += `- DPO: ${c.dpo}å¤©\\n`;
                targetCCCText += `- CCC: ${c.ccc}å¤©\\n`;
                targetCCCText += `âš ï¸ **é€™äº›æ•¸å€¼å·²è¨ˆç®—å®Œæˆï¼Œè«‹ç›´æ¥ä½¿ç”¨æ–¼æ¯”è¼ƒè¡¨æ ¼ä¸­çš„ target æ¬„ä½ï¼**\\n`;
            }

            // If we have competitor data from Stage 1, inject it
            if (competitorData && competitorData.metrics) {
                // Pre-calculate Competitor's CCC metrics (Index 0) for explicit display
                const m = competitorData.metrics;
                let compCCCText = "";
                if (m.Revenue && m.Revenue[0] && m['Cost of Goods Sold'] && m['Cost of Goods Sold'][0] &&
                    m.Inventory && m.Inventory[0] && m['Accounts Receivable'] && m['Accounts Receivable'][0] &&
                    m['Accounts Payable'] && m['Accounts Payable'][0]) {

                    // Determine YTD period days from years array
                    const periodName = competitorData.years ? competitorData.years[0] : '';
                    const periodInfo = identifyPeriodType(periodName);
                    const days = periodInfo.days || 270; // Default to Q3 YTD

                    // Get current period (Index 0) ending balances
                    const rev = m.Revenue[0];
                    const cogs = m['Cost of Goods Sold'][0];
                    const invEnd = m.Inventory[0];
                    const arEnd = m['Accounts Receivable'][0];
                    const apEnd = m['Accounts Payable'][0];

                    // Try to get previous period (Index 1) as beginning balances
                    let invBeg = (m.Inventory && m.Inventory[1]) ? m.Inventory[1] : null;
                    let arBeg = (m['Accounts Receivable'] && m['Accounts Receivable'][1]) ? m['Accounts Receivable'][1] : null;
                    let apBeg = (m['Accounts Payable'] && m['Accounts Payable'][1]) ? m['Accounts Payable'][1] : null;

                    // Check if BOTH companies can use average method
                    const compCanUseAverage = (invBeg !== null || arBeg !== null || apBeg !== null);
                    const targetUsedAverage = ratios && ratios.length > 0 && ratios[0].ccc && ratios[0].ccc.usedAverage;

                    // UNIFIED STRATEGY: If either cannot use average, BOTH revert to period-end
                    const useUnifiedAverage = (targetUsedAverage && compCanUseAverage);
                    let methodWarning = "";

                    let avgInv, avgAR, avgAP;
                    if (useUnifiedAverage) {
                        // Both can use average â†’ use average method
                        avgInv = (invBeg + invEnd) / 2;
                        avgAR = (arBeg + arEnd) / 2;
                        avgAP = (apBeg + apEnd) / 2;
                    } else {
                        // At least one cannot use average â†’ BOTH use period-end
                        avgInv = invEnd;
                        avgAR = arEnd;
                        avgAP = apEnd;

                        if (!targetUsedAverage && !compCanUseAverage) {
                            methodWarning = "\\nâš ï¸ **æ–¹æ³•èªªæ˜**ï¼šå…©å®¶å…¬å¸å‡ç„¡ä¸Šä¸€æœŸæ•¸æ“šï¼Œçµ±ä¸€ä½¿ç”¨æœŸæœ«æ³•è¨ˆç®— CCCã€‚";
                        } else if (!targetUsedAverage) {
                            methodWarning = "\\nâš ï¸ **æ–¹æ³•èªªæ˜**ï¼šç›®æ¨™å…¬å¸ç„¡ä¸Šä¸€æœŸæ•¸æ“šï¼Œç‚ºç¢ºä¿æ¯”è¼ƒä¸€è‡´æ€§ï¼Œå…©å®¶å…¬å¸çµ±ä¸€ä½¿ç”¨æœŸæœ«æ³•è¨ˆç®— CCCã€‚";
                        } else {
                            methodWarning = "\\nâš ï¸ **æ–¹æ³•èªªæ˜**ï¼šç«¶çˆ­å°æ‰‹ç„¡ä¸Šä¸€æœŸæ•¸æ“šï¼Œç‚ºç¢ºä¿æ¯”è¼ƒä¸€è‡´æ€§ï¼Œå…©å®¶å…¬å¸çµ±ä¸€ä½¿ç”¨æœŸæœ«æ³•è¨ˆç®— CCCã€‚";
                        }
                    }

                    // Calculate DSO/DIO/DPO
                    const dso = ((avgAR / rev) * days).toFixed(1);
                    const dio = ((avgInv / cogs) * days).toFixed(1);
                    const dpo = ((avgAP / cogs) * days).toFixed(1);
                    const ccc = (parseFloat(dso) + parseFloat(dio) - parseFloat(dpo)).toFixed(1);

                    compCCCText = `\\n\\n** ğŸ“Š ç«¶çˆ­å°æ‰‹æ•ˆç‡æŒ‡æ¨™ï¼ˆå·²é å…ˆè¨ˆç®—ï¼ŒIndex 0 æ•¸æ“šï¼Œä½¿ç”¨ ${days} å¤©ï¼Œ${useUnifiedAverage ? 'å¹³å‡æ³•' : 'æœŸæœ«æ³•'}ï¼‰**:\\n`;
                    compCCCText += `- DSO: ${dso}å¤©\\n`;
                    compCCCText += `- DIO: ${dio}å¤©\\n`;
                    compCCCText += `- DPO: ${dpo}å¤©\\n`;
                    compCCCText += `- CCC: ${ccc}å¤©\\n`;
                    compCCCText += `âš ï¸ **é€™äº›æ•¸å€¼å·²è¨ˆç®—å®Œæˆï¼Œè«‹ç›´æ¥ä½¿ç”¨æ–¼æ¯”è¼ƒè¡¨æ ¼ä¸­çš„ competitor æ¬„ä½ï¼**\\n`;
                    compCCCText += methodWarning;
                }

                dataContext += `\n ** ç«¶çˆ­å°æ‰‹è²¡å‹™æ•¸æ“šï¼ˆå·²å¾ Stage 1 æå–ï¼‰**: \n`;
                dataContext += `å…¬å¸åç¨±: ${competitorCompanyName} \n`;
                dataContext += `æœŸé–“: ${competitorData.years ? competitorData.years.join(', ') : 'æœªçŸ¥'} \n`;
                dataContext += `è²¨å¹£å–®ä½: ${competitorData.currency || 'æœªçŸ¥'} \n\n`;

                // Add key metrics for comparison
                if (m.Revenue) dataContext += `ç‡Ÿæ”¶: ${m.Revenue.join(', ')} \n`;
                if (m['Cost of Goods Sold']) dataContext += `éŠ·è²¨æˆæœ¬: ${m['Cost of Goods Sold'].join(', ')} \n`;
                if (m['Gross Profit']) dataContext += `æ¯›åˆ©: ${m['Gross Profit'].join(', ')} \n`;
                if (m['Operating Expenses']) dataContext += `ç‡Ÿé‹è²»ç”¨: ${m['Operating Expenses'].join(', ')} \n`;
                if (m['Operating Income']) dataContext += `ç‡Ÿæ¥­åˆ©ç›Š: ${m['Operating Income'].join(', ')} \n`;
                if (m['Net Income']) dataContext += `æ·¨åˆ©: ${m['Net Income'].join(', ')} \n`;
                if (m['Total Assets']) dataContext += `ç¸½è³‡ç”¢: ${m['Total Assets'].join(', ')} \n`;
                if (m['Total Equity']) dataContext += `è‚¡æ±æ¬Šç›Š: ${m['Total Equity'].join(', ')} \n`;

                // Added for Efficiency Ratios (DSO, DIO, DPO, CCC)
                if (m['Inventory']) dataContext += `å­˜è²¨: ${m['Inventory'].join(', ')} \n`;
                if (m['Accounts Receivable']) dataContext += `æ‡‰æ”¶å¸³æ¬¾: ${m['Accounts Receivable'].join(', ')} \n`;
                if (m['Accounts Payable']) dataContext += `æ‡‰ä»˜å¸³æ¬¾: ${m['Accounts Payable'].join(', ')} \n`;

                dataContext += targetCCCText;
                dataContext += compCCCText;

                dataContext += `\nâœ… è«‹ç›´æ¥ä½¿ç”¨ä¸Šè¿°ç«¶çˆ­å°æ‰‹æ•¸æ“šé€²è¡Œæ¯”è¼ƒåˆ†æã€‚`;
            } else {
                dataContext += targetCCCText;
                dataContext += `\nâš ï¸ æ³¨æ„ï¼šStage 1 æœªæä¾›ç«¶çˆ­å°æ‰‹æ•¸æ“šï¼Œè«‹ä½¿ç”¨æ‚¨çš„çŸ¥è­˜åº«é€²è¡Œç”¢æ¥­å¹³å‡æ¯”è¼ƒã€‚`;
            }

            return `${dataContext}

            è«‹é€²è¡Œã€Œç«¶çˆ­å°æ‰‹æ¨™ç«¿åˆ†æã€ã€‚

** ğŸ¯ CRITICAL - å…¬å¸è­˜åˆ¥ **:
            - ç›®æ¨™å…¬å¸ï¼ˆè²´å…¬å¸ï¼‰: ${targetCompanyName}
            - ç«¶çˆ­å°æ‰‹: ${competitorCompanyName}
            - æ‰€æœ‰åˆ†æå¿…é ˆä»¥ã€Œ${targetCompanyName}ã€ç‚ºä¸»é«”ï¼ˆè²´å…¬å¸è¦–è§’ï¼‰
            - åœ¨ strategic_gap ä¸­ï¼Œå¿…é ˆä»¥ã€Œ${targetCompanyName}ï¼ˆè²´å…¬å¸ï¼‰ã€çš„è§’åº¦åˆ†æ

                ** ğŸ“Š æŒ‡æ¨™è¨ˆç®—å…¬å¼ **:
è«‹ä½¿ç”¨ Index 0ï¼ˆæœ€æ–° YTD æœŸé–“ï¼‰çš„æ•¸æ“šè¨ˆç®—ä»¥ä¸‹æŒ‡æ¨™ï¼š

            1. ** æ¯›åˆ©ç‡ ** = (Gross Profit / Revenue) Ã— 100 %
                2. ** ç‡Ÿç›Šç‡ ** = (Operating Income / Revenue) Ã— 100 %
                    3. ** æ·¨åˆ©ç‡ ** = (Net Income / Revenue) Ã— 100 %
                        4. ** OPEXç‡ ** = (Operating Expenses / Revenue) Ã— 100 %
                            5. ** ROE ** = (Net Income / Total Equity) Ã— 100 %
                                6. ** ROA ** = (Net Income / Total Assets) Ã— 100 %
                                    7. ** è³‡ç”¢å‘¨è½‰ç‡ ** = Revenue / Total Assets
            8. ** æ¬Šç›Šä¹˜æ•¸(Leverage) ** = Total Assets / Total Equity
            
            âš ï¸ **DSO/DIO/DPO/CCC è«‹ç›´æ¥ä½¿ç”¨ä¸Šæ–¹æä¾›çš„é è¨ˆç®—å€¼ï¼Œä¸è¦è‡ªå·±è¨ˆç®—ï¼**
            - ç›®æ¨™å…¬å¸çš„ DSO/DIO/DPO/CCC å·²åœ¨ä¸Šæ–¹ã€Œç›®æ¨™å…¬å¸æ•ˆç‡æŒ‡æ¨™ã€ä¸­æä¾›
            - ç«¶çˆ­å°æ‰‹çš„ DSO/DIO/DPO/CCC å·²åœ¨ä¸Šæ–¹ã€Œç«¶çˆ­å°æ‰‹æ•ˆç‡æŒ‡æ¨™ã€ä¸­æä¾›
            - è«‹å°‡é€™äº›æ•¸å€¼ç›´æ¥å¡«å…¥æ¯”è¼ƒè¡¨æ ¼çš„å°æ‡‰æ¬„ä½

                ** âš ï¸ æ•¸æ“šè™•ç†è¦å‰‡ **:
            1. **CRITICAL**: ä¸Šæ–¹å·²æä¾›å®Œæ•´çš„ç«¶çˆ­å°æ‰‹æ•¸æ“šï¼ˆåŒ…å« Revenue, Cost of Goods Sold, Inventory, Accounts Receivable, Accounts Payable ç­‰ï¼‰
            2. **DSO/DIO/DPO/CCC å·²é å…ˆè¨ˆç®—å®Œæˆï¼Œè«‹ç›´æ¥ä½¿ç”¨ï¼Œä¸è¦é‡æ–°è¨ˆç®—**
            3. å¦‚æœæŸé …æ•¸æ“šç¼ºå¤±ï¼Œè«‹æ¨™è¨» "N/A"
            4. åœ¨ "target" æ¬„ä½å¡«å…¥ ${targetCompanyName} çš„æ•¸æ“š
            5. åœ¨ "competitor" æ¬„ä½å¡«å…¥ ${competitorCompanyName} çš„æ•¸æ“š

è¼¸å‡º JSON:
            {
                "target_company": "${targetCompanyName}",
                    "competitor": "${competitorCompanyName}",
                        "comparison": [
                            { "metric": "æ¯›åˆ©ç‡", "target": "XX.X%", "competitor": "XX.X%", "gap": "é ˜å…ˆ/è½å¾Œ", "status": "æ­£å¸¸" },
                            { "metric": "ç‡Ÿç›Šç‡", "target": "XX.X%", "competitor": "XX.X%", "gap": "é ˜å…ˆ/è½å¾Œ", "status": "æ­£å¸¸" },
                            { "metric": "æ·¨åˆ©ç‡", "target": "XX.X%", "competitor": "XX.X%", "gap": "é ˜å…ˆ/è½å¾Œ", "status": "æ­£å¸¸" },
                            { "metric": "OPEXç‡", "target": "XX.X%", "competitor": "XX.X%", "gap": "é ˜å…ˆ/è½å¾Œ", "status": "æ­£å¸¸" },
                            { "metric": "ROE", "target": "XX.X%", "competitor": "XX.X%", "gap": "é ˜å…ˆ/è½å¾Œ", "status": "æ­£å¸¸" },
                            { "metric": "ROA", "target": "XX.X%", "competitor": "XX.X%", "gap": "é ˜å…ˆ/è½å¾Œ", "status": "æ­£å¸¸" },
                            { "metric": "è³‡ç”¢å‘¨è½‰ç‡", "target": "X.XX", "competitor": "X.XX", "gap": "é ˜å…ˆ/è½å¾Œ", "status": "æ­£å¸¸" },
                            { "metric": "æ¬Šç›Šä¹˜æ•¸", "target": "X.XX", "competitor": "X.XX", "gap": "é ˜å…ˆ/è½å¾Œ", "status": "æ­£å¸¸" },
                            { "metric": "DSO (æ‡‰æ”¶å¤©æ•¸)", "target": "XXå¤©", "competitor": "XXå¤©", "gap": "é•·/çŸ­", "status": "æ­£å¸¸" },
                            { "metric": "DIO (å­˜è²¨å¤©æ•¸)", "target": "XXå¤©", "competitor": "XXå¤©", "gap": "é•·/çŸ­", "status": "æ­£å¸¸" },
                            { "metric": "DPO (æ‡‰ä»˜å¤©æ•¸)", "target": "XXå¤©", "competitor": "XXå¤©", "gap": "é•·/çŸ­", "status": "æ­£å¸¸" },
                            { "metric": "CCC (ç¾é‡‘å¾ªç’°)", "target": "XXå¤©", "competitor": "XXå¤©", "gap": "é•·/çŸ­", "status": "æ­£å¸¸" }
                        ],
                            "strategic_gap": "åŸºæ–¼ä¸Šè¿°æ¯”è¼ƒè¡¨æ ¼ï¼ˆTarget vs Competitor æ•¸æ“šå‡å·²æä¾›ï¼‰ï¼Œä»¥ ${targetCompanyName}ï¼ˆè²´å…¬å¸ï¼‰çš„è¦–è§’åˆ†æèˆ‡ ${competitorCompanyName} çš„ç«¶çˆ­å·®è·ï¼Œæä¾›å…·é«”ç­–ç•¥å»ºè­°..."
            } `;
        }

        // --- Renderers ---
        // Helper to format text: convert \n to <br> for HTML display
        function formatText(text) {
            if (!text) return '';
            return text.replace(/\\n/g, '<br>').replace(/\n/g, '<br>');
        }

        function renderAnalysisCard(id, data) {
            console.log(`Rendering ${id}: `, JSON.stringify(data, null, 2)); // Debug log

            const div = document.createElement('div');
            div.className = 'bg-white p-6 rounded-xl border-l-4 border-michigan-blue card-shadow';

            // Get current period for display
            const currentPeriod = diagnosisData.financials?.years?.[0] || '';
            const modelName = availableModels.find(m => m.id === id).name;
            const titleWithPeriod = currentPeriod ? `${modelName}: ${currentPeriod}` : modelName;

            let content = `<h3 class="text-xl font-bold text-michigan-blue mb-4">${titleWithPeriod}</h3>`;

            // Helper to handle potential object values from AI
            const safeRender = (val) => {
                if (val === undefined || val === null) return '-';
                if (typeof val === 'object') {
                    // Try common keys first
                    if (val.value !== undefined) return safeRender(val.value);
                    if (val.amount !== undefined) return safeRender(val.amount);
                    if (val.text !== undefined) return safeRender(val.text);
                    if (val.content !== undefined) return safeRender(val.content);

                    // Handle Year Comparison (e.g., "2023", "2024") or other keys
                    const keys = Object.keys(val);
                    if (keys.length > 0) {
                        // Try to find a reasonable key
                        const firstKey = keys[0];
                        return `${safeRender(val[firstKey])} <span class="text-xs text-gray-400">(${firstKey})</span>`;
                    }

                    // Last resort: stringify
                    return `<span class="text-xs text-red-600">Error: ${JSON.stringify(val).substring(0, 50)}...</span>`;
                }
                return val;
            };

            if (id === 'dupont') {
                content += `<div class="grid grid-cols-3 gap-4 text-center mb-4">
                    <div class="p-3 bg-blue-50 rounded"><h4>æ·¨åˆ©ç‡</h4><div class="text-2xl font-bold">${safeRender(data.breakdown.net_profit_margin.value)}</div><div class="text-sm">${safeRender(data.breakdown.net_profit_margin.status)}</div></div>
                    <div class="p-3 bg-blue-50 rounded"><h4>è³‡ç”¢é€±è½‰</h4><div class="text-2xl font-bold">${safeRender(data.breakdown.asset_turnover.value)}</div><div class="text-sm">${safeRender(data.breakdown.asset_turnover.status)}</div></div>
                    <div class="p-3 bg-blue-50 rounded"><h4>æ¬Šç›Šä¹˜æ•¸</h4><div class="text-2xl font-bold">${safeRender(data.breakdown.equity_multiplier.value)}</div><div class="text-sm">${safeRender(data.breakdown.equity_multiplier.status)}</div></div>
                </div>
                <div class="p-4 bg-michigan-maize-lightest rounded border border-michigan-maize"><strong>ROE: ${safeRender(data.roe)}</strong><p class="text-sm mt-2 text-justify leading-relaxed">${safeRender(data.summary_insight)}</p></div>`;
            } else if (id === 'solvency' || id === 'liquidity' || id === 'profitability') {
                const items = data.metrics || data.margins;
                content += `<div class="space-y-4">${items.map(i => `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <div><span class="font-bold text-lg text-gray-800">${i.name}</span> <span class="text-sm text-gray-500 ml-2">(${i.benchmark || i.trend || ''})</span></div>
                            <div class="font-bold text-xl text-michigan-blue">${i.value}</div>
                        </div>
                        <div class="text-sm text-gray-600 leading-relaxed text-justify border-t border-gray-200 pt-2 mt-2">
                            ${formatText(i.status || i.insight)}
                        </div>
                    </div>`).join('')
                    }</div>
                <p class="mt-4 text-sm text-gray-700 bg-blue-50 p-3 rounded border border-blue-100">${formatText(data.solvency_assessment || data.overall_profitability)}</p>`;
            } else if (id === 'cashflow') {
                const f = data.flows;
                content += `
                    <div class="mb-4 bg-gradient-to-r from-indigo-50 to-blue-50 p-4 rounded-lg border-2 border-indigo-200">
                    <h4 class="font-bold text-indigo-800 mb-2">ğŸ“Š EBITDA åˆ†æ</h4>
                    <p class="text-sm text-gray-700">${formatText(data.ebitda_analysis) || 'N/A'}</p>
                </div >
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="p-3 bg-green-50 rounded border border-green-200">
                        <h4 class="font-bold text-green-800">ç‡Ÿé‹ç¾é‡‘æµ</h4>
                        <div class="text-xl font-bold my-1">${f?.operating?.status || '-'}</div>
                        <p class="text-xs text-gray-600">${formatText(f?.operating?.comment) || ''}</p>
                    </div>
                    <div class="p-3 bg-yellow-50 rounded border border-yellow-200">
                        <h4 class="font-bold text-yellow-800">æŠ•è³‡ç¾é‡‘æµ</h4>
                        <div class="text-xl font-bold my-1">${f?.investing?.status || '-'}</div>
                        <p class="text-xs text-gray-600">${formatText(f?.investing?.comment) || ''}</p>
                    </div>
                    <div class="p-3 bg-purple-50 rounded border border-purple-200">
                        <h4 class="font-bold text-purple-800">ç±Œè³‡ç¾é‡‘æµ</h4>
                        <div class="text-xl font-bold my-1">${f?.financing?.status || '-'}</div>
                        <p class="text-xs text-gray-600">${formatText(f?.financing?.comment) || ''}</p>
                    </div>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="bg-gray-50 p-3 rounded"><strong>è‡ªç”±ç¾é‡‘æµ (FCF):</strong> ${formatText(data.fcf_analysis)}</div>
                    <div class="bg-gray-50 p-3 rounded"><strong>ç¾é‡‘è½‰æ›å¾ªç’° (CCC):</strong> ${formatText(data.ccc_analysis)}</div>
                </div>`;
            } else if (id === 'cost_structure') {
                content += `<div class="mb-4">
                    <h4 class="font-bold text-gray-700 mb-2">å›ºå®š vs è®Šå‹•æˆæœ¬ & æç›Šå…©å¹³</h4>
                    <p class="text-sm bg-gray-50 p-3 rounded mb-2 leading-relaxed">${formatText(data.fixed_vs_variable)}</p>
                    <p class="text-sm bg-blue-50 p-3 rounded text-blue-800 leading-relaxed">${formatText(data.break_even_analysis)}</p>
                </div>
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">æˆæœ¬å„ªåŒ–æ©Ÿæœƒ</h4>
                        <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                            ${data.cost_reduction_opportunities.map(op => `<li>${op}</li>`).join('')}
                        </ul>
                    </div>`;
            } else if (id === 'benchmarking') {
                const targetName = data.target_company || 'æˆ‘æ–¹';
                const competitorName = data.competitor || data.competitor_name || 'ç«¶çˆ­å°æ‰‹';

                content += `<div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-gray-700">æ¨™ç«¿åˆ†ææ¯”è¼ƒ</h4>
                        <span class="text-xs text-gray-500">å–®ä½: ç™¾åˆ†æ¯” / æ¬¡æ•¸ / å¤©æ•¸</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 text-gray-600">
                                <tr>
                                    <th class="p-2 whitespace-nowrap">æŒ‡æ¨™</th>
                                    <th class="p-2 whitespace-nowrap text-blue-700">${targetName}</th>
                                    <th class="p-2 whitespace-nowrap text-red-700">${competitorName}</th>
                                    <th class="p-2 whitespace-nowrap">å·®ç•°</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.comparison.map(c => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-2 font-medium">${c.metric}</td>
                                    <td class="p-2 font-bold text-blue-800">${c.target || c.us || '-'}</td>
                                    <td class="p-2 font-bold text-red-800">${c.competitor || c.them || '-'}</td>
                                    <td class="p-2">
                                        <span class="${(c.gap || c.diff || '').includes('è½å¾Œ') ? 'text-red-600 bg-red-50 px-2 py-1 rounded' : 'text-green-600 bg-green-50 px-2 py-1 rounded'}">
                                            ${c.gap || c.diff || '-'}
                                        </span>
                                        ${c.status && c.status !== 'æ­£å¸¸' ? `<div class="text-xs text-gray-400 mt-1">${c.status}</div>` : ''}
                                    </td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div >
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 text-sm">
                        <strong class="text-yellow-800 block mb-2">ğŸ’¡ æˆ°ç•¥ç¼ºå£èˆ‡å»ºè­°:</strong>
                        <div class="text-gray-700 leading-relaxed">${formatText(data.strategic_gap)}</div>
                    </div>`;
            } else {
                // Generic JSON render for others
                content += `< pre class="text-xs bg-gray-100 p-4 rounded overflow-x-auto" > ${JSON.stringify(data, null, 2)}</pre > `;
            }

            div.innerHTML = content;
            document.getElementById('analysis-dashboard').appendChild(div);
        }

        // --- Innovation/Strategy ---
        async function showInnovationTab(tab) {
            document.querySelectorAll('.innovation-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.innovation-tab[data-tab="${tab}"]`).classList.add('active');

            document.querySelectorAll('.innovation-content').forEach(c => {
                c.classList.add('hidden');
                c.classList.remove('active'); // Ensure active class is removed to prevent CSS conflicts
            });
            const targetPanel = document.getElementById(`innovation-content-${tab}`);
            if (targetPanel) {
                targetPanel.classList.remove('hidden');
                targetPanel.classList.add('active');
            }

            // Auto-trigger analysis if data is missing
            if (!diagnosisData[tab]) {
                await generateStrategy(tab);
            } else {
                renderStrategy(tab, diagnosisData[tab]);
            }
        }

        async function generateStrategy(type) {
            showLoading(`æ­£åœ¨ç”Ÿæˆ ${type} ç­–ç•¥...`);

            // Build context with pre-calculated metrics to prevent AI from using stale values
            let metricsContext = '';

            // Include CCC data if available
            const cccResults = diagnosisData.analysisResults?.cashflow;
            if (cccResults && cccResults.ccc_analysis) {
                // Extract DSO/DIO/DPO independently to be more robust
                const text = cccResults.ccc_analysis;
                const dsoMatch = text.match(/DSO.*?(\d+\.?\d*)/);
                const dioMatch = text.match(/DIO.*?(\d+\.?\d*)/);
                const dpoMatch = text.match(/DPO.*?(\d+\.?\d*)/);
                const cccMatch = text.match(/CCC.*?(-?\d+\.?\d*)/); // Allow negative CCC

                if (dsoMatch || dioMatch || dpoMatch || cccMatch) {
                    metricsContext += `\n** Pre-Calculated Working Capital Metrics (MUST USE THESE EXACT VALUES) **:\n`;
                    if (dsoMatch) metricsContext += `- DSO (æ‡‰æ”¶å¸³æ¬¾å¤©æ•¸): ${dsoMatch[1]} å¤©\n`;
                    if (dioMatch) metricsContext += `- DIO (å­˜è²¨å¤©æ•¸): ${dioMatch[1]} å¤©\n`;
                    if (dpoMatch) metricsContext += `- DPO (æ‡‰ä»˜å¸³æ¬¾å¤©æ•¸): ${dpoMatch[1]} å¤©\n`;
                    if (cccMatch) metricsContext += `- CCC (ç¾é‡‘è½‰æ›å¾ªç’°): ${cccMatch[1]} å¤©\n`;
                    metricsContext += `âš ï¸ DO NOT recalculate these values. Use exactly as provided above.\n\n`;
                }
            }

            // Include ROE and margins if available
            const dupontResults = diagnosisData.analysisResults?.dupont;
            if (dupontResults && dupontResults.roe) {
                metricsContext += `** Pre-Calculated Profitability Metrics (MUST USE THESE EXACT VALUES) **:\n`;
                metricsContext += `- ROE: ${dupontResults.roe}\n`;
                if (dupontResults.breakdown) {
                    metricsContext += `- Net Margin: ${dupontResults.breakdown.net_profit_margin?.value || 'N/A'}\n`;
                    metricsContext += `- Asset Turnover: ${dupontResults.breakdown.asset_turnover?.value || 'N/A'}\n`;
                    metricsContext += `- Equity Multiplier: ${dupontResults.breakdown.equity_multiplier?.value || 'N/A'}\n`;
                }
                metricsContext += `âš ï¸ DO NOT recalculate these values. Use exactly as provided above.\n\n`;
            }

            const prompts = {
                'capital_structure': 'è«‹æä¾›è³‡æœ¬çµæ§‹å„ªåŒ–å»ºè­° (å‚µå‹™/è‚¡æ¬Šèè³‡æ¯”ä¾‹, è³‡é‡‘æˆæœ¬ WACC å„ªåŒ–)ã€‚',
                'cost_optimization': 'è«‹é‹ç”¨é›¶åŸºé ç®— (ZBB) ç²¾ç¥ï¼Œæä¾›å…·é«”çš„æˆæœ¬å„ªåŒ–èˆ‡å‰Šæ¸›å»ºè­°ã€‚',
                'risk_management': 'è«‹è­˜åˆ¥ä¸»è¦è²¡æœƒé¢¨éšª (åŒ¯ç‡, åˆ©ç‡, ä¿¡ç”¨) ä¸¦æä¾›é¿éšªå»ºè­°ã€‚',
                'tax_planning': 'è«‹æä¾›åˆæ³•çš„ç¨…å‹™è¦åŠƒèˆ‡ç¯€ç¨…æ©Ÿæœƒå»ºè­°ã€‚',
                'ma_strategy': 'è«‹åˆ†ææ½›åœ¨çš„ä½µè³¼ (M&A) æˆ–éæ ¸å¿ƒè³‡ç”¢æ’¤è³‡ (Divestiture) æ©Ÿæœƒã€‚'
            };

            try {
                const prompt = `${getBaseContext()}
                
${metricsContext}
åŸºæ–¼ä»¥ä¸Šè²¡æœƒæ•¸æ“šèˆ‡é è¨ˆç®—æŒ‡æ¨™ï¼Œ${prompts[type]}

**CRITICAL**:
- å¦‚æœä¸Šæ–¹æä¾›äº† DSO/DIO/DPO/CCC ç­‰æ•¸å€¼ï¼Œä½ å¿…é ˆä½¿ç”¨é€™äº›ç²¾ç¢ºå€¼
- ä¸è¦è‡ªå·±é‡æ–°è¨ˆç®—æˆ–ä½¿ç”¨å…¶ä»–æ•¸å€¼
- æ‰€æœ‰æåŠé€™äº›æŒ‡æ¨™çš„åœ°æ–¹å¿…é ˆä¿æŒä¸€è‡´

è¼¸å‡º JSON: { "suggestions": [{ "title": "...", "action": "...", "impact": "..." }], "summary": "..." }`;

                const res = await callAI(prompt);
                const json = safeJSONParse(res);
                diagnosisData[type] = json;
                renderStrategy(type, json);
            } catch (e) {
                console.error(e);
            }
            hideLoading();
        }

        function renderStrategy(type, data) {
            // Map strategy type to the actual result container ID
            const containerMap = {
                'capital_structure': 'capital-structure-result',
                'cost_optimization': 'cost-optimization-result',
                'risk_management': 'risk-management-result',
                'tax_planning': 'tax-planning-result',
                'ma_strategy': 'ma-strategy-result'
            };

            const containerId = containerMap[type];
            const container = document.getElementById(containerId);

            if (!container) {
                console.error(`Container not found for type: ${type}, expected ID: ${containerId}`);
                return;
            }

            if (!data.suggestions) {
                container.innerHTML = '<p class="text-gray-500">ç„¡å»ºè­°</p>';
                return;
            }

            container.innerHTML = `<div class="bg-michigan-maize-lightest p-4 rounded mb-4">${formatText(data.summary)}</div>` +
                data.suggestions.map(s => `
                <div class="bg-white p-4 rounded border border-gray-200 shadow-sm mb-3">
                    <h4 class="font-bold text-michigan-blue">${s.title}</h4>
                    <p class="text-sm text-gray-700 mt-1">${formatText(s.action)}</p>
                    <div class="mt-2 text-xs bg-green-50 text-green-800 inline-block px-2 py-1 rounded">é æœŸå½±éŸ¿: ${s.impact}</div>
                </div>`).join('');
        }

        async function autoRunAll() {
            const tabs = ['capital_structure', 'cost_optimization', 'risk_management', 'tax_planning', 'ma_strategy'];
            const statusEl = document.getElementById('autoRunStatus');

            for (let i = 0; i < tabs.length; i++) {
                const t = tabs[i];

                // Skip if data already exists
                if (diagnosisData[t]) {
                    statusEl.textContent = `è·³é ${i + 1}/${tabs.length}: ${t} (å·²å­˜åœ¨)...`;
                    console.log(`[INFO] Skipping ${t} - data already exists.`);
                    // Just show the tab, don't re-generate
                    // We don't even need to call showInnovationTab if we don't want to switch view, 
                    // but calling it ensures the UI is consistent if the user is watching.
                    // However, to be fast, we might just want to ensure data exists.
                    // Let's stick to the plan: showInnovationTab handles the check.
                    // BUT wait, showInnovationTab switches the UI tab. 
                    // If we want to "Run All", we probably just want to generate data in background or sequence.
                    // The user asked to "check if module has run".

                    // If we call showInnovationTab, it switches the active tab.
                    // Let's just call it, it's fine to cycle through them visually.
                    await showInnovationTab(t);
                } else {
                    statusEl.textContent = `æ­£åœ¨åŸ·è¡Œ ${i + 1}/${tabs.length}: ${t}...`;
                    await showInnovationTab(t);
                    // showInnovationTab calls generateStrategy internally if missing
                }
            }

            statusEl.textContent = 'âœ… æ‰€æœ‰ç­–ç•¥åˆ†æå®Œæˆï¼';
        }

        // --- Report ---
        function renderFinalReport() {
            const container = document.getElementById('report-content');
            if (!container) return;

            const ctx = diagnosisData.context;
            let html = `
                <div class="mb-8 text-center">
                    <h2 class="text-3xl font-bold text-michigan-blue mb-2">è²¡æœƒ æˆ°ç•¥è¨ºæ–·å ±å‘Š</h2>
                    <p class="text-gray-600">ç”Ÿæˆæ—¥æœŸ: ${new Date().toLocaleDateString()}</p>
                </div >

                <div class="mb-8">
                    <h3 class="text-xl font-bold text-michigan-blue border-b-2 border-michigan-maize pb-2 mb-4">1. ä¼æ¥­æ¦‚æ³</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>ç”¢æ¥­:</strong> ${ctx.industry || '-'}</div>
                        <div><strong>è¦æ¨¡:</strong> ${ctx.companySize || '-'}</div>
                        <div><strong>ä»£è™Ÿ:</strong> ${ctx.ticker || '-'}</div>
                        <div><strong>æ ¸å¿ƒå•é¡Œ:</strong> ${ctx.problem || '-'}</div>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xl font-bold text-michigan-blue border-b-2 border-michigan-maize pb-2 mb-4">1.5 é—œéµè²¡å‹™æ•¸æ“š (Stage 1)</h3>
                        <table class="min-w-full text-xs border-collapse table-auto">
                            <thead>
                                <tr class="bg-gray-100 border-b border-gray-300">
                                    <th class="p-2 text-left whitespace-nowrap">é …ç›®</th>
                                    <th class="p-2 text-right text-blue-800 font-bold" colspan="2">ç›®æ¨™å…¬å¸</th>
                                    <th class="p-2 text-right text-red-800 font-bold" colspan="2">ç«¶çˆ­å°æ‰‹</th>
                                </tr>
                                <tr class="bg-gray-50 border-b border-gray-200">
                                    <th class="p-2"></th>
                                    ${(diagnosisData.financials?.years || ['-', '-']).map(y => `<th class="p-2 text-right whitespace-nowrap">${y}</th>`).join('')}
                                    ${(diagnosisData.competitorFinancials?.years || ['-', '-']).map(y => `<th class="p-2 text-right whitespace-nowrap">${y}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${(() => {
                    const targetM = diagnosisData.financials?.metrics || {};
                    const compM = diagnosisData.competitorFinancials?.metrics || {};
                    const allKeys = new Set([...Object.keys(targetM), ...Object.keys(compM)]);
                    const tCurr = detectCurrency(diagnosisData.financials);
                    const cCurr = detectCurrency(diagnosisData.competitorFinancials);

                    // Check if currencies are the same (fuzzy match)
                    const isTWD = (c) => c && (c.includes('TWD') || c.includes('NTD') || c.includes('æ–°å°å¹£') || c.includes('å°å¹£'));
                    const isUSD = (c) => c && (c.includes('USD') || c.includes('ç¾é‡‘') || c.includes('ç¾å…ƒ'));
                    const isCNY = (c) => c && (c.includes('CNY') || c.includes('RMB') || c.includes('äººæ°‘å¹£'));

                    let sameCurrency = false;
                    if (tCurr === cCurr) {
                        sameCurrency = true;
                    } else if (isTWD(tCurr) && isTWD(cCurr)) {
                        sameCurrency = true;
                    } else if (isUSD(tCurr) && isUSD(cCurr)) {
                        sameCurrency = true;
                    } else if (isCNY(tCurr) && isCNY(cCurr)) {
                        sameCurrency = true;
                    }

                    const targetOnly = tCurr && !cCurr;
                    const unifiedCurrency = sameCurrency ? tCurr : (targetOnly ? tCurr : null);

                    let rows = '';

                    // Add unified currency header if applicable
                    if (unifiedCurrency) {
                        rows += `
                            <tr class="bg-gradient-to-r from-amber-50 to-yellow-50">
                                <td colspan="5" class="p-2 text-center text-xs font-semibold text-amber-800">
                                    ğŸ“Š å–®ä½ (Unit): ${unifiedCurrency}
                                </td>
                            </tr>
                        `;
                    }

                    // Format value - don't show currency in each cell if unified
                    const formatVal = (val, curr, metricKey) => {
                        if (val === null || val === undefined) return '-';
                        const formatted = new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(val);

                        // EPS is already in å…ƒ (not thousands)
                        if (metricKey === 'EPS') {
                            return `${formatted} <span class="text-[9px] text-gray-500">(å…ƒ)</span>`;
                        }

                        // Only show currency if not unified
                        return (!unifiedCurrency && curr) ? `${formatted} <span class="text-[9px] text-gray-400">${curr}</span>` : formatted;
                    };

                    // Define preferred order of metrics (Same as Step 1)
                    const metricOrder = [
                        'Revenue',
                        'Cost of Goods Sold',
                        'Gross Profit',
                        'Operating Expenses',
                        'Operating Income',
                        'Net Income',
                        'EPS',
                        'Total Assets',
                        'Total Liabilities',
                        'Total Equity',
                        'Inventory',
                        'Accounts Receivable',
                        'Accounts Payable',
                        'Operating Cash Flow',
                        'Investing Cash Flow',
                        'Financing Cash Flow',
                        'Depreciation',
                        'Amortization'
                    ];

                    // Sort keys, ONLY show items in metricOrder
                    const sortedKeys = Array.from(allKeys)
                        .filter(key => metricOrder.indexOf(key) !== -1)  // Only include keys in metricOrder
                        .sort((a, b) => {
                            const aIndex = metricOrder.indexOf(a);
                            const bIndex = metricOrder.indexOf(b);
                            return aIndex - bIndex;
                        });

                    rows += sortedKeys.map((key, idx) => {
                        // Explicitly hide Total Equity_Beg
                        if (key === 'Total Equity_Beg') return '';

                        const tVals = targetM[key] || [null, null];
                        const cVals = compM[key] || [null, null];
                        const bgClass = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                        return `
                                            <tr class="${bgClass} border-b border-gray-100 hover:bg-gray-100">
                                                <td class="p-2 font-medium text-gray-700 whitespace-nowrap">${key}</td>
                                                ${tVals.map(v => `<td class="p-2 text-right text-blue-700 whitespace-nowrap">${formatVal(v, tCurr, key)}</td>`).join('')}
                                                ${cVals.map(v => `<td class="p-2 text-right text-red-700 whitespace-nowrap">${formatVal(v, cCurr, key)}</td>`).join('')}
                                            </tr>
                                        `;
                    }).join('');

                    return rows;
                })()}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xl font-bold text-michigan-blue border-b-2 border-michigan-maize pb-2 mb-4">2. è²¡æœƒè¨ºæ–·æ‘˜è¦</h3>
                    <div class="space-y-4">
            `;

            // Aggregate Analysis Results
            if (diagnosisData.analysisResults) {
                for (const [modelId, data] of Object.entries(diagnosisData.analysisResults)) {
                    const modelName = availableModels.find(m => m.id === modelId)?.name || modelId;
                    let summary = '';

                    // Extract key insights based on model type
                    if (modelId === 'dupont') summary = `ROE: ${data.roe || '-'}ã€‚${data.summary_insight || ''}`;
                    else if (modelId === 'solvency') summary = data.solvency_assessment || 'è©³è¦‹è©³ç´°åˆ†æ';
                    else if (modelId === 'profitability') summary = data.overall_profitability || 'è©³è¦‹è©³ç´°åˆ†æ';
                    else if (modelId === 'cashflow') summary = `FCF: ${data.fcf_analysis || '-'}ã€‚${data.ccc_analysis || ''}`;
                    else if (modelId === 'cost_structure') summary = data.fixed_vs_variable || 'è©³è¦‹è©³ç´°åˆ†æ';
                    else if (modelId === 'benchmarking') summary = `æˆ°ç•¥ç¼ºå£: ${data.strategic_gap || '-'}`;

                    html += `
                        <div class="bg-gray-50 p-4 rounded border-l-4 border-michigan-blue pdf-avoid-break">
                            <h4 class="font-bold text-lg mb-2">${modelName}</h4>
                            <p class="text-sm text-gray-700">${summary.replace(/\\n/g, '<br>').replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                }
            } else {
                html += `<p class="text-gray-500 italic">å°šç„¡è²¡æœƒåˆ†ææ•¸æ“šã€‚</p>`;
            }

            html += `
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xl font-bold text-michigan-blue border-b-2 border-michigan-maize pb-2 mb-4">3. æˆ°ç•¥è¡Œå‹•å»ºè­°</h3>
                    <div class="space-y-4">
            `;

            // Aggregate Strategy Suggestions
            const strategyTypes = ['capital_structure', 'cost_optimization', 'risk_management', 'tax_planning', 'ma_strategy'];
            let hasStrategy = false;
            strategyTypes.forEach(type => {
                if (diagnosisData[type] && diagnosisData[type].suggestions) {
                    hasStrategy = true;
                    const titleMap = {
                        'capital_structure': 'è³‡æœ¬çµæ§‹', 'cost_optimization': 'æˆæœ¬å„ªåŒ–',
                        'risk_management': 'é¢¨éšªç®¡ç†', 'tax_planning': 'ç¨…å‹™è¦åŠƒ', 'ma_strategy': 'ä½µè³¼èˆ‡æ’¤è³‡'
                    };
                    html += `<h4 class="font-bold text-michigan-blue mt-4 mb-2">${titleMap[type]}</h4>`;
                    diagnosisData[type].suggestions.forEach(s => {
                        html += `
                            <div class="bg-white border border-gray-200 p-3 rounded mb-2 shadow-sm pdf-avoid-break">
                                <div class="font-bold text-gray-800">${s.title}</div>
                                <div class="text-sm text-gray-600">${formatText(s.action)}</div>
                                <div class="text-xs text-green-700 mt-1">é æœŸå½±éŸ¿: ${formatText(s.impact)}</div>
                            </div>
                        `;
                    });
                }
            });

            if (!hasStrategy) {
                html += `<p class="text-gray-500 italic">å°šç„¡æˆ°ç•¥å»ºè­° (è«‹åœ¨éšæ®µ 4 ç”Ÿæˆ)ã€‚</p>`;
            }

            html += `
                    </div>
                </div>
                
                <div class="text-center text-sm text-gray-500 mt-12 border-t pt-4">
                    <p>æœ¬å ±å‘Šç”± AI è¼”åŠ©ç”Ÿæˆï¼Œåƒ…ä¾›æ±ºç­–åƒè€ƒã€‚</p>
                </div>
            `;

            container.innerHTML = html;
        }

        function generateReport() {
            const element = document.getElementById('report-content');

            if (typeof html2pdf === 'undefined') {
                alert('PDF ç”Ÿæˆå…ƒä»¶å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦ï¼Œæˆ–ä½¿ç”¨ã€Œåˆ—å° / å¦å­˜ PDF (å‚™ç”¨)ã€åŠŸèƒ½ã€‚');
                return;
            }

            // Show loading state
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'â³ ç”Ÿæˆä¸­...';
            btn.disabled = true;

            // Optimized options
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `CFO_Strategy_Report_${new Date().toISOString().slice(0, 10)}.pdf`,
                image: { type: 'jpeg', quality: 0.95 }, // Slightly lower quality for speed
                html2canvas: {
                    scale: 1.5, // Reduced from 2 to 1.5 to save memory
                    useCORS: true,
                    letterRendering: true,
                    logging: false
                },
                jsPDF: {
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'portrait',
                    compress: true
                },
                pagebreak: {
                    mode: ['css', 'legacy'],
                    avoid: ['.pdf-avoid-break', 'tr', 'h3']
                }
            };

            // Use html2pdf to generate and download
            html2pdf().set(opt).from(element).save()
                .then(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    // alert('PDF ä¸‹è¼‰å·²é–‹å§‹ï¼'); // Optional: Don't annoy user if it works
                })
                .catch(err => {
                    console.error('PDF Generation Error:', err);
                    alert('PDF ç”Ÿæˆå¤±æ•—ã€‚å»ºè­°ä½¿ç”¨æ—é‚Šçš„ã€Œåˆ—å° / å¦å­˜ PDF (å‚™ç”¨)ã€æŒ‰éˆ•ã€‚');
                    btn.textContent = originalText;
                    btn.disabled = false;
                });
        }

        // Init
        window.onload = () => {
            const container = document.getElementById('model-selection');
            availableModels.forEach(m => {
                container.innerHTML += `
                <div>
                <input type="checkbox" id="model-${m.id}" value="${m.id}" class="hidden model-checkbox" checked>
                    <label for="model-${m.id}" class="block border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:border-michigan-blue h-full">
                        <div class="font-bold text-lg mb-2">${m.name}</div>
                        <p class="text-sm text-gray-600">${m.description}</p>
                    </label>
                </div>`;
            });

            const s = getSettings();
            if (s.apiKey) document.getElementById('apiKey').value = s.apiKey;
        };
    </script>
</body>

</html>