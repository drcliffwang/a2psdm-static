<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IC å¾Œæ®µæœå‹™å ±åƒ¹å„€è¡¨æ¿</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com" crossorigin="anonymous"></script>
  <!-- React 18 UMD -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin="anonymous"></script>
  <!-- Babel for JSX in-browser transpile -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
  <!-- SheetJS for XLSX export (guarded in code) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js" crossorigin="anonymous"></script>
  <style>
    html, body, #root { height: 100%; margin: 0; padding: 0; background-color: #f8fafc; }
    /* subtle radial background for better aesthetics */
    body { background-image: radial-gradient(1200px 600px at 10% -10%, rgba(148,163,184,.15), transparent), radial-gradient(1000px 500px at 90% 10%, rgba(203,213,225,.2), transparent); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // --- Icons ---
    const Plus = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    );
    const Download = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
    );
    const RefreshCw = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
    );
    const Sparkles = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.9 5.8-5.8 1.9 5.8 1.9 1.9 5.8 1.9-5.8 5.8-1.9-5.8-1.9z"/></svg>
    );

    // --- UI Primitives ---
    const Card = ({ children, className = "" }) => (
      <div className={`bg-white border border-slate-200 rounded-2xl shadow-sm ${className}`}>{children}</div>
    );
    const CardHeader = ({ children }) => <div className="p-6 border-b border-slate-200">{children}</div>;
    const CardTitle = ({ children }) => <h3 className="text-lg font-semibold text-slate-800 flex items-center gap-2">{children}</h3>;
    const CardContent = ({ children, className = "" }) => <div className={`p-6 ${className}`}>{children}</div>;
    const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }) => {
      const base = "inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-150";
      const variants = { primary: 'bg-slate-800 text-white hover:bg-slate-700 focus:ring-slate-500', outline: 'border border-slate-300 bg-transparent hover:bg-slate-100 text-slate-700 focus:ring-slate-400' };
      return <button onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className} disabled:opacity-50 disabled:cursor-not-allowed`}>{children}</button>;
    };
    const Input = (props) => <input {...props} className={`block w-full px-3 py-2 text-sm border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-slate-500 focus:border-slate-500 ${props.className||''}`} />;
    const Label = ({ children, ...props }) => <label {...props} className="block text-sm font-medium text-slate-600">{children}</label>;
    const Select = ({ value, onChange, children }) => (
      <select value={value} onChange={onChange} className="block w-full px-3 py-2 text-sm bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-slate-500 focus:border-slate-500">
        {children}
      </select>
    );
    const Slider = ({ value, onChange, ...props }) => (
      <input type="range" value={value} onChange={e => onChange([Number(e.target.value)])} {...props} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
    );

    // --- Mini Bar Chart (pure HTML + Tailwind) ---
    const MiniBarChart = ({ data, fmt, title = 'å ±åƒ¹å°æ¯” (USD)' }) => {
      if (!data || data.length === 0) {
        return (
          <div className="w-full h-80 flex items-center justify-center text-sm text-slate-600">æ²’æœ‰è³‡æ–™å¯é¡¯ç¤º</div>
        );
      }
      const max = Math.max(...data.map(d => Number(d.USD) || 0)) || 1;
      const min = Math.min(...data.map(d => Number(d.USD) || 0)) || 0;
      const magnitude = Math.pow(10, Math.max(0, String(Math.floor(max)).length - 2));
      const displayMax = Math.ceil(max / magnitude) * magnitude;
      const gridSteps = 4; // 0%, 25%, 50%, 75%, 100%

      return (
        <div className="h-80 relative">
          {/* header */}
          <div className="flex items-end justify-between mb-2">
            <div className="text-sm font-medium text-slate-700">{title}</div>
            <div className="text-xs text-slate-500">å–®ä½ï¼šUSD</div>
          </div>
          {/* grid lines */}
          <div className="absolute inset-0 pointer-events-none">
            {[...Array(gridSteps + 1)].map((_, i) => (
              <div key={i} className="absolute left-0 right-0 border-t border-slate-200" style={{bottom: `${(i / gridSteps) * 100}%`}}>
                <div className="absolute -translate-y-1/2 left-1 text-[10px] text-slate-500">
                  ${fmt((displayMax * (i / gridSteps)), 0)}
                </div>
              </div>
            ))}
          </div>

          {/* bars */}
          <div className="absolute inset-x-0 bottom-0 top-6 flex items-end gap-3 px-4">
            {data.map((d, idx) => {
              const v = Number(d.USD) || 0;
              const h = Math.max(2, (v / displayMax) * 100);
              const isBest = v === min;
              return (
                <div key={idx} className="flex-1 flex flex-col items-center min-w-[72px]">
                  <div className="w-full bg-slate-200/70 rounded-t-md relative overflow-hidden" style={{height: `${h}%`, transition: 'height 320ms ease'}} aria-label={`${d.name} é‡‘é¡ ${fmt(v)} ç¾å…ƒ`}>
                    <div className={`absolute inset-x-0 bottom-0 h-full ${isBest ? 'bg-emerald-600' : 'bg-slate-600/80'} rounded-t-md hover:opacity-90`} title={`${d.name}: $${fmt(v)}`} style={{height: '100%', transition: 'opacity 150ms ease'}}></div>
                    <div className="absolute -top-5 left-1/2 -translate-x-1/2 text-[11px] font-semibold text-slate-800 whitespace-nowrap bg-white/70 px-1.5 rounded">${fmt(v)}</div>
                    {isBest && <span className="absolute -top-6 right-1 text-[10px] px-1.5 py-0.5 rounded-full bg-emerald-100 text-emerald-700 border border-emerald-200">Best</span>}
                  </div>
                  <div className="mt-2 text-[11px] text-center text-slate-600 leading-tight truncate w-full" title={d.name}>{d.name}</div>
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    // --- App ---
    function ICBackendQuotationDashboard() {
      const hasXLSX = typeof window.XLSX !== 'undefined';

      // Constants
      const COUNTRIES = ["Taiwan", "China", "United States", "Japan", "Malaysia", "Philippines", "Vietnam", "South Korea", "Thailand", "Singapore"];
      const SEGMENTS = ["AI Accelerator", "FPGA Vision", "Other"];
      const PACKAGES = ["FCBGA", "CoWoS-S", "CoWoS-L", "2.5D + Si Interposer", "FOPLP", "Fan-Out"];

      // Labels moved ABOVE all usage to avoid TDZ surprises
      const labelMap = {
        projectName: "å°ˆæ¡ˆåç¨±", customer: "å®¢æˆ¶", segment: "ç”¢å“åˆ¥", packageType: "å°è£å‹æ…‹",
        dieCount: "Die æ•¸", nodeNm: "è£½ç¨‹ç¯€é» (nm)", waferCostPerDie: "Wafer æˆæœ¬/Die (USD)",
        substrateCost: "åŸºæ¿æˆæœ¬ (USD)", interposerCost: "ä¸­ä»‹å±¤/Si Interposer (USD)",
        bumpingCost: "å‡¸é»/ééŒ« (USD)", assemblyCost: "çµ„è£æˆæœ¬ (USD)", testCost: "æ¸¬è©¦æˆæœ¬ (USD)",
        yieldWafer: "è‰¯ç‡-å‰æ®µ (%)", yieldAssembly: "è‰¯ç‡-çµ„è£ (%)", yieldFinal: "è‰¯ç‡-æœ€çµ‚ (%)",
        outboundLogistics: "å‡ºè²¨ç‰©æµ (USD)", insurance: "ä¿éšª (USD)", otherVariable: "å…¶ä»–è®Šå‹•è²» (USD)",
        fxTWDperUSD: "åŒ¯ç‡ TWD/USD", paymentTermsDays: "ä»˜æ¬¾æ¢ä»¶ (å¤©)", targetGM: "ç›®æ¨™æ¯›åˆ©ç‡ (%)",
        riskAddon: "é¢¨éšªåŠ æˆ (%)", incoterm: "Incoterm", hsCode: "HS Code",
        frontEndCountry: "å‰æ®µåœ‹åˆ¥", assemblyCountry: "å°è£åœ‹åˆ¥", testCountry: "æ¸¬è©¦åœ‹åˆ¥",
        shipToCountry: "å‡ºè²¨ç›®çš„åœ°", cooOverride: "ç”¢åœ°åˆ¤å®š (COO)",
      };

      // Defaults
      const DEFAULT_INPUTS = {
        projectName: "Demo_2025Q3", customer: "ACME", segment: "AI Accelerator", packageType: "CoWoS-L",
        dieCount: 2, nodeNm: 5, waferCostPerDie: 1200, substrateCost: 180, interposerCost: 350,
        bumpingCost: 75, assemblyCost: 220, testCost: 110, yieldWafer: 97, yieldAssembly: 95,
        yieldFinal: 98, outboundLogistics: 40, insurance: 5, otherVariable: 0, fxTWDperUSD: 32.5,
        paymentTermsDays: 45, targetGM: 25, riskAddon: 3, incoterm: "FOB", hsCode: "8542.31",
        frontEndCountry: "Taiwan", assemblyCountry: "Taiwan", testCountry: "Taiwan", shipToCountry: "China",
        cooOverride: "auto",
      };
      const DEFAULT_TARIFFS = [
        ["United States", "China", "^8542\\.", "US Section 301 (2025)", 50, "2025-08-01"],
        ["United States", "Taiwan", "^8542\\.", "US MFN (2025)", 0, "2025-01-01"],
        ["United States", "Japan", "^8542\\.", "US MFN (2025)", 0, "2025-01-01"],
        ["China", "China", ".*", "PRC Import (domestic)", 0, "2025-01-01"],
        ["Taiwan", "Taiwan", ".*", "TW Import (domestic)", 0, "2025-01-01"],
      ];
      const DEFAULT_SCENARIOS = [
        { name: "TW-only Backend", frontEndCountry: "Taiwan", assemblyCountry: "Taiwan", testCountry: "Taiwan", shipToCountry: "China", assumedCOO: "auto" },
        { name: "CN Backend (US dest w/China COO)", frontEndCountry: "Taiwan", assemblyCountry: "China", testCountry: "China", shipToCountry: "United States", assumedCOO: "China" },
        { name: "ASEAN via Amkor (US dest, TW COO)", frontEndCountry: "Taiwan", assemblyCountry: "Malaysia", testCountry: "Philippines", shipToCountry: "United States", assumedCOO: "Taiwan" },
      ];

      // State
      const [activeTab, setActiveTab] = useState('inputs');
      const [inputs, setInputs] = useState(DEFAULT_INPUTS);
      const [tariffs, setTariffs] = useState(DEFAULT_TARIFFS);
      const [scenarios, setScenarios] = useState(DEFAULT_SCENARIOS);
      const [xlsxLoaded, setXlsxLoaded] = useState(hasXLSX);
      const [analysis, setAnalysis] = useState("");
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const [toast, setToast] = useState(null);
      const [testReport, setTestReport] = useState(null);

      useEffect(() => { if (!xlsxLoaded && window.XLSX) setXlsxLoaded(true); }, [xlsxLoaded]);

      // Core helpers
      const inferCOO = (frontEnd, override) => (override && override !== "auto") ? override : (frontEnd || "Taiwan");
      const matchTariffRate = (rows, destination, coo, hsCode) => {
        for (const t of rows) {
          const [dest, origin, pattern, , rate] = t;
          if (dest === destination && origin === coo) {
            try { if (new RegExp(pattern).test(hsCode)) return rate; } catch (e) { console.error("Invalid regex:", pattern); }
          }
        }
        return 0;
      };
      const fmt = (n, d = 2) => (Number.isNaN(n) || n == null) ? "-" : Number(n).toLocaleString(undefined, { maximumFractionDigits: d, minimumFractionDigits: d });

      const baseCost = useMemo(() => {
        const yW = Math.max(Number(inputs.yieldWafer) / 100, 1e-6);
        const yA = Math.max(Number(inputs.yieldAssembly) / 100, 1e-6);
        const yF = Math.max(Number(inputs.yieldFinal) / 100, 1e-6);
        const mfg = (Number(inputs.waferCostPerDie) / yW)
                  + (Number(inputs.assemblyCost) / yA)
                  + (Number(inputs.testCost) / yF)
                  + Number(inputs.substrateCost)
                  + Number(inputs.interposerCost)
                  + Number(inputs.bumpingCost)
                  + Number(inputs.outboundLogistics)
                  + Number(inputs.insurance)
                  + Number(inputs.otherVariable);
        return Number.isFinite(mfg) ? mfg : 0;
      }, [inputs]);

      const results = useMemo(() => scenarios.map(s => {
        const coo = inferCOO(s.frontEndCountry, s.assumedCOO);
        const rate = matchTariffRate(tariffs, s.shipToCountry, coo, inputs.hsCode);
        const tariff = (rate / 100) * baseCost;
        const landed = baseCost + tariff;
        const quoteUSD = landed * (1 + Number(inputs.riskAddon)/100) * (1 / (1 - Number(inputs.targetGM)/100));
        const quoteTWD = quoteUSD * Number(inputs.fxTWDperUSD);
        return { ...s, coo, tariffRate: rate, manufacturingCost: baseCost, tariff, landed, quoteUSD, quoteTWD };
      }), [inputs, tariffs, scenarios, baseCost]);

      const chartData = useMemo(() => results.map(r => ({ name: r.name, USD: Number(r.quoteUSD.toFixed(2)) })), [results]);

      // Events
      const handleInputChange = (key, value) => setInputs(p => ({ ...p, [key]: value }));
      const handleTariffChange = (rowIndex, colIndex, value) => {
        setTariffs(prev => {
          const copy = prev.map(r => [...r]);
          copy[rowIndex][colIndex] = value;
          return copy;
        });
      };
      const updateScenario = (idx, field, value) => setScenarios(prev => prev.map((s,i) => i===idx ? { ...s, [field]: value } : s));
      const addScenario = () => setScenarios(prev => ([ ...prev, { name: `New Scenario ${prev.length+1}`, frontEndCountry: inputs.frontEndCountry, assemblyCountry: inputs.assemblyCountry, testCountry: inputs.testCountry, shipToCountry: inputs.shipToCountry, assumedCOO: inputs.cooOverride || 'auto' } ]));
      const resetAll = () => { setInputs(DEFAULT_INPUTS); setTariffs(DEFAULT_TARIFFS); setScenarios(DEFAULT_SCENARIOS); setAnalysis(""); setTestReport(null); };
      

      const exportXLSX = () => {
        if (!window.XLSX) { alert("åŒ¯å‡ºåŠŸèƒ½å°šæœªå°±ç·’ï¼ˆXLSX æœªè¼‰å…¥ï¼‰"); return; }
        try {
          const XLSX = window.XLSX;
          const wb = XLSX.utils.book_new();
          const inputsRows = Object.entries(inputs).map(([k,v]) => ({ 'é …ç›®': (labelMap && labelMap[k]) || k, 'æ•¸å€¼': v }));
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(inputsRows), "è¼¸å…¥åƒæ•¸");
          const tHeaders = ["ç›®çš„åœ°","COO","HS Pattern","æ–¹æ¡ˆ","ç¨…ç‡%","ç”Ÿæ•ˆæ—¥"];
          const tRows = tariffs.map(t => ({ [tHeaders[0]]: t[0], [tHeaders[1]]: t[1], [tHeaders[2]]: t[2], [tHeaders[3]]: t[3], [tHeaders[4]]: t[4], [tHeaders[5]]: t[5] }));
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(tRows), "é—œç¨…è¡¨");
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(scenarios), "å ´æ™¯è¨­å®š");
          const resultsExport = results.map(r => ({ 'å ´æ™¯': r.name, 'å‰æ®µ': r.frontEndCountry, 'å°è£': r.assemblyCountry, 'æ¸¬è©¦': r.testCountry, 'ç›®çš„åœ°': r.shipToCountry, 'COO': r.coo, 'é—œç¨…ç‡%': r.tariffRate, 'è£½é€ æˆæœ¬USD': r.manufacturingCost.toFixed(2), 'é—œç¨…USD': r.tariff.toFixed(2), 'åˆ°å²¸æˆæœ¬USD': r.landed.toFixed(2), 'å»ºè­°å ±åƒ¹USD': r.quoteUSD.toFixed(2), 'å»ºè­°å ±åƒ¹TWD': r.quoteTWD.toFixed(0) }));
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(resultsExport), "çµæœæ˜ç´°");
          XLSX.writeFile(wb, `IC_Backend_Quote_${inputs.projectName || 'Export'}.xlsx`);
        } catch (err) {
          console.error(err);
          alert("åŒ¯å‡ºå¤±æ•—ï¼š" + (err && err.message ? err.message : err));
        }
      };

      // Prompt å»ºç«‹å™¨ï¼ˆæä¾›çµ¦ ChatGPT ä½¿ç”¨ï¼Œæˆ–ç•¶åœ°ç«¯æ‘˜è¦çš„ç´ æï¼‰
      // FIX: use '\n' join to avoid syntax error
      const buildAnalysisPrompt = () => {
        const scenariosText = results
          .map(r => `- å ´æ™¯: "${r.name}" | ä¾›æ‡‰éˆ: ${r.frontEndCountry}(å‰æ®µ) -> ${r.assemblyCountry}(å°è£) -> ${r.testCountry}(æ¸¬è©¦) -> ${r.shipToCountry}(ç›®çš„åœ°) | æ¨å®šç”¢åœ°(COO): ${r.coo} | é—œç¨…ç‡: ${r.tariffRate}% | æœ€çµ‚å ±åƒ¹: $${fmt(r.quoteUSD)} USD`)
          .join('\n');
        return `ä½œç‚ºä¸€åå°ˆæ¥­çš„åŠå°é«”è¡Œæ¥­å¸‚å ´åˆ†æå¸«ï¼Œè«‹æ ¹æ“šä»¥ä¸‹è³‡è¨Šæ’°å¯«å¸‚å ´é¢¨éšªèˆ‡ç­–ç•¥åˆ†æï¼ˆä¸­æ–‡ï¼Œç²¾ç°¡æ¢åˆ—ï¼‰ï¼š
å°ˆæ¡ˆ: ${inputs.projectName}ï¼ˆ${inputs.segment}, ${inputs.packageType}ï¼‰
å®¢æˆ¶: ${inputs.customer}
æ ¸å¿ƒæˆæœ¬: $${fmt(baseCost)} USD
HS Code: ${inputs.hsCode}
ç•¶å‰å ´æ™¯ï¼š
${scenariosText}
è«‹è¼¸å‡ºï¼š1) å®è§€é¢¨éšª 2) å„å ´æ™¯çš„ä¸»è¦é¢¨éšª 3) 2-3 æ¢ç­–ç•¥å»ºè­° 4) ç¸½çµã€‚`;
      };

      // æœ¬åœ°å³æ™‚æ‘˜è¦ï¼ˆè¦å‰‡å¼ï¼Œç„¡éœ€ç¶²è·¯ï¼‰
      // FIX: lines.join('\n') to avoid syntax error
      const generateLocalSummary = () => {
        setIsAnalyzing(true);
        try {
          const cheapest = [...results].sort((a,b)=>a.quoteUSD-b.quoteUSD)[0];
          const mostTariff = [...results].sort((a,b)=>b.tariff-a.tariff)[0];
          const lines = [];
          lines.push(`ã€ç¸½è¦½ã€‘ç›®å‰è£½é€ æˆæœ¬ç´„ $${fmt(baseCost)}ï¼Œå»ºè­°å ±åƒ¹å€é–“ $${fmt(Math.min(...results.map(r=>r.quoteUSD)))} ~ $${fmt(Math.max(...results.map(r=>r.quoteUSD)))}`);
          lines.push(`ã€æœ€ä½³æ€§åƒ¹æ¯”ã€‘${cheapest.name}ï¼ˆ$${fmt(cheapest.quoteUSD)}ï¼‰ï¼ŒCOO: ${cheapest.coo}ï¼Œé—œç¨…ç‡ ${cheapest.tariffRate}%`);
          lines.push(`ã€é—œç¨…é¢¨éšªã€‘æœ€é«˜é—œç¨…å ´æ™¯ï¼š${mostTariff.name}ï¼ˆç¨…é¡ $${fmt(mostTariff.tariff)}ï¼‰`);
          lines.push('ã€ç­–ç•¥å»ºè­°ã€‘1) èˆ‡å®¢æˆ¶å”è­°ä»¥éä¸­åœ‹ COO çš„ä¾›æ‡‰è·¯å¾‘ï¼›2) ä¿ç•™ ASEAN å‚™æ´ï¼›3) å ±åƒ¹æ¢æ¬¾åŠ è¨»é—œç¨…è®Šå‹•èª¿æ•´æ©Ÿåˆ¶ã€‚');
          setAnalysis(lines.join('\n'));
        } finally { setIsAnalyzing(false); }
      };

      // å°‡æç¤ºè©è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œæ–¹ä¾¿ç›´æ¥è²¼åˆ°å³å´ GPT å°è©±
      const copyPromptToClipboard = async () => {
        const text = buildAnalysisPrompt();
        try { await navigator.clipboard.writeText(text); setToast('å·²è¤‡è£½æç¤ºè©ï¼Œè«‹åœ¨å³å´èŠå¤©è¦–çª—è²¼ä¸Šä¸¦é€å‡ºã€‚'); }
        catch { setToast('ç„¡æ³•è‡ªå‹•è¤‡è£½ï¼Œå·²åœ¨ä¸‹æ–¹é¡¯ç¤ºå…§å®¹ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚'); setAnalysis(text); }
        setTimeout(()=> setToast(null), 3000);
      };

      // --- Lightweight "tests" / smoke checks ---
      const runTests = () => {
        const resultsList = [];
        const push = (name, pass, detail='') => resultsList.push({ name, pass, detail });
        try { push('labelMap æœ‰ projectName', !!labelMap.projectName); } catch(e) { push('labelMap å®šç¾©', false, e.message); }
        push('inferCOO autoâ†’frontEnd', inferCOO('Taiwan','auto') === 'Taiwan');
        push('inferCOO override', inferCOO('Taiwan','China') === 'China');
        push('é—œç¨…æ¯”å° US<-CN HS8542 => 50%', matchTariffRate(DEFAULT_TARIFFS,'United States','China','8542.31') === 50);
        push('scenarios èˆ‡çµæœæ•¸ä¸€è‡´', scenarios.length === chartData.length);
        push('å ±åƒ¹æ‡‰â‰¥è£½é€ æˆæœ¬', (chartData.length>0) ? (results[0].quoteUSD >= results[0].manufacturingCost) : true);
        // æ–°å¢ï¼šæ ¼å¼åŒ– & åœ–è¡¨è³‡æ–™æ¸¬è©¦
        push('fmt(0,0) === "0"', (fmt(0,0) === '0'));
        const maxUSD = Math.max(...chartData.map(d=>d.USD));
        push('åœ–è¡¨è³‡æ–™æœ€å¤§å€¼å­˜åœ¨', Number.isFinite(maxUSD) && maxUSD >= 0);
        const cheapestName = [...results].sort((a,b)=>a.quoteUSD-b.quoteUSD)[0]?.name;
        const minNameFromChart = chartData.reduce((m,d)=> (d.USD < (m?.USD ?? Infinity) ? d : m), null)?.name;
        push('æœ€ä¾¿å®œå ´æ™¯ä¸€è‡´', cheapestName === minNameFromChart);
        setTestReport(resultsList);
      };

      // Render helpers
      const renderInputField = (key, type='number', options={}) => (
        <div className="space-y-1">
          <Label htmlFor={key}>{labelMap[key] || key}</Label>
          {type === 'select' ? (
            <Select id={key} value={inputs[key]} onChange={e => handleInputChange(key, e.target.value)}>
              {options.choices.map(c => <option key={c} value={c}>{c}</option>)}
            </Select>
          ) : type === 'country' ? (
            <Select id={key} value={inputs[key]} onChange={e => handleInputChange(key, e.target.value)}>
              {COUNTRIES.map(c => <option key={c} value={c}>{c}</option>)}
            </Select>
          ) : type === 'coo' ? (
            <Select id={key} value={inputs[key]} onChange={e => handleInputChange(key, e.target.value)}>
              <option value="auto">è‡ªå‹• (ä»¥å‰æ®µåœ‹åˆ¥æ¨å®š)</option>
              {COUNTRIES.map(c => <option key={c} value={c}>{c}</option>)}
            </Select>
          ) : (
            <Input id={key} type={type} value={inputs[key]} onChange={e => handleInputChange(key, type==='number' ? Number(e.target.value) : e.target.value)} step={options.step || 1} />
          )}
        </div>
      );

      const renderSliderField = (key, max, step) => (
        <div className="space-y-1">
          <Label>{labelMap[key] || key}</Label>
          <div className="flex items-center gap-3">
            <Slider value={inputs[key]} onChange={v => handleInputChange(key, v[0])} max={max} step={step} />
            <span className="w-12 text-right text-sm">{inputs[key]}%</span>
          </div>
        </div>
      );

      const Stat = ({ title, value }) => (
        <div className="rounded-2xl border bg-white p-5 shadow-sm hover:shadow-md transition-shadow">
          <p className="text-xs text-slate-500">{title}</p>
          <p className="text-2xl font-semibold mt-1 text-slate-900 tracking-tight">{value}</p>
        </div>
      );

      return (
        <div className="min-h-screen w-full bg-slate-50 p-4 sm:p-6 font-sans">
          <div className="mx-auto max-w-7xl space-y-6">
            <header className="flex flex-col sm:flex-row items-start justify-between gap-4 bg-gradient-to-br from-white/90 to-slate-50/80 rounded-2xl p-5 border shadow-sm ring-1 ring-white/50">
              <div>
                <h1 className="text-3xl font-bold text-slate-900 tracking-tight">IC å¾Œæ®µæœå‹™ â€” å ±åƒ¹äº’å‹•å„€è¡¨æ¿</h1>
                <p className="text-slate-600 text-sm">AI åŠ é€Ÿå™¨ / FPGA è¦–è¦ºå°è£è¨­è¨ˆãƒ»ç”¢åœ°/é—œç¨…æ•æ„Ÿãƒ»ä¸‰å ´æ™¯æ¯”å°ï¼‹æ‰¹æ¬¡æ¨¡æ“¬</p>
              </div>
              <div className="flex gap-2 flex-shrink-0">
                <Button variant="outline" onClick={resetAll}><RefreshCw />é‡ç½®</Button>
                <Button variant="outline" onClick={runTests}>ğŸ§ª è‡ªå‹•æª¢æ¸¬</Button>
                <Button onClick={exportXLSX} disabled={!xlsxLoaded}>{xlsxLoaded ? (<><Download />åŒ¯å‡º Excel</>) : 'è¼‰å…¥ä¸­...'}</Button>
              </div>
            </header>

            {testReport && (
              <div className="rounded-lg border p-4 bg-white">
                <div className="text-sm font-semibold mb-2">è‡ªå‹•æª¢æ¸¬çµæœ</div>
                <ul className="text-sm space-y-1">
                  {testReport.map((t,i)=> (
                    <li key={i} className={t.pass ? 'text-emerald-600' : 'text-rose-600'}>
                      {t.pass ? 'âœ“' : 'âœ—'} {t.name}{t.detail ? ` â€” ${t.detail}` : ''}
                    </li>
                  ))}
                </ul>
              </div>
            )}

            <div className="border-b border-slate-200 sticky top-0 z-10 bg-slate-50/80 backdrop-blur supports-[backdrop-filter]:bg-slate-50/60">
              <nav className="flex flex-wrap -mb-px" aria-label="Tabs">
                {['inputs','tariffs','scenarios','results'].map(tab => (
                  <button key={tab} onClick={() => setActiveTab(tab)} className={`whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-md ${activeTab===tab ? 'border-slate-700 text-slate-900 bg-white shadow-sm' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'}`}>
                    {{inputs:'è¼¸å…¥åƒæ•¸', tariffs:'é—œç¨…è¡¨', scenarios:'è·¯å¾‘/å ´æ™¯', results:'çµæœ/åœ–è¡¨'}[tab]}
                  </button>
                ))}
              </nav>
            </div>

            <main>
              {activeTab==='inputs' && (
                <Card>
                  <CardHeader><CardTitle>å°ˆæ¡ˆèˆ‡æˆæœ¬åƒæ•¸</CardTitle></CardHeader>
                  <CardContent>
                    <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                      {renderInputField('projectName','text')}
                      {renderInputField('customer','text')}
                      {renderInputField('segment','select',{choices:SEGMENTS})}
                      {renderInputField('packageType','select',{choices:PACKAGES})}
                      {renderInputField('dieCount')}
                      {renderInputField('nodeNm')}
                      {renderInputField('waferCostPerDie')}
                      {renderInputField('substrateCost')}
                      {renderInputField('interposerCost')}
                      {renderInputField('bumpingCost')}
                      {renderInputField('assemblyCost')}
                      {renderInputField('testCost')}
                      {renderInputField('yieldWafer','number',{step:0.1})}
                      {renderInputField('yieldAssembly','number',{step:0.1})}
                      {renderInputField('yieldFinal','number',{step:0.1})}
                      {renderInputField('outboundLogistics')}
                      {renderInputField('insurance')}
                      {renderInputField('otherVariable')}
                      {renderInputField('fxTWDperUSD','number',{step:0.01})}
                      {renderInputField('paymentTermsDays')}
                      {renderInputField('incoterm','select',{choices:['FOB','CIF','DDP']})}
                      {renderInputField('hsCode','text')}
                      <div className="md:col-span-3 lg:col-span-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        {renderSliderField('targetGM',60,1)}
                        {renderSliderField('riskAddon',15,0.5)}
                      </div>
                      <div className="md:col-span-3 lg:col-span-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        {renderInputField('frontEndCountry','country')}
                        {renderInputField('assemblyCountry','country')}
                        {renderInputField('testCountry','country')}
                        {renderInputField('shipToCountry','country')}
                        {renderInputField('cooOverride','coo')}
                      </div>
                    </div>
                    <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                      <Stat title="è£½é€ æˆæœ¬ (USD)" value={`$${fmt(baseCost)}`} />
                      <Stat title="åˆ°å²¸æˆæœ¬ (TW-only, ä¼°)" value={`$${fmt(results.find(r=>r.name.includes('TW-only'))?.landed || 0)}`} />
                      <Stat title="å»ºè­°å ±åƒ¹ (USD, TW-only)" value={`$${fmt(results.find(r=>r.name.includes('TW-only'))?.quoteUSD || 0)}`} />
                    </div>
                  </CardContent>
                </Card>
              )}

              {activeTab==='tariffs' && (
                <Card>
                  <CardHeader><CardTitle>é—œç¨…è¨­å®š</CardTitle></CardHeader>
                  <CardContent>
                    <p className="text-sm text-slate-600 mb-4">ç°¡åŒ–ç¤ºä¾‹ï¼šç¾åœ‹å°ä¸­åœ‹åŸç”¢åŠå°é«” (HS 8542.*) èª²å¾µ 50% é—œç¨…ã€‚æ‚¨å¯ä»¥æ ¹æ“šæœ€æ–°æƒ…æ³æ–°å¢æˆ–ä¿®æ”¹è¦å‰‡ã€‚</p>
                    <div className="overflow-x-auto rounded-lg border">
                      <table className="w-full text-sm text-left text-slate-500">
                        <thead className="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0 z-0">
                          <tr>{["ç›®çš„åœ°","COO","HS Pattern (Regex)","æ–¹æ¡ˆ","ç¨…ç‡%","ç”Ÿæ•ˆæ—¥"].map(h => <th key={h} scope="col" className="px-4 py-3">{h}</th>)}</tr>
                        </thead>
                        <tbody>
                          {tariffs.map((t,rIdx)=> (
                            <tr key={rIdx} className="bg-white border-b hover:bg-slate-50/70">
                              <td className="px-2 py-2"><Select value={t[0]} onChange={e=>handleTariffChange(rIdx,0,e.target.value)}>{COUNTRIES.map(c=> <option key={c} value={c}>{c}</option>)}</Select></td>
                              <td className="px-2 py-2"><Select value={t[1]} onChange={e=>handleTariffChange(rIdx,1,e.target.value)}>{COUNTRIES.map(c=> <option key={c} value={c}>{c}</option>)}</Select></td>
                              <td className="px-2 py-2"><Input value={t[2]} onChange={e=>handleTariffChange(rIdx,2,e.target.value)} /></td>
                              <td className="px-2 py-2"><Input value={t[3]} onChange={e=>handleTariffChange(rIdx,3,e.target.value)} /></td>
                              <td className="px-2 py-2"><Input type="number" value={t[4]} onChange={e=>handleTariffChange(rIdx,4,Number(e.target.value))} /></td>
                              <td className="px-2 py-2"><Input type="date" value={t[5]} onChange={e=>handleTariffChange(rIdx,5,e.target.value)} /></td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    <Button variant="outline" className="mt-4" onClick={() => setTariffs([...tariffs, ["United States","China","^8542\\.","Custom",25,"2025-01-01"]])}><Plus />æ–°å¢ä¸€åˆ—</Button>
                  </CardContent>
                </Card>
              )}

              {activeTab==='scenarios' && (
                <Card>
                  <CardHeader><CardTitle>è·¯å¾‘/å ´æ™¯</CardTitle></CardHeader>
                  <CardContent className="space-y-4">
                    <div className="flex justify-between items-center">
                      <p className="text-sm text-slate-600">æ¯”è¼ƒä¸åŒä¾›æ‡‰éˆè·¯å¾‘å°æˆæœ¬å’Œå ±åƒ¹çš„å½±éŸ¿ã€‚</p>
                      <Button variant="outline" onClick={addScenario}><Plus />æ–°å¢å ´æ™¯</Button>
                    </div>
                    <div className="grid gap-4">
                      {scenarios.map((s,idx)=> (
                        <div key={idx} className="rounded-lg border p-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-3 bg-white">
                          <div className="md:col-span-3 lg:col-span-2"><Label>åç¨±</Label><Input value={s.name} onChange={e=>updateScenario(idx,'name',e.target.value)} /></div>
                          <div><Label>å‰æ®µ</Label><Select value={s.frontEndCountry} onChange={e=>updateScenario(idx,'frontEndCountry',e.target.value)}>{COUNTRIES.map(c=> <option key={c} value={c}>{c}</option>)}</Select></div>
                          <div><Label>å°è£</Label><Select value={s.assemblyCountry} onChange={e=>updateScenario(idx,'assemblyCountry',e.target.value)}>{COUNTRIES.map(c=> <option key={c} value={c}>{c}</option>)}</Select></div>
                          <div><Label>æ¸¬è©¦</Label><Select value={s.testCountry} onChange={e=>updateScenario(idx,'testCountry',e.target.value)}>{COUNTRIES.map(c=> <option key={c} value={c}>{c}</option>)}</Select></div>
                          <div><Label>ç›®çš„åœ°</Label><Select value={s.shipToCountry} onChange={e=>updateScenario(idx,'shipToCountry',e.target.value)}>{COUNTRIES.map(c=> <option key={c} value={c}>{c}</option>)}</Select></div>
                          <div><Label>COOï¼ˆç”¢åœ°åˆ¤å®šï¼‰</Label><Select value={s.assumedCOO} onChange={e=>updateScenario(idx,'assumedCOO',e.target.value)}><option value="auto">è‡ªå‹•ï¼ˆä»¥å‰æ®µåœ‹åˆ¥ï¼‰</option>{COUNTRIES.map(c=> <option key={c} value={c}>{c}</option>)}</Select></div>
                        </div>
                      ))}
                    </div>
                  </CardContent>
                </Card>
              )}

              {activeTab==='results' && (
                <div className="space-y-4">
                  <Card>
                    <CardHeader><CardTitle>å ±åƒ¹å°æ¯” (USD) <span className='ml-2 text-xs font-normal text-slate-500'>(æœ€ä½³å€¼ä»¥ç¶ è‰²æ¨™ç¤º)</span></CardTitle></CardHeader>
                    <CardContent>
                      <MiniBarChart data={chartData} fmt={fmt} />
                    </CardContent>
                  </Card>

                  <Card>
                    <CardHeader><CardTitle>æ˜ç´°è¡¨</CardTitle></CardHeader>
                    <CardContent>
                      <div className="overflow-x-auto rounded-lg border">
                        <table className="w-full text-sm text-left text-slate-500">
                          <thead className="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0 z-0">
                            <tr>{["å ´æ™¯","COO","è£½é€ æˆæœ¬","é—œç¨…ç‡%","é—œç¨…","åˆ°å²¸æˆæœ¬","å ±åƒ¹ (USD)","å ±åƒ¹ (TWD)"].map(h => <th key={h} scope="col" className="px-4 py-3 whitespace-nowrap">{h}</th>)}</tr>
                          </thead>
                          <tbody>
                            {results.map((r,i)=> (
                              <tr key={i} className="bg-white border-b hover:bg-slate-50/70">
                                <td className="px-4 py-2 font-medium text-slate-900 whitespace-nowrap">{r.name}</td>
                                <td className="px-4 py-2">{r.coo}</td>
                                <td className="px-4 py-2 text-right">${fmt(r.manufacturingCost)}</td>
                                <td className="px-4 py-2 text-right">{fmt(r.tariffRate,1)}%</td>
                                <td className="px-4 py-2 text-right">${fmt(r.tariff)}</td>
                                <td className="px-4 py-2 text-right">${fmt(r.landed)}</td>
                                <td className="px-4 py-2 text-right font-semibold text-slate-800">${fmt(r.quoteUSD)}</td>
                                <td className="px-4 py-2 text-right font-semibold text-slate-800">NT${fmt(r.quoteTWD,0)}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </CardContent>
                  </Card>

                  <Card>
                    <CardHeader><CardTitle><Sparkles /> AI æ´å¯Ÿåˆ†æ</CardTitle></CardHeader>
                    <CardContent>
                      <div className="flex flex-col gap-3">
                        <p className="text-sm text-slate-600">å¯ç›´æ¥åœ¨æœ¬åœ°ç”Ÿæˆç°¡å ±å¼æ‘˜è¦ï¼Œæˆ–å°‡æç¤ºè©è¤‡è£½åˆ°å³å´ ChatGPT ä»¥ç²å¾—æ›´æ·±å…¥çš„è‡ªç„¶èªè¨€åˆ†æã€‚</p>
                        <div className="flex flex-wrap gap-2">
                          <Button onClick={generateLocalSummary} disabled={isAnalyzing}>{isAnalyzing ? 'åˆ†æä¸­â€¦' : 'âš¡ï¸ æœ¬åœ°é€Ÿè¦½'}</Button>
                          <Button variant="outline" onClick={copyPromptToClipboard}>ğŸ§  è¤‡è£½ ChatGPT æç¤ºè©</Button>
                        </div>
                        {toast && <div className="text-xs text-emerald-700 bg-emerald-50 border border-emerald-200 rounded px-2 py-1 w-fit">{toast}</div>}
                        {analysis && (
                          <div className="w-full mt-2 p-4 border rounded-md bg-slate-50">
                            <pre className="whitespace-pre-wrap text-sm text-slate-800 font-sans">{analysis}</pre>
                          </div>
                        )}
                        {!analysis && (
                          <details className="text-xs text-slate-500">
                            <summary className="cursor-pointer">æŸ¥çœ‹å°‡è¤‡è£½çš„æç¤ºè©</summary>
                            <pre className="whitespace-pre-wrap text-xs mt-2 p-2 bg-white border rounded">{buildAnalysisPrompt()}</pre>
                          </details>
                        )}
                      </div>
                    </CardContent>
                  </Card>
                </div>
              )}
            </main>

            <footer className="text-xs text-slate-500 pt-4 text-center">
              æœ¬å·¥å…·ç‚ºè©¦ç®—ç”¨é€”ï¼Œé—œç¨…èˆ‡ç”¢åœ°(COO)éœ€ä¾å€‹æ¡ˆç”±é—œå‹™/æ³•å¾‹ç¢ºèªï¼›å‡ºå£ç®¡åˆ¶è«‹åƒç…§ BIS æœ€æ–°å…¬å‘Šèˆ‡å®¢æˆ¶æœ€çµ‚ç”¨é€”ã€‚AI åˆ†æçµæœåƒ…ä¾›åƒè€ƒã€‚
            </footer>
          </div>
        </div>
      );
    }

    window.addEventListener('load', () => {
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<ICBackendQuotationDashboard />);
    });
  </script>
</body>
</html>
