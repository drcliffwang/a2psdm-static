<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å½±åƒè¾¨è­˜å·¥å…·</title>

  <!-- è¼‰å…¥ Tailwind CSS å¯¦ç¾ç¾ä»£åŒ– UI è¨­è¨ˆ -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- è¼‰å…¥ Google Fonts æä¾›æ›´ä½³çš„å­—é«”é–±è®€é«”é©— -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap"
    rel="stylesheet">

  <style>
    /* Michigan Blue & Maize Theme */
    body {
      font-family: 'Inter', 'Noto Sans TC', sans-serif;
      background: #00274C;
      /* Michigan Blue */
      background-image: radial-gradient(at 0% 0%, #001a33 0, transparent 50%),
        radial-gradient(at 50% 100%, #00274C 0, transparent 50%),
        radial-gradient(at 100% 0%, #001a33 0, transparent 50%);
      background-attachment: fixed;
      background-size: cover;
      color: #f8fafc;
    }

    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .glass-panel {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    /* Range Slider */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      cursor: pointer;
      outline: none;
      border-radius: 9999px;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      height: 18px;
      width: 18px;
      background-color: #FFCB05;
      /* Michigan Maize */
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 0 10px rgba(255, 203, 5, 0.5);
      transition: transform 0.1s;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }

    .video-flash {
      animation: flash 0.5s ease-out;
    }

    @keyframes flash {
      0% {
        box-shadow: 0 0 0 0px rgba(255, 203, 5, 0.7);
      }

      100% {
        box-shadow: 0 0 0 20px rgba(255, 203, 5, 0);
      }
    }

    /* Utilities */
    .text-shadow {
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    /* Mobile-First Tweaks */
    @media (max-width: 640px) {
      .container {
        padding: 1rem;
      }
      header {
        margin-bottom: 1.5rem;
      }
    }

    /* Mini Cam Transition */
    #mini-cam-container {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #mini-cam-container.hidden {
      display: block; /* Override default hidden behavior for transition */
      opacity: 0;
      pointer-events: none;
      transform: translateY(-20px) scale(0.9);
    }
  </style>
</head>

<body class="min-h-screen selection:bg-[#FFCB05] selection:text-[#00274C]">

  <div class="container mx-auto p-4 md:p-8 max-w-7xl">

    <!-- é é¦–æ¨™é¡Œ -->
    <header class="mb-10 flex flex-col xl:flex-row justify-between items-center gap-6">

      <!-- Left Side: Icon + Title Group -->
      <div class="flex items-center gap-5 w-full md:w-auto">
        <!-- Logo Icon -->
        <div
          class="shrink-0 w-16 h-16 rounded-2xl bg-[#FFCB05] text-[#00274C] flex items-center justify-center shadow-[0_0_20px_rgba(255,203,5,0.3)]">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-9 h-9">
            <path d="M12 9a3.75 3.75 0 1 0 0 7.5A3.75 3.75 0 0 0 12 9Z" />
            <path fill-rule="evenodd"
              d="M9.344 3.071a49.52 49.52 0 0 1 5.312 0c.967.052 1.83.585 2.332 1.39l.821 1.317c.24.383.645.643 1.11.71.386.054.77.113 1.152.177 1.432.239 2.429 1.493 2.429 2.909V18a3 3 0 0 1-3 3h-15a3 3 0 0 1-3-3V9.574c0-1.416.997-2.67 2.429-2.909.382-.064.766-.123 1.151-.178a1.56 1.56 0 0 0 1.11-.71l.822-1.315a2.942 2.942 0 0 1 2.332-1.39ZM6.75 12.75a5.25 5.25 0 1 1 10.5 0 5.25 5.25 0 0 1-10.5 0Zm12-1.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z"
              clip-rule="evenodd" />
          </svg>
        </div>

        <!-- Text Content -->
        <div class="flex flex-col">
          <h1 class="text-3xl md:text-4xl font-black text-white tracking-tight leading-tight">
            å½±åƒè¾¨è­˜<span class="text-[#FFCB05] mx-1">èˆ‡</span>æ¨¡å‹è¨“ç·´
          </h1>
          <p class="text-slate-400 font-medium text-sm md:text-base mt-1 tracking-wide">
            å•Ÿå‹•æ”å½±æ©Ÿã€è’é›†æ¨£æœ¬ï¼Œå³æ™‚è¨“ç·´è¾¨è­˜æ¨¡å‹
          </p>
        </div>
      </div>

      <!-- Right Side: Profile Pill -->
      <div
        class="flex items-center gap-4 bg-white/10 border border-white/10 rounded-full p-2 pr-8 backdrop-blur-md shadow-lg transition-transform hover:scale-[1.02] w-full md:w-auto max-w-md">
        <!-- Avatar -->
        <div class="shrink-0 w-14 h-14 rounded-full bg-slate-200 overflow-hidden border-2 border-[#FFCB05]">
          <img src="Cliff Baby Pic by GPT.jpg" alt="Cliff Wang" class="w-full h-full object-cover" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=Cliff'" />
        </div>

        <!-- Info -->
        <div class="flex flex-col justify-center">
          <div class="text-white font-bold text-lg leading-tight">Cliff Wang, Ph.D.</div>
          <div class="text-slate-300 text-xs font-medium mb-0.5">ç‹å•Ÿå²³åšå£«</div>
          <a href="mailto:dr.cliffwang@a2psdm.com"
            class="text-[#FFCB05] text-xs font-semibold hover:underline hover:text-[#ffe066] transition-colors">
            dr.cliffwang@a2psdm.com
          </a>
        </div>
      </div>

    </header>

    <!-- ä¸»å…§å®¹å€å¡Š -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- å·¦æ¬„ï¼šæ”å½±æ©Ÿç•«é¢èˆ‡æ“ä½œé¢æ¿ -->
      <div class="flex flex-col gap-6">

        <!-- æ”å½±æ©Ÿç•«é¢ -->
        <div id="video-wrap"
          class="relative w-full aspect-video rounded-2xl bg-black/40 border border-white/10 shadow-2xl overflow-hidden flex items-center justify-center text-slate-500 group">
          <!-- æ³¨æ„ï¼šæ‰‹æ©Ÿå¾Œé¡é ­é€šå¸¸ä¸éœ€è¦æ°´å¹³ç¿»è½‰ (scale-x-[-1])ï¼Œé€™è£¡é è¨­ç¿»è½‰æ˜¯ç‚ºäº†è‡ªæ‹æ¨¡å¼ï¼Œç¨‹å¼ä¸­æœƒå‹•æ…‹èª¿æ•´ -->
          <video id="webcam" autoplay playsinline muted
            class="w-full h-full object-cover hidden transform scale-x-[-1]"></video>
          <div id="placeholder" class="flex flex-col items-center gap-3 animate-pulse">
            <div class="p-4 rounded-full bg-white/5 border border-white/10">
              <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M15 10l4.55 3a1 1 0 011.45.9v6.2a1 1 0 01-1.45.9L15 14v-4zM3 6a2 2 0 00-2 2v8a2 2 0 002 2h10a2 2 0 002-2V8a2 2 0 00-2-2H3z">
                </path>
              </svg>
            </div>
            <span class="font-medium tracking-wide">ç­‰å¾…å•Ÿå‹•æ”å½±æ©Ÿ...</span>
          </div>
          <!-- Overlay UI -->
          <div class="absolute top-4 right-4 px-2 py-1 rounded bg-black/60 text-xs font-mono text-white/80 hidden"
            id="cam-status-badge">LIVE</div>
        </div>

        <!-- æ­¥é©Ÿä¸€ï¼šè¨­å®š -->
        <div class="glass p-6 rounded-2xl">
          <h2 class="text-lg font-bold text-white flex items-center gap-3 mb-4">
            <span
              class="bg-[#FFCB05] text-[#00274C] w-7 h-7 flex items-center justify-center rounded-lg text-sm font-bold shadow-lg shadow-[#FFCB05]/30">1</span>
            è¨­å®šèˆ‡æº–å‚™
          </h2>
          <div class="flex flex-col gap-3">
            <div class="flex gap-3">
              <button id="btnStart"
                class="flex-1 bg-[#FFCB05] text-[#00274C] font-bold py-2.5 px-4 rounded-xl shadow-lg shadow-[#FFCB05]/20 hover:bg-[#ffe066] hover:shadow-[#FFCB05]/40 focus:outline-none focus:ring-2 focus:ring-[#FFCB05] transition-all active:scale-95">ğŸ¥
                å•Ÿå‹•</button>
              <button id="btnStop"
                class="flex-1 bg-rose-500/20 text-rose-300 border border-rose-500/30 font-semibold py-2.5 px-4 rounded-xl hover:bg-rose-500/30 focus:outline-none focus:ring-2 focus:ring-rose-500/50 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>â¹ï¸ åœæ­¢</button>
            </div>
            
            <div class="flex gap-2">
                <div class="relative flex-1">
                <select id="selCam"
                    class="w-full appearance-none bg-[#00274C]/50 text-slate-200 border border-white/10 rounded-xl py-2.5 px-4 pr-8 focus:outline-none focus:ring-2 focus:ring-[#FFCB05] focus:border-[#FFCB05] transition-colors cursor-pointer text-sm">
                    <option value="">åµæ¸¬ä¸­...</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                </div>
                <!-- åˆ‡æ›é¡é ­æŒ‰éˆ• -->
                <button id="btnSwitchCam" title="åˆ‡æ›å‰å¾Œé¡é ­"
                class="bg-slate-700/50 text-white border border-white/10 px-4 rounded-xl hover:bg-slate-600 transition-all active:scale-90">
                ğŸ”„
                </button>
            </div>
          </div>
        </div>

        <!-- æ­¥é©ŸäºŒï¼šæ¨£æœ¬ -->
        <div class="glass p-6 rounded-2xl">
          <h2 class="text-lg font-bold text-white flex items-center gap-3 mb-4">
            <span
              class="bg-[#FFCB05] text-[#00274C] w-7 h-7 flex items-center justify-center rounded-lg text-sm font-bold shadow-lg shadow-[#FFCB05]/30">2</span>
            æ¨£æœ¬è’é›†
          </h2>
          <div class="flex gap-3 mb-4">
            <input id="inpLabel" type="text" placeholder="è¼¸å…¥é¡åˆ¥åç¨± (å¦‚: Good, Bad)"
              class="flex-grow bg-[#00274C]/50 border border-white/10 text-white rounded-xl py-2.5 px-4 focus:outline-none focus:ring-2 focus:ring-[#FFCB05] focus:border-[#FFCB05] placeholder-slate-500 transition-all">
            <button id="btnAddClass"
              class="bg-[#FFCB05] text-[#00274C] font-bold py-2.5 px-5 rounded-xl shadow-lg shadow-[#FFCB05]/20 hover:bg-[#ffe066] hover:shadow-[#FFCB05]/40 focus:outline-none focus:ring-2 focus:ring-[#FFCB05] transition-all active:scale-95 whitespace-nowrap">â•
              æ–°å¢</button>
          </div>

          <div id="classList" class="flex flex-col gap-3 max-h-80 overflow-y-auto pr-2 custom-scrollbar">
            <!-- Class Items will be injected here -->
            <div class="text-center py-8 text-slate-500 border-2 border-dashed border-white/5 rounded-xl">
              å°šæœªæ–°å¢ä»»ä½•é¡åˆ¥
            </div>
          </div>

          <div class="mt-4 pt-4 border-t border-white/10 flex flex-wrap gap-3">
            <input type="file" id="imgInput" accept="image/*" multiple class="hidden" />
            <button id="btnAddFromImg"
              class="flex-1 text-sm bg-[#00274C]/50 text-[#FFCB05] border border-[#FFCB05]/30 font-semibold py-2 px-4 rounded-lg hover:bg-[#FFCB05]/20 focus:outline-none focus:ring-2 focus:ring-[#FFCB05]/50 transition-colors">ğŸ–¼ï¸
              ä¸Šå‚³åœ–ç‰‡</button>
            <button id="btnClearData"
              class="flex-1 text-sm bg-[#00274C]/50 text-rose-300 border border-rose-500/30 font-semibold py-2 px-4 rounded-lg hover:bg-rose-500/20 focus:outline-none focus:ring-2 focus:ring-rose-500/50 transition-colors">ğŸ—‘ï¸
              æ¸…ç©º</button>
          </div>
        </div>

      </div>

      <!-- å³æ¬„ï¼šçµæœèˆ‡é€²éšå·¥å…· -->
      <div class="flex flex-col gap-6">

        <!-- å³æ™‚è¾¨è­˜çµæœ -->
        <div class="glass p-6 rounded-2xl lg:aspect-video flex flex-col">
          <h2 class="text-lg font-bold text-white mb-4 shrink-0">å³æ™‚è¾¨è­˜çµæœ</h2>
          <div class="flex-1 flex flex-col min-h-0 gap-4">
            <div id="bigResult"
              class="p-6 rounded-xl bg-slate-800/80 border border-white/10 text-white transition-all duration-300 flex flex-col items-center justify-center min-h-[120px] shrink-0">
              <span id="bigResultLabel"
                class="text-4xl font-black tracking-wider mb-2 text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400">â€”</span>
              <span id="bigResultConf" class="text-xl font-medium text-slate-400">â€”</span>
            </div>
            <div id="predictions" class="flex flex-col gap-3 overflow-y-auto pr-2 custom-scrollbar">
              <!-- Prediction Bars -->
            </div>
          </div>
        </div>

        <!-- æ­¥é©Ÿä¸‰ï¼šè¨“ç·´ -->
        <div class="glass p-6 rounded-2xl">
          <h2 class="text-lg font-bold text-white flex items-center gap-3 mb-4">
            <span
              class="bg-[#FFCB05] text-[#00274C] w-7 h-7 flex items-center justify-center rounded-lg text-sm font-bold shadow-lg shadow-[#FFCB05]/30">3</span>
            è¨“ç·´èˆ‡è¾¨è­˜
          </h2>
          <div class="flex flex-col gap-5">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <button id="btnTrain"
                class="bg-gradient-to-br from-[#FFCB05] to-[#E6B700] text-[#00274C] font-bold py-3 px-4 rounded-xl shadow-lg shadow-[#FFCB05]/20 hover:shadow-[#FFCB05]/40 hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-[#FFCB05] disabled:opacity-50 disabled:grayscale disabled:scale-100 disabled:cursor-not-allowed transition-all">
                ğŸ§  è¨“ç·´æ¨¡å‹
              </button>
              <button id="btnPredict"
                class="bg-gradient-to-br from-white to-slate-200 text-[#00274C] font-bold py-3 px-4 rounded-xl shadow-lg shadow-white/20 hover:shadow-white/40 hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-white disabled:opacity-50 disabled:grayscale disabled:scale-100 disabled:cursor-not-allowed transition-all">
                ğŸ” é–‹å§‹è¾¨è­˜
              </button>
              <button id="btnStopPredict"
                class="bg-slate-700 text-slate-300 font-bold py-3 px-4 rounded-xl hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                â¸ï¸ åœæ­¢
              </button>
            </div>

            <div class="bg-black/20 rounded-xl p-4 border border-white/5">
              <div class="flex justify-between items-center mb-2">
                <label for="th" class="font-medium text-slate-300 text-sm">ç½®ä¿¡é–€æª» (Confidence Threshold)</label>
                <span id="thVal" class="font-bold text-[#FFCB05] text-sm">70%</span>
              </div>
              <input id="th" type="range" min="50" max="95" value="70" class="w-full">
            </div>
          </div>
        </div>

        <!-- é€²éšå·¥å…· -->
        <div class="glass rounded-2xl overflow-hidden">
          <details class="p-6 group" open>
            <summary class="text-lg font-bold text-white cursor-pointer list-none flex items-center justify-between">
              <span>é€²éšå·¥å…·èˆ‡ç‹€æ…‹</span>
              <svg class="w-5 h-5 text-slate-400 transition-transform transform group-open:rotate-180" fill="none"
                stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </summary>

            <!-- ç‹€æ…‹èˆ‡è³‡è¨Š -->
            <div class="mt-4 border-t border-white/10 pt-4">
              <h3 class="font-semibold text-slate-300 mb-3">ç³»çµ±ç‹€æ…‹</h3>
              <!-- ç‹€æ…‹é¡¯ç¤ºå€åŸŸæ”¹é€² -->
              <div id="status"
                class="p-4 rounded-2xl font-medium bg-white/5 border border-white/10 text-slate-300 transition-all mb-4 flex items-center gap-3">
                <span class="text-xl">ğŸ‘‹</span>
                <span>æ­¡è¿ä½¿ç”¨ï¼è«‹å¾æ­¥é©Ÿ 1 é–‹å§‹ã€‚</span>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                <div class="bg-[#00274C]/50 border border-white/5 p-3 rounded-xl">
                  <div class="text-2xl font-bold text-[#FFCB05]" id="samples">0</div>
                  <div class="text-xs font-medium text-slate-500 uppercase tracking-wider mt-1">æ¨£æœ¬ç¸½æ•¸</div>
                </div>
                <div class="bg-slate-800/50 border border-white/5 p-3 rounded-xl">
                  <div class="text-2xl font-bold text-emerald-400" id="fps">0</div>
                  <div class="text-xs font-medium text-slate-500 uppercase tracking-wider mt-1">FPS</div>
                </div>
                <div class="bg-slate-800/50 border border-white/5 p-3 rounded-xl">
                  <div class="text-2xl font-bold text-amber-400" id="infer">â€”</div>
                  <div class="text-xs font-medium text-slate-500 uppercase tracking-wider mt-1">æ¨è«– (ms)</div>
                </div>
                <div class="bg-[#00274C]/50 border border-white/5 p-3 rounded-xl">
                  <div class="text-2xl font-bold text-sky-400" id="classCount">0</div>
                  <div class="text-xs font-medium text-slate-500 uppercase tracking-wider mt-1">é¡åˆ¥æ•¸</div>
                </div>
              </div>
            </div>

            <!-- è³‡æ–™èˆ‡æ¨¡å‹ -->
            <div class="mt-4 border-t border-white/10 pt-4">
              <h3 class="font-semibold text-slate-300">è³‡æ–™èˆ‡æ¨¡å‹</h3>
              <p class="text-sm text-slate-400 mb-4">ç®¡ç†æ‚¨çš„è¨“ç·´è³‡æ–™é›†ã€‚</p>
              <div class="flex gap-3">
                <input type="file" id="fileLoad" class="hidden" accept=".json">
                <button id="btnSave"
                  class="flex-1 text-[#FFCB05] bg-[#FFCB05]/10 border border-[#FFCB05]/20 font-semibold py-2.5 px-4 rounded-xl hover:bg-[#FFCB05]/20 focus:outline-none focus:ring-2 focus:ring-[#FFCB05] transition-colors">
                  ğŸ’¾ ä¸‹è¼‰è³‡æ–™é›†
                </button>
                <button id="btnLoad"
                  class="flex-1 text-[#FFCB05] bg-[#FFCB05]/10 border border-[#FFCB05]/20 font-semibold py-2.5 px-4 rounded-xl hover:bg-[#FFCB05]/20 focus:outline-none focus:ring-2 focus:ring-[#FFCB05] transition-colors">
                  ğŸ“‚ è¼‰å…¥è³‡æ–™é›†
                </button>
              </div>
            </div>

            <!-- ç›¸æ©Ÿæ¬Šé™è¨ºæ–· -->
            <div class="mt-4 border-t border-white/10 pt-4">
              <h3 class="font-semibold text-slate-300">ç›¸æ©Ÿæ¬Šé™è¨ºæ–·</h3>
              <div class="mt-3">
                <button id="btnPreflight"
                  class="text-sm text-slate-300 font-semibold bg-slate-700/50 py-2 px-4 rounded-lg hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-400 transition-colors">ğŸ©º
                  åŸ·è¡Œå¥æª¢</button>
              </div>
              <div class="mt-3 grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
                <span class="bg-slate-800/50 p-2 rounded-md text-slate-400">å®‰å…¨ä¸Šä¸‹æ–‡: <strong id="pSecure"
                    class="text-indigo-400">â€”</strong></span>
                <span class="bg-slate-800/50 p-2 rounded-md text-slate-400">åª’é«”API: <strong id="pMedia"
                    class="text-indigo-400">â€”</strong></span>
                <span class="bg-slate-800/50 p-2 rounded-md text-slate-400">ç›¸æ©Ÿæ¬Šé™: <strong id="pPerm"
                    class="text-indigo-400">â€”</strong></span>
                <span class="bg-slate-800/50 p-2 rounded-md text-slate-400">å¯ç”¨è£ç½®: <strong id="pDevs"
                    class="text-indigo-400">â€”</strong></span>
              </div>
            </div>
          </details>
        </div>

      </div>
    </div>
  </div>

  <!-- Mini Floating Camera (Hidden by default, shows on scroll) -->
  <div id="mini-cam-container" class="hidden fixed top-4 right-4 w-40 sm:w-48 aspect-video bg-black rounded-xl border-2 border-[#FFCB05] shadow-2xl z-50 overflow-hidden ring-4 ring-black/20">
    <video id="mini-video" autoplay playsinline muted class="w-full h-full object-cover transform scale-x-[-1]"></video>
    <div class="absolute bottom-1 right-1 px-1.5 py-0.5 rounded bg-black/60 text-[10px] font-mono text-white/90">LIVE</div>
  </div>

  <!-- è¼‰å…¥ TensorFlow.js æ ¸å¿ƒå‡½å¼åº«èˆ‡é è¨“ç·´æ¨¡å‹ -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier@1.2.2"></script>

  <script>
    // --- å…¨åŸŸè®Šæ•¸èˆ‡ DOM å…ƒç´ å¿«å– ---
    const els = {
      video: document.getElementById('webcam'),
      videoWrap: document.getElementById('video-wrap'),
      placeholder: document.getElementById('placeholder'),
      btnStart: document.getElementById('btnStart'),
      btnStop: document.getElementById('btnStop'),
      selCam: document.getElementById('selCam'),
      btnSwitchCam: document.getElementById('btnSwitchCam'),
      inpLabel: document.getElementById('inpLabel'),
      btnAddClass: document.getElementById('btnAddClass'),
      btnClearData: document.getElementById('btnClearData'),
      classList: document.getElementById('classList'),
      btnTrain: document.getElementById('btnTrain'),
      btnPredict: document.getElementById('btnPredict'),
      btnStopPredict: document.getElementById('btnStopPredict'),
      predictions: document.getElementById('predictions'),
      bigResult: document.getElementById('bigResult'),
      bigResultLabel: document.getElementById('bigResultLabel'),
      bigResultConf: document.getElementById('bigResultConf'),
      status: document.getElementById('status'),
      fps: document.getElementById('fps'),
      infer: document.getElementById('infer'),
      samples: document.getElementById('samples'),
      classCount: document.getElementById('classCount'),
      btnSave: document.getElementById('btnSave'),
      btnLoad: document.getElementById('btnLoad'),
      fileLoad: document.getElementById('fileLoad'),
      th: document.getElementById('th'),
      thVal: document.getElementById('thVal'),
      btnPreflight: document.getElementById('btnPreflight'),
      pSecure: document.getElementById('pSecure'),
      pMedia: document.getElementById('pMedia'),
      pPerm: document.getElementById('pPerm'),
      pDevs: document.getElementById('pDevs'),
      imgInput: document.getElementById('imgInput'),
      btnAddFromImg: document.getElementById('btnAddFromImg'),
      camStatusBadge: document.getElementById('cam-status-badge'),
      // New Elements for Sticky Video
      miniCamContainer: document.getElementById('mini-cam-container'),
      miniVideo: document.getElementById('mini-video'),
    };

    // --- æ ¸å¿ƒç‰©ä»¶èˆ‡ç‹€æ…‹ç®¡ç† ---
    let net;
    let classifier;
    let stream;
    let predictLoop;
    let lastPredTime = 0;

    const state = {
      classes: [],
      counts: {},
      collecting: null,
      activeCamId: null,      // ç‰¹å®šé¸æ“‡çš„ Device ID
      facingMode: 'user',   // é è¨­å‰é¡é ­ ('user' æˆ– 'environment')
      threshold: 0.7,
      isPredicting: false,
      currentAddIndex: null,
    };

    const PREDICTION_COLORS = ['bg-[#FFCB05]', 'bg-emerald-500', 'bg-rose-500', 'bg-sky-500', 'bg-violet-500', 'bg-orange-500', 'bg-lime-500'];
    const PREDICTION_THROTTLE_MS = 100;

    // --- æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ---

    async function init() {
      classifier = knnClassifier.create();
      // å˜—è©¦åˆ—å‡ºè£ç½®ï¼Œä½†é€™åœ¨ iOS Safari æœªæˆæ¬Šå‰å¯èƒ½åªæœƒå›å‚³ç©ºæ¨™ç±¤æˆ–ä¸å®Œæ•´åˆ—è¡¨
      if (navigator.mediaDevices?.enumerateDevices) {
        await listCams(false);
      }
      if (location.protocol === 'file:') {
        setStatus('æ‚¨æ­£é€é file:// é–‹å•Ÿé é¢ï¼Œç€è¦½å™¨å¯èƒ½æœƒå°é–ç›¸æ©Ÿæ¬Šé™ã€‚', 'warn');
      }
      initStickyVideo();
    }

    // åˆå§‹åŒ–æ‡¸æµ®è¦–çª—é‚è¼¯
    function initStickyVideo() {
      if (!window.IntersectionObserver) return;

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          // å¦‚æœä¸»ç•«é¢ä¸åœ¨è¦–çª—å…§ (isIntersecting = false) ä¸”ç›¸æ©Ÿå·²å•Ÿå‹•
          if (!entry.isIntersecting && stream && !els.video.classList.contains('hidden')) {
            els.miniCamContainer.classList.remove('hidden');
            // ç¢ºä¿ miniVideo ä¹Ÿæœ‰ç•«é¢
            if (els.miniVideo.srcObject !== els.video.srcObject) {
               els.miniVideo.srcObject = els.video.srcObject;
            }
          } else {
            els.miniCamContainer.classList.add('hidden');
          }
        });
      }, { threshold: 0.1 }); // ç•¶ä¸»ç•«é¢å‰©ä¸‹ä¸åˆ° 10% å¯è¦‹æ™‚è§¸ç™¼

      observer.observe(els.videoWrap);
    }

    // åˆ—å‡ºæ”å½±æ©Ÿï¼šupdateSelect ç”¨æ–¼æ˜¯å¦è¦å¼·åˆ¶æ›´æ–°é¸å–® (é¿å…ä½¿ç”¨è€…é¸æ“‡ä¸€åŠè¢«é‡ç½®)
    async function listCams(updateSelect = true) {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        
        if (updateSelect) {
            els.selCam.innerHTML = '';
            if (videoDevices.length === 0) {
            els.selCam.innerHTML = '<option value="">æ‰¾ä¸åˆ°æ”å½±æ©Ÿ</option>';
            } else {
            // æ·»åŠ  "è‡ªå‹•/é è¨­" é¸é …
            const defaultOpt = document.createElement('option');
            defaultOpt.value = "";
            defaultOpt.text = "è‡ªå‹• / ä¾åˆ‡æ›æŒ‰éˆ•";
            els.selCam.appendChild(defaultOpt);

            videoDevices.forEach((d, i) => {
                const option = document.createElement('option');
                option.value = d.deviceId;
                // iOS å¸¸å¸¸å›å‚³ç©º labelï¼Œè‹¥ç‚ºç©ºçµ¦ä¸€å€‹é è¨­åç¨±
                option.text = d.label || `æ”å½±æ©Ÿ ${i + 1} (${d.deviceId.slice(0, 5)}...)`;
                els.selCam.appendChild(option);
            });
            
            // å¦‚æœç•¶å‰æœ‰æŒ‡å®š IDï¼Œå˜—è©¦é¸ä¸­å®ƒ
            if (state.activeCamId) {
                els.selCam.value = state.activeCamId;
            }
            }
        }
        
        if (els.pDevs) els.pDevs.textContent = String(videoDevices.length);
      } catch (err) {
        console.error("ç„¡æ³•åˆ—å‡ºæ”å½±æ©Ÿ:", err);
      }
    }

    async function openCam() {
      try {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }

        setStatus('æ­£åœ¨å•Ÿå‹•æ”å½±æ©Ÿ...', 'info');

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('BrowserAPIUnavailable');
        }

        // å»ºæ§‹ç´„æŸæ¢ä»¶
        let constraints = {
          audio: false,
          video: {
            // æ”¾å¯¬é™åˆ¶ï¼Œé¿å…æŸäº›èˆŠæ‰‹æ©Ÿå› ç‚ºè§£æåº¦ä¸ç¬¦è€Œå ±éŒ¯
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };

        // å„ªå…ˆé †åºï¼š
        // 1. å¦‚æœä½¿ç”¨è€…åœ¨ä¸‹æ‹‰é¸å–®æ˜ç¢ºé¸äº†æŸå€‹ Device ID -> ç”¨ deviceId
        // 2. å¦å‰‡ -> ç”¨ facingMode (åˆ‡æ›æŒ‰éˆ•æ§åˆ¶)
        if (state.activeCamId) {
             constraints.video.deviceId = { exact: state.activeCamId };
        } else {
             constraints.video.facingMode = state.facingMode;
        }

        try {
          stream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (err) {
          console.warn('æŒ‡å®šæ¢ä»¶å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨å¯¬é¬†æ¢ä»¶é‡è©¦...', err);
          // é™ç´šé‡è©¦ï¼šæ‹¿æ‰ç‰¹å®š IDï¼Œåªå˜—è©¦ facingMode
          if (state.activeCamId) {
              delete constraints.video.deviceId;
              constraints.video.facingMode = state.facingMode;
              stream = await navigator.mediaDevices.getUserMedia(constraints);
          } else {
              // å†å¤±æ•—ï¼Œé€£ facingMode éƒ½æ‹¿æ‰ï¼Œåªæ±‚æœ‰ç•«é¢
              delete constraints.video.facingMode;
              stream = await navigator.mediaDevices.getUserMedia({ video: true });
          }
        }

        els.video.srcObject = stream;
        els.miniVideo.srcObject = stream; // åŒæ­¥è¨­å®š Mini Cam
        
        // é¡åƒè™•ç†ï¼šå¦‚æœæ˜¯å‰é¡é ­ ('user')ï¼Œé€šå¸¸éœ€è¦æ°´å¹³ç¿»è½‰ï¼›å¾Œé¡é ­å‰‡ä¸éœ€è¦
        // é€é CSS class æ§åˆ¶
        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();
        // å¦‚æœå¯¦éš›æ‹¿åˆ°çš„ facingMode æ˜¯ environmentï¼Œæˆ–è€…æˆ‘å€‘ä¸»å‹•è¦æ±‚ environmentï¼Œå°±å–æ¶ˆé¡åƒ
        const isBack = settings.facingMode === 'environment' || state.facingMode === 'environment';
        
        if (isBack) {
            els.video.classList.remove('scale-x-[-1]'); // å¾Œé¡é ­ï¼šæ­£å¸¸é¡¯ç¤º
            els.miniVideo.classList.remove('scale-x-[-1]');
        } else {
            els.video.classList.add('scale-x-[-1]');    // å‰é¡é ­ï¼šé¡åƒé¡¯ç¤º (å¦‚åŒç…§é¡å­)
            els.miniVideo.classList.add('scale-x-[-1]');
        }

        await els.video.play();
        // try to play mini video as well (though typically works auto)
        els.miniVideo.play().catch(e => console.log('Mini video play auto-handled or pending'));

        // é—œéµä¿®æ­£ï¼šæˆåŠŸå–å¾—ä¸²æµå¾Œï¼Œ"å†æ¬¡" åˆ—å‡ºæ”å½±æ©Ÿ
        // é€™æ˜¯è§£æ±º iOS ç¬¬ä¸€æ¬¡é–‹å•Ÿåªé¡¯ç¤ºä¸€å€‹é¡é ­çš„é—œéµ
        await listCams(true); 

        els.video.classList.remove('hidden');
        els.placeholder.classList.add('hidden');
        els.camStatusBadge.classList.remove('hidden');
        updateUIOnCamState(true);

        setStatus('æ”å½±æ©Ÿå·²å•Ÿå‹•ï¼Œæ­£åœ¨è¼‰å…¥ AI æ¨¡å‹...', 'info');

        if (!net) {
          net = await mobilenet.load({ version: 2, alpha: 1.0 });
        }

        setStatus('æ¨¡å‹è¼‰å…¥å®Œæˆï¼æ‚¨å¯ä»¥é–‹å§‹è’é›†æ¨£æœ¬ã€‚', 'ok');

      } catch (e) {
        console.error(e);
        let errorMsg = 'ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿã€‚';
        if (e.name === 'NotAllowedError' || e.name === 'SecurityError') {
          errorMsg = 'æ¬Šé™è¢«æ‹’çµ•ã€‚è«‹é‡æ–°æ•´ç†ç¶²é ä¸¦å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚';
        } else if (e.name === 'NotFoundError') {
          errorMsg = 'æ‰¾ä¸åˆ°æŒ‡å®šçš„æ”å½±æ©Ÿè£ç½®ã€‚';
        } else {
          errorMsg = `ç›¸æ©ŸéŒ¯èª¤: ${e.name}`;
        }
        setStatus(errorMsg, 'bad');
        updateUIOnCamState(false);
      }
    }

    function stopCam() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      if (state.isPredicting) {
        stopPredict();
      }
      els.video.srcObject = null;
      els.miniVideo.srcObject = null;
      els.video.classList.add('hidden');
      els.miniCamContainer.classList.add('hidden'); // Force hide mini cam
      els.placeholder.classList.remove('hidden');
      els.camStatusBadge.classList.add('hidden');
      updateUIOnCamState(false);
      setStatus('æ”å½±æ©Ÿå·²åœæ­¢ã€‚', 'info');
    }

    function switchCamera() {
        // åˆ‡æ›æ¨¡å¼
        state.facingMode = (state.facingMode === 'user') ? 'environment' : 'user';
        
        // æ¸…é™¤ç‰¹å®šçš„ ID é¸æ“‡ï¼Œæ”¹ç”¨æ¨¡å¼å„ªå…ˆ
        state.activeCamId = null;
        els.selCam.value = ""; 
        
        // å¦‚æœç›¸æ©Ÿæ­£åœ¨é‹ä½œï¼Œé‡æ–°å•Ÿå‹•ä»¥æ‡‰ç”¨è®Šæ›´
        if (stream) {
            openCam();
        }
        
        setStatus(`åˆ‡æ›è‡³${state.facingMode === 'user' ? 'å‰' : 'å¾Œ'}é¡é ­æ¨¡å¼...`, 'info');
    }

    function addClass(name) {
      name = name.trim();
      if (!name || state.classes.includes(name)) {
        setStatus(state.classes.includes(name) ? 'é¡åˆ¥åç¨±å·²å­˜åœ¨ï¼' : 'é¡åˆ¥åç¨±ä¸å¯ç‚ºç©ºï¼', 'warn');
        return;
      }
      state.classes.push(name);
      state.counts[name] = 0;
      renderClassList();
      updateTrainButtonState();
      setStatus(`å·²æ–°å¢é¡åˆ¥ï¼šã€Œ${name}ã€`, 'ok');
    }

    async function addExample(index, imgElement) {
      if (!net || !classifier) return;
      const className = state.classes[index];
      if (!className) return;

      tf.tidy(() => {
        const source = imgElement || els.video;
        // å¦‚æœæ˜¯å½±ç‰‡å…ƒç´ ä¸”ä¸å¯è¦‹ (æœªå•Ÿå‹•)ï¼Œä¸é€²è¡Œè™•ç†
        if (source === els.video && els.video.classList.contains('hidden')) return;
        
        const img = tf.browser.fromPixels(source);
        const activation = net.infer(img, 'conv_preds');
        classifier.addExample(activation, className);
      });

      state.counts[className]++;
      
      // å„ªåŒ–ï¼šä½¿ç”¨ updateClassItem æ›¿ä»£ renderClassListï¼Œé¿å…æŒ‰éˆ•é‡ç¹ªå°è‡´é•·æŒ‰ä¸­æ–·
      updateClassItem(index);
      updateTrainButtonState();

      // UI Flash Effect
      els.videoWrap.classList.add('video-flash');
      els.miniCamContainer.classList.add('video-flash'); // Flash mini cam too
      setTimeout(() => {
          els.videoWrap.classList.remove('video-flash');
          els.miniCamContainer.classList.remove('video-flash');
      }, 500);
    }

    function prepareForPrediction() {
      const classesWithSamples = Object.values(state.counts).filter(count => count > 0).length;
      if (classesWithSamples >= 2) {
        setStatus('æ¨¡å‹å·²æº–å‚™å°±ç·’ï¼Œå¯ä»¥é–‹å§‹è¾¨è­˜äº†ã€‚', 'ok');
        els.btnPredict.disabled = false;
      } else {
        setStatus('è«‹è‡³å°‘ç‚ºã€Œå…©å€‹ä¸åŒã€çš„é¡åˆ¥è’é›†æ¨£æœ¬ã€‚', 'warn');
        els.btnPredict.disabled = true;
      }
    }

    function startPredict() {
      if (!classifier || state.classes.length < 1 || state.isPredicting) return;
      state.isPredicting = true;
      updateUIPredictState(true);
      lastPredTime = 0;
      predictLoop = requestAnimationFrame(loop);
    }

    function stopPredict() {
      state.isPredicting = false;
      cancelAnimationFrame(predictLoop);
      updateUIPredictState(false);
    }

    function loop(time) {
      if (!state.isPredicting) return;
      predictLoop = requestAnimationFrame(loop);
      const elapsed = time - lastPredTime;
      if (elapsed > PREDICTION_THROTTLE_MS) {
        lastPredTime = time;
        const fps = 1000 / elapsed;
        els.fps.textContent = fps.toFixed(0);
        state.collecting = null;
        predictOnce();
      }
    }

    async function predictOnce(imgElement) {
      if (!net) return;
      const t0 = performance.now();
      const k = Math.min(3, state.classes.length);
      if (k === 0) return;

      const source = imgElement || els.video;
      // Safety check
      if (source === els.video && (!stream || els.video.classList.contains('hidden'))) return;

      try {
        const result = await tf.tidy(() => {
            const img = tf.browser.fromPixels(source);
            const activation = net.infer(img, 'conv_preds');
            return classifier.predictClass(activation, k);
        });
        els.infer.textContent = (performance.now() - t0).toFixed(1);
        renderPredictions(result);
      } catch (err) {
        console.error("Prediction error:", err);
      }
    }

    // --- UI æ›´æ–°èˆ‡æ¸²æŸ“å‡½å¼ ---

    function updateUIOnCamState(isCamOn) {
      els.btnStart.disabled = isCamOn;
      els.btnStop.disabled = !isCamOn;
      els.btnAddClass.disabled = !isCamOn;
      els.btnClearData.disabled = !isCamOn;
      els.btnAddFromImg.disabled = !isCamOn;
    }

    function updateUIPredictState(isPredicting) {
      els.btnPredict.disabled = isPredicting;
      els.btnStopPredict.disabled = !isPredicting;
      els.btnTrain.disabled = isPredicting;
    }

    function updateTrainButtonState() {
      const total = totalSamples();
      const classCount = Object.values(state.counts).filter(c => c > 0).length;
      els.btnTrain.disabled = !(total > 0 && classCount >= 2);
    }

    function renderClassList() {
      els.classList.innerHTML = '';
      state.classes.forEach((name, index) => {
        const count = state.counts[name] || 0;
        const item = document.createElement('div');
        item.className = `bg-white/5 border border-white/10 p-3 rounded-xl flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 transition-all hover:bg-white/10 ${state.currentAddIndex === index ? 'ring-2 ring-[#FFCB05] bg-[#FFCB05]/10' : ''}`;

        item.innerHTML = `
          <div class="flex-grow font-bold text-slate-200 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full ${state.counts[name] > 0 ? 'bg-[#FFCB05]' : 'bg-slate-500'}"></span>
            ${name}
          </div>
          <div class="flex items-center gap-2 flex-wrap">
            <span class="count-badge font-mono font-semibold text-xs bg-black/30 text-slate-300 py-1 px-2 rounded-lg">${count} æ¨£æœ¬</span>
            
            <!-- åˆä½µå¾Œçš„å¤§æŒ‰éˆ• -->
            <button data-act="hold" data-i="${index}" class="select-none touch-none text-sm bg-[#FFCB05] text-[#00274C] font-bold py-2.5 px-6 rounded-xl shadow-lg shadow-[#FFCB05]/20 hover:bg-[#ffe066] hover:shadow-[#FFCB05]/40 active:scale-95 transition-all flex items-center gap-2">
               <span>ğŸ“·</span>
               <span>è’é›†</span>
            </button>
            
            <button data-act="setcur" data-i="${index}" class="w-8 h-8 flex items-center justify-center text-xs bg-slate-700 text-slate-300 font-semibold rounded-lg hover:bg-slate-600 transition-colors" title="è¨­ç‚ºä¸Šå‚³ç›®æ¨™">ğŸ“Œ</button>
            <button data-act="del" data-i="${index}" class="w-8 h-8 flex items-center justify-center text-xs bg-rose-500/20 text-rose-300 border border-rose-500/30 font-semibold rounded-lg hover:bg-rose-500/30 transition-colors">âœ•</button>
          </div>
        `;
        els.classList.appendChild(item);
      });
      els.samples.textContent = totalSamples();
      els.classCount.textContent = state.classes.length;
    }
    
    // æ–°å¢ï¼šåªæ›´æ–°å–®ä¸€é¡åˆ¥çš„é¡¯ç¤ºï¼Œé¿å…é‡ç¹ªæ•´å€‹åˆ—è¡¨å°è‡´é•·æŒ‰ä¸­æ–·
    function updateClassItem(index) {
        const row = els.classList.children[index];
        if (!row) return renderClassList(); // å¦‚æœæ‰¾ä¸åˆ°å°æ‡‰çš„ DOMï¼Œå‰‡å›é€€åˆ°å®Œæ•´é‡ç¹ª
        
        const className = state.classes[index];
        const count = state.counts[className];
        
        // åªæ›´æ–°è¨ˆæ•¸ Badge
        const badge = row.querySelector('.count-badge');
        if (badge) badge.textContent = `${count} æ¨£æœ¬`;
        
        // æ›´æ–°å…¨åŸŸè¨ˆæ•¸
        els.samples.textContent = totalSamples();
        els.classCount.textContent = state.classes.length;
    }

    function renderPredictions(result) {
      if (!result) return;
      const topLabel = result.label;
      const topConfidence = result.confidences[topLabel] || 0;
      const isConfident = topConfidence >= state.threshold;

      let bgColor = 'bg-slate-800/80 border-slate-700'; 
      let statusType = 'info';
      let statusMsg = `è¾¨è­˜çµæœ: ${topLabel}`;
      let labelColor = 'text-white';

      if (topLabel) {
        if (isConfident) {
          statusType = 'ok';
          if (topLabel.toLowerCase().includes('good') || topLabel.toLowerCase().includes('ok')) {
            bgColor = 'bg-emerald-900/80 border-emerald-500/50 shadow-[0_0_30px_rgba(16,185,129,0.3)]';
            labelColor = 'text-emerald-400';
          } else if (topLabel.toLowerCase().includes('bad') || topLabel.toLowerCase().includes('ng')) {
            bgColor = 'bg-rose-900/80 border-rose-500/50 shadow-[0_0_30px_rgba(244,63,94,0.3)]';
            labelColor = 'text-rose-400';
          } else {
            bgColor = 'bg-[#00274C]/90 border-[#FFCB05]/50 shadow-[0_0_30px_rgba(255,203,5,0.3)]';
            labelColor = 'text-[#FFCB05]';
          }
        } else {
          statusType = 'warn';
          bgColor = 'bg-amber-900/80 border-amber-500/50';
          labelColor = 'text-amber-400';
          statusMsg = `ä¿¡å¿ƒä¸è¶³: ${topLabel}`;
        }
      }

      els.bigResult.className = `p-6 rounded-xl border backdrop-blur-md transition-all duration-300 flex flex-col items-center justify-center min-h-[120px] ${bgColor}`;
      els.bigResultLabel.className = `text-4xl font-black tracking-wider mb-2 ${labelColor}`;
      els.bigResultLabel.textContent = topLabel || 'â€”';
      els.bigResultConf.textContent = topLabel ? `${(topConfidence * 100).toFixed(1)}%` : 'â€”';

      els.predictions.innerHTML = '';

      // æ”¹é€²ï¼šéæ­·æ‰€æœ‰å·²çŸ¥çš„é¡åˆ¥ï¼Œè€Œä¸æ˜¯åªéæ­· result.confidences (å› ç‚º KNN é è¨­åªå›å‚³å‰ K å€‹)
      // é€™æ¨£å¯ä»¥ç¢ºä¿æ‰€æœ‰é¡åˆ¥éƒ½æœƒé¡¯ç¤ºåœ¨é•·æ¢åœ–ä¸Šï¼Œå³ä½¿ä¿¡å¿ƒåº¦ç‚º 0
      const allClassConfidences = state.classes.map(className => {
          return [className, result.confidences[className] || 0];
      });

      // æ’åº
      const sortedClasses = allClassConfidences.sort(([, a], [, b]) => b - a);

      sortedClasses.forEach(([label, confidence]) => {
        const percentage = (confidence * 100).toFixed(1);
        const classIndex = state.classes.indexOf(label);
        const colorClass = PREDICTION_COLORS[classIndex % PREDICTION_COLORS.length];

        const item = document.createElement('div');
        item.className = 'flex items-center gap-3';
        item.innerHTML = `
                <div class="w-24 font-medium text-slate-300 truncate text-sm">${label}</div>
                <div class="flex-grow bg-slate-700/50 rounded-full h-2">
                    <div class="${colorClass} h-2 rounded-full shadow-[0_0_10px_currentColor] transition-all duration-300" style="width: ${percentage}%"></div>
                </div>
                <div class="w-12 text-right font-mono font-bold text-slate-200 text-sm">${percentage}%</div>
            `;
        els.predictions.appendChild(item);
      });
    }

    function setStatus(msg, type) {
      const icons = {
        ok: 'âœ…',
        warn: 'âš ï¸',
        bad: 'âŒ',
        info: 'â„¹ï¸',
      };
      const icon = icons[type] || 'ğŸ‘‹';
      
      els.status.innerHTML = `<span class="shrink-0 text-xl">${icon}</span><span>${msg}</span>`;
      
      const typeClasses = {
        ok: 'bg-emerald-500/10 text-emerald-200 border-emerald-500/20',
        warn: 'bg-amber-500/10 text-amber-200 border-amber-500/20',
        bad: 'bg-rose-500/10 text-rose-200 border-rose-500/20',
        info: 'bg-[#FFCB05]/10 text-[#FFCB05] border-[#FFCB05]/20',
      };
      
      const defaultClass = 'bg-white/5 text-slate-300 border-white/10';
      
      els.status.className = `p-4 rounded-2xl font-medium border transition-all flex items-center gap-3 shadow-inner ${typeClasses[type] || defaultClass}`;
    }

    // --- äº‹ä»¶è™•ç†å¸¸å¼ ---

    function handleClassListClick(e) {
      const button = e.target.closest('button[data-act]');
      if (!button) return;

      const action = button.dataset.act;
      const index = +button.dataset.i;

      switch (action) {
        // 'one' case removed
        case 'setcur':
          state.currentAddIndex = state.currentAddIndex === index ? null : index;
          renderClassList();
          break;
        case 'del':
          if (confirm(`ç¢ºå®šè¦åˆªé™¤é¡åˆ¥ã€Œ${state.classes[index]}ã€å—ï¼Ÿ`)) {
            const className = state.classes[index];
            const classifierDataset = classifier.getClassifierDataset();
            if (classifierDataset && classifierDataset[className]) {
              classifier.clearClass(className);
            }
            state.classes.splice(index, 1);
            delete state.counts[className];
            renderClassList();
            updateTrainButtonState();
          }
          break;
      }
    }

    function handlePointerDown(e) {
      const button = e.target.closest('button[data-act="hold"]');
      if (!button) return;
      e.preventDefault(); // é˜²æ­¢æ–‡å­—é¸å–èˆ‡å³éµé¸å–®
      const index = +button.dataset.i;

      // 1. ç«‹å³åŸ·è¡Œä¸€æ¬¡ (è™•ç†å–®æ¬¡é»æ“Š)
      addExample(index);

      // 2. è¨­å®šé€£æ‹è¿´åœˆ (è™•ç†é•·æŒ‰)
      const loop = () => {
        if (!state.collecting) return; // å¦‚æœè¢« pointerup æ¸…é™¤äº†ï¼Œå°±åœæ­¢
        addExample(index);
        state.collecting = setTimeout(loop, 100); // é€£æ‹é€Ÿåº¦: 100ms
      };

      // 3. å»¶é²å•Ÿå‹•é€£æ‹ (é¿å…ä¸€èˆ¬é»æ“Šèª¤è§¸é€£æ‹)
      state.collecting = setTimeout(loop, 600); // é•·æŒ‰ 600ms å¾Œé–‹å§‹é€£æ‹
    }

    function handlePointerUp() {
      if (state.collecting) {
        clearTimeout(state.collecting);
        state.collecting = null;
      }
    }

    // --- è¼”åŠ©èˆ‡å·¥å…·å‡½å¼ ---
    function totalSamples() { return Object.values(state.counts).reduce((a, b) => a + b, 0); }
    function isSecureContext() { return window.isSecureContext; }

    function download(filename, text) {
      const element = document.createElement('a');
      element.setAttribute('href', 'data:application/json;charset=utf-8,' + encodeURIComponent(text));
      element.setAttribute('download', filename);
      element.style.display = 'none';
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
    }

    function saveDataset() {
      if (totalSamples() === 0) {
        setStatus('æ²’æœ‰æ¨£æœ¬å¯ä»¥å„²å­˜ã€‚', 'warn');
        return;
      }
      const dataset = classifier.getClassifierDataset();
      const serializableDataset = {};
      Object.keys(dataset).forEach(key => {
        const data = dataset[key].dataSync();
        serializableDataset[key] = { data: Array.from(data), shape: dataset[key].shape };
      });
      const output = {
        meta: { classes: state.classes, counts: state.counts, created: new Date().toISOString() },
        data: serializableDataset
      };
      download(`tm-dataset-${new Date().getTime()}.json`, JSON.stringify(output));
    }

    async function loadDataset(file) {
      try {
        const text = await file.text();
        const obj = JSON.parse(text);

        if (!obj.meta || !obj.data) throw new Error('æª”æ¡ˆæ ¼å¼ä¸ç¬¦ã€‚');

        classifier.clearAllClasses();

        const dataset = {};
        Object.keys(obj.data).forEach(key => {
          const d = obj.data[key];
          dataset[key] = tf.tensor(d.data, d.shape, 'float32');
        });

        classifier.setClassifierDataset(dataset);
        state.classes = obj.meta.classes || [];
        state.counts = obj.meta.counts || {};

        renderClassList();
        updateTrainButtonState();
        prepareForPrediction();
        setStatus('è³‡æ–™é›†è¼‰å…¥æˆåŠŸã€‚', 'ok');
      } catch (e) {
        setStatus('è¼‰å…¥å¤±æ•—: ' + e.message, 'bad');
      }
    }

    async function handleImageUpload(e) {
      const files = Array.from(e.target.files || []);
      if (files.length === 0) return;

      if (state.classes.length === 0) {
        setStatus('è«‹å…ˆå»ºç«‹è‡³å°‘ä¸€å€‹é¡åˆ¥ï¼Œæ‰èƒ½æ–°å¢åœ–ç‰‡æ¨£æœ¬ã€‚', 'warn');
        e.target.value = '';
        return;
      }

      const targetIndex = state.currentAddIndex ?? (state.classes.length - 1);
      const targetClassName = state.classes[targetIndex];

      if (!net) {
        setStatus('æ­£åœ¨è¼‰å…¥æ¨¡å‹...', 'info');
        net = await mobilenet.load({ version: 2, alpha: 1.0 });
      }

      setStatus(`æ­£åœ¨ç‚ºã€Œ${targetClassName}ã€è™•ç†ä¸Šå‚³çš„åœ–ç‰‡...`, 'info');

      for (const file of files) {
        const img = await fileToImage(file);
        await addExample(targetIndex, img);
      }

      setStatus(`å·²æˆåŠŸç‚ºã€Œ${targetClassName}ã€æ–°å¢ ${files.length} å¼µåœ–ç‰‡æ¨£æœ¬ã€‚`, 'ok');
      e.target.value = '';
    }

    function fileToImage(file) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.src = URL.createObjectURL(file);
      });
    }

    async function preflightCheck() {
      els.pSecure.textContent = isSecureContext() ? 'æ˜¯' : 'å¦';
      els.pMedia.textContent = navigator.mediaDevices ? 'å¯ç”¨' : 'ä¸å¯ç”¨';
      try {
        const perm = await navigator.permissions.query({ name: 'camera' });
        els.pPerm.textContent = perm.state;
      } catch {
        els.pPerm.textContent = 'æœªçŸ¥';
      }
      await listCams(true);
    }

    // --- äº‹ä»¶ç›£è½å™¨ç¶å®š ---
    els.btnStart.addEventListener('click', openCam);
    els.btnStop.addEventListener('click', stopCam);
    
    els.selCam.addEventListener('change', (e) => {
      state.activeCamId = e.target.value;
      if (stream) openCam();
    });
    
    els.btnSwitchCam.addEventListener('click', switchCamera);

    els.btnAddClass.addEventListener('click', () => {
      addClass(els.inpLabel.value);
      els.inpLabel.value = '';
    });
    els.inpLabel.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        addClass(els.inpLabel.value);
        els.inpLabel.value = '';
      }
    });

    els.classList.addEventListener('click', handleClassListClick);
    els.classList.addEventListener('pointerdown', handlePointerDown);
    document.body.addEventListener('pointerup', handlePointerUp);
    document.body.addEventListener('pointerleave', handlePointerUp);

    els.btnClearData.addEventListener('click', () => {
      if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰é¡åˆ¥èˆ‡æ¨£æœ¬å—ï¼Ÿ')) {
        classifier.clearAllClasses();
        state.classes = [];
        state.counts = {};
        renderClassList();
        updateTrainButtonState();
        els.btnPredict.disabled = true;
        setStatus('æ‰€æœ‰è³‡æ–™å·²æ¸…ç©ºã€‚', 'ok');
      }
    });

    els.btnTrain.addEventListener('click', prepareForPrediction);
    els.btnPredict.addEventListener('click', startPredict);
    els.btnStopPredict.addEventListener('click', stopPredict);

    els.th.addEventListener('input', (e) => {
      state.threshold = e.target.value / 100;
      els.thVal.textContent = `${e.target.value}%`;
    });

    els.btnSave.addEventListener('click', saveDataset);
    els.btnLoad.addEventListener('click', () => els.fileLoad.click());
    els.fileLoad.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) loadDataset(file);
    });

    els.btnAddFromImg.addEventListener('click', () => {
      els.imgInput.click();
    });
    els.imgInput.addEventListener('change', handleImageUpload);

    els.btnPreflight.addEventListener('click', preflightCheck);

    // --- æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• ---
    document.addEventListener('DOMContentLoaded', init);

  </script>
</body>

</html>